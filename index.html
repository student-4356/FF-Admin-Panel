<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MINI ESPORT - Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
:root{--primary:#00ff9c;--primary-dark:#00cc7a;--primary-glow:rgba(0,255,156,.3);--danger:#ff003c;--danger-glow:rgba(255,0,60,.3);--warning:#ffaa00;--info:#00aaff;--purple:#aa55ff;--cyan:#00eeff;--bg-dark:#0a0a0a;--bg-card:#111;--bg-card2:#161616;--bg-input:#0a0a0a;--border:#1e1e1e;--border-light:#2a2a2a;--text:#fff;--text-dim:#aaa;--text-muted:#666;--sidebar-w:250px;--topbar-h:52px;--radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
html{-webkit-tap-highlight-color:transparent}
body{font-family:'Rajdhani',sans-serif;background:var(--bg-dark);color:var(--text);font-size:14px;overflow-x:hidden;-webkit-font-smoothing:antialiased}
h1,h2,h3,h4,h5,h6,.section-title,.login-title,.sidebar-brand,.stat-card h3,.topbar-title{font-family:'Orbitron',sans-serif}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--primary-dark);border-radius:3px}

/* LOGIN */
.login-screen{position:fixed;inset:0;background:var(--bg-dark);display:flex;align-items:center;justify-content:center;z-index:9999;background-image:radial-gradient(circle at 20% 80%,rgba(0,255,156,.05) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(0,170,255,.05) 0%,transparent 50%)}
.login-card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:40px 36px;width:380px;max-width:92vw;text-align:center;box-shadow:0 0 80px rgba(0,255,156,.06)}
.login-icon{font-size:48px;color:var(--primary);margin-bottom:14px;text-shadow:0 0 40px var(--primary-glow);animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.login-title{font-size:22px;color:var(--primary);margin-bottom:4px;letter-spacing:3px}
.login-subtitle{color:var(--text-muted);font-size:12px;margin-bottom:24px;letter-spacing:1px}
.login-error{background:rgba(255,0,60,.08);border:1px solid rgba(255,0,60,.25);color:var(--danger);padding:10px 14px;border-radius:10px;margin-bottom:14px;font-size:12px;display:none;text-align:left}
.login-error.show{display:flex;align-items:center;gap:8px}

/* LOADING */
.loading-screen{position:fixed;inset:0;background:var(--bg-dark);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9998}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:14px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-screen p{color:var(--primary);font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:4px}

/* APP */
.app-container{opacity:0;transform:translateY(8px);transition:all .4s ease}
.app-container.show{opacity:1;transform:translateY(0)}

/* SIDEBAR */
.sidebar{position:fixed;left:0;top:0;bottom:0;width:var(--sidebar-w);background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;transition:transform .3s cubic-bezier(.4,0,.2,1)}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.sidebar-logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));display:flex;align-items:center;justify-content:center;color:#000;font-size:16px;flex-shrink:0}
.sidebar-brand-group{overflow:hidden;white-space:nowrap}
.sidebar-brand{font-size:13px;color:var(--primary);letter-spacing:2px}
.sidebar-brand-sub{font-size:9px;color:var(--text-muted);letter-spacing:1px;margin-top:1px}
.sidebar-nav{flex:1;overflow-y:auto;padding:6px 0}
.nav-section-label{padding:10px 16px 4px;font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;font-weight:700}
.nav-item{display:flex;align-items:center;padding:9px 16px;color:var(--text-dim);cursor:pointer;transition:all .15s;border-left:3px solid transparent;gap:10px;font-size:13px;font-weight:500;position:relative;margin:1px 0}
.nav-item:hover{background:rgba(0,255,156,.04);color:var(--text)}
.nav-item.active{border-left-color:var(--primary);color:var(--primary);background:rgba(0,255,156,.07)}
.nav-item i{width:18px;text-align:center;font-size:13px;flex-shrink:0}
.nav-item span.nav-label{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.nav-badge{position:absolute;right:12px;min-width:18px;height:18px;border-radius:9px;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 5px}
.nav-badge.orange{background:rgba(255,170,0,.15);color:var(--warning)}
.nav-badge.purple{background:rgba(170,85,255,.15);color:var(--purple)}
.nav-badge.green{background:rgba(0,255,156,.15);color:var(--primary)}
.nav-badge.cyan{background:rgba(0,238,255,.15);color:var(--cyan)}
.nav-badge.red{background:rgba(255,0,60,.15);color:var(--danger)}
.nav-divider{height:1px;background:var(--border);margin:6px 14px}
.sidebar-footer{padding:12px 14px;border-top:1px solid var(--border)}
.admin-info{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.admin-avatar{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,var(--primary-dark),var(--primary));display:flex;align-items:center;justify-content:center;color:#000;font-size:12px;font-weight:700;flex-shrink:0}
.admin-details{overflow:hidden}
.admin-name{font-size:11px;font-weight:600;color:var(--text);display:flex;align-items:center;gap:5px}
.online-dot{width:6px;height:6px;background:var(--primary);border-radius:50%;animation:pulse 2s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.admin-email-text{font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sidebar-footer .logout-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:6px;padding:7px;border-radius:8px;background:rgba(255,0,60,.08);border:1px solid rgba(255,0,60,.15);color:var(--danger);font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s}
.sidebar-footer .logout-btn:hover{background:rgba(255,0,60,.15)}

/* Red Pulse for Support */
.support-pulse{position:relative}
.support-pulse::after{content:'';position:absolute;top:8px;right:8px;width:8px;height:8px;background:var(--danger);border-radius:50%;display:none;animation:redPulse 1.2s infinite}
.support-pulse.has-unread::after{display:block}
@keyframes redPulse{0%{box-shadow:0 0 0 0 rgba(255,0,60,.6)}70%{box-shadow:0 0 0 6px rgba(255,0,60,0)}100%{box-shadow:0 0 0 0 rgba(255,0,60,0)}}

/* HAMBURGER */
.hamburger{display:none;position:fixed;top:8px;left:8px;z-index:200;background:var(--bg-card);border:1px solid var(--border);color:var(--primary);width:38px;height:38px;border-radius:10px;font-size:15px;cursor:pointer;align-items:center;justify-content:center}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:90;backdrop-filter:blur(2px)}

/* MAIN */
.main-content{margin-left:var(--sidebar-w);min-height:100vh;display:flex;flex-direction:column;transition:margin .3s}
.topbar{position:sticky;top:0;z-index:50;height:var(--topbar-h);padding:0 16px;display:flex;align-items:center;justify-content:space-between;background:rgba(10,10,10,.85);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);gap:10px}
.topbar-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.topbar-title{font-size:12px;color:var(--text);letter-spacing:1px;white-space:nowrap}
.topbar-actions{display:flex;align-items:center;gap:8px;flex-shrink:0}

/* GLOBAL SEARCH */
.global-search{position:relative;flex:1;max-width:280px}
.global-search input{width:100%;background:var(--bg-card);border:1px solid var(--border);color:var(--text);padding:7px 12px 7px 32px;border-radius:8px;font-family:inherit;font-size:12px;outline:none;transition:all .2s}
.global-search input:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(0,255,156,.1)}
.global-search input::placeholder{color:var(--text-muted)}
.global-search .search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:11px}
.global-search .search-results{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;max-height:320px;overflow-y:auto;display:none;box-shadow:0 12px 40px rgba(0,0,0,.5);z-index:60}
.global-search .search-results.show{display:block}
.search-result-item{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .1s;display:flex;align-items:center;gap:10px}
.search-result-item:last-child{border-bottom:none}
.search-result-item:hover{background:rgba(0,255,156,.05)}
.search-result-item .sr-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--primary-dark),var(--primary));display:flex;align-items:center;justify-content:center;color:#000;font-weight:700;font-size:12px;flex-shrink:0}
.search-result-item .sr-info{flex:1;min-width:0}
.search-result-item .sr-name{font-weight:600;font-size:13px}
.search-result-item .sr-uid{font-size:10px;color:var(--text-muted);font-family:monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.topbar .logout-btn{background:none;border:1px solid rgba(255,0,60,.2);color:var(--danger);padding:5px 12px;border-radius:8px;cursor:pointer;font-family:inherit;font-size:11px;font-weight:600;transition:all .2s;display:flex;align-items:center;gap:4px}
.topbar .logout-btn:hover{background:var(--danger);color:#fff}

.maint-banner{background:linear-gradient(90deg,rgba(255,170,0,.08),rgba(255,0,60,.08));border-bottom:1px solid rgba(255,170,0,.2);color:var(--warning);padding:6px 16px;font-size:11px;font-weight:600;display:none;align-items:center;gap:6px}
.maint-banner.show{display:flex}

/* SECTIONS */
.section{display:none;padding:16px;flex:1;animation:fadeIn .25s ease}
.section.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.section-title{font-size:15px;color:var(--text);display:flex;align-items:center;gap:8px}
.section-title .count{background:rgba(0,255,156,.12);color:var(--primary);font-size:10px;padding:2px 8px;border-radius:8px;font-family:'Rajdhani',sans-serif;font-weight:700}
.section-actions{display:flex;align-items:center;gap:6px;flex-wrap:wrap}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:18px}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;transition:all .2s;cursor:default;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;opacity:0;transition:opacity .2s;background:var(--primary)}
.stat-card:hover{border-color:rgba(0,255,156,.25);transform:translateY(-1px)}.stat-card:hover::before{opacity:1}
.stat-card .stat-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;margin-bottom:8px}
.stat-card .stat-icon.green{background:rgba(0,255,156,.1);color:var(--primary)}
.stat-card .stat-icon.blue{background:rgba(0,170,255,.1);color:var(--info)}
.stat-card .stat-icon.orange{background:rgba(255,170,0,.1);color:var(--warning)}
.stat-card .stat-icon.purple{background:rgba(170,85,255,.1);color:var(--purple)}
.stat-card .stat-icon.cyan{background:rgba(0,238,255,.1);color:var(--cyan)}
.stat-card .stat-icon.red{background:rgba(255,0,60,.1);color:var(--danger)}
.stat-card h3{font-size:9px;color:var(--text-muted);letter-spacing:1px;margin-bottom:4px;text-transform:uppercase}
.stat-card .value{font-size:22px;font-weight:700;color:var(--text);font-family:'Orbitron',sans-serif;line-height:1}
.stat-card .sub{font-size:10px;color:var(--text-muted);margin-top:3px}

/* CARDS */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:14px;overflow:hidden}
.card-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-weight:600;font-size:12px}
.card-header i{color:var(--primary);margin-right:6px}
.card-body{padding:14px}
.card-body.compact{padding:10px}

/* TABLE */
.table-wrapper{overflow-x:auto;overflow-y:auto;max-height:70vh;border-radius:6px;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:600px}
th{position:sticky;top:0;background:var(--bg-dark);color:var(--text-muted);padding:8px 10px;text-align:left;font-weight:600;font-size:9px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);z-index:1}
td{padding:8px 10px;border-bottom:1px solid var(--border);color:var(--text);vertical-align:middle}
tr:hover td{background:rgba(255,255,255,.015)}

/* IDENTITY TAG */
.id-tag{display:inline-flex;align-items:center;gap:5px;padding:3px 8px;border-radius:6px;background:var(--bg-dark);border:1px solid var(--border);font-size:11px;max-width:280px}
.id-tag .id-name{font-weight:700;color:var(--primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110px}
.id-tag .id-sep{color:var(--text-muted);font-size:9px}
.id-tag .id-uid{color:var(--text-dim);font-size:9px;font-family:monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px}

/* BADGES */
.badge{padding:2px 8px;border-radius:5px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;display:inline-flex;align-items:center;gap:3px}
.badge.green{background:rgba(0,255,156,.12);color:var(--primary)}
.badge.yellow{background:rgba(255,170,0,.12);color:var(--warning)}
.badge.red{background:rgba(255,0,60,.12);color:var(--danger)}
.badge.blue{background:rgba(0,170,255,.12);color:var(--info)}
.badge.purple{background:rgba(170,85,255,.12);color:var(--purple)}
.badge.gray{background:rgba(102,102,102,.12);color:var(--text-muted)}
.badge.cyan{background:rgba(0,238,255,.12);color:var(--cyan)}

/* SLOT BAR */
.slot-bar{display:flex;align-items:center;gap:6px;min-width:100px}
.slot-track{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden;min-width:40px}
.slot-fill{height:100%;border-radius:3px;transition:width .3s;background:var(--primary)}
.slot-fill.warn{background:var(--warning)}
.slot-fill.full{background:var(--danger)}
.slot-text{font-size:10px;font-weight:700;white-space:nowrap;color:var(--text-dim)}

/* FORMS */
.form-group{margin-bottom:12px}
.form-group label{display:block;color:var(--text-dim);font-size:11px;margin-bottom:4px;font-weight:600;letter-spacing:.3px}
.form-input{width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:8px;font-family:inherit;font-size:12px;transition:all .2s;outline:none}
.form-input:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(0,255,156,.1)}
.form-input::placeholder{color:var(--text-muted)}
select.form-input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
textarea.form-input{resize:vertical;min-height:70px}

/* BUTTONS */
.btn{padding:7px 14px;border-radius:8px;font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;border:none;transition:all .15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;-webkit-tap-highlight-color:transparent}
.btn:active{transform:scale(.97)}
.btn:disabled{opacity:.5;pointer-events:none}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#000}
.btn-primary:hover{box-shadow:0 4px 16px var(--primary-glow)}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{box-shadow:0 4px 16px var(--danger-glow)}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text-dim)}
.btn-ghost:hover{border-color:var(--primary);color:var(--primary)}
.btn-warning{background:var(--warning);color:#000}
.btn-info{background:var(--info);color:#000}
.btn-purple{background:var(--purple);color:#fff}
.btn-sm{padding:5px 10px;font-size:10px;border-radius:7px}
.btn-xs{padding:4px 7px;font-size:9px;border-radius:5px}
.btn.loading{pointer-events:none;opacity:.7;position:relative}
.btn.loading .btn-text{visibility:hidden}
.btn.loading::after{content:'';position:absolute;width:14px;height:14px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin .6s linear infinite;top:50%;left:50%;margin-top:-7px;margin-left:-7px}
.w-full{width:100%}

/* LAYOUT */
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.flex{display:flex}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-between{justify-content:space-between}.justify-center{justify-content:center}
.gap-1{gap:4px}.gap-2{gap:6px}.gap-3{gap:10px}
.text-primary{color:var(--primary)}.text-danger{color:var(--danger)}.text-dim{color:var(--text-dim)}.text-muted{color:var(--text-muted)}.text-warning{color:var(--warning)}.text-info{color:var(--info)}.text-cyan{color:var(--cyan)}
.text-sm{font-size:12px}.text-xs{font-size:10px}.text-xxs{font-size:9px}.font-bold{font-weight:700}.font-mono{font-family:monospace}
.mb-1{margin-bottom:4px}.mb-2{margin-bottom:6px}.mb-3{margin-bottom:10px}.mb-4{margin-bottom:14px}.mt-2{margin-top:6px}.mt-3{margin-top:10px}.mt-4{margin-top:14px}.hidden{display:none!important}

/* FILTER TABS */
.filter-tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px}
.filter-tab{padding:4px 12px;border-radius:16px;background:var(--bg-dark);border:1px solid var(--border);color:var(--text-muted);cursor:pointer;font-size:11px;font-weight:600;transition:all .15s;font-family:inherit}
.filter-tab.active,.filter-tab:hover{border-color:var(--primary);color:var(--primary);background:rgba(0,255,156,.06)}

/* FEED */
.feed-item{padding:10px;border-bottom:1px solid var(--border);font-size:12px;transition:background .15s}
.feed-item:last-child{border-bottom:none}
.feed-item:hover{background:rgba(255,255,255,.02)}
.feed-item .time{color:var(--text-muted);font-size:9px;margin-top:2px}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;display:none;align-items:center;justify-content:center;padding:12px;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;width:560px;max-width:95vw;max-height:88vh;overflow-y:auto;box-shadow:0 0 60px rgba(0,0,0,.5)}
.modal-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-family:'Orbitron',sans-serif;font-size:12px;color:var(--primary);display:flex;align-items:center;gap:6px}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer;padding:4px;border-radius:6px;transition:all .15s;width:28px;height:28px;display:flex;align-items:center;justify-content:center}
.modal-close:hover{color:var(--danger);background:rgba(255,0,60,.1)}
.modal-body{padding:16px}
.modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:6px}

/* TOGGLE */
.toggle{position:relative;width:40px;height:22px;display:inline-block}
.toggle input{display:none}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:11px;cursor:pointer;transition:all .3s}
.toggle-slider::before{content:'';position:absolute;width:16px;height:16px;background:#fff;border-radius:50%;top:3px;left:3px;transition:all .3s}
.toggle input:checked+.toggle-slider{background:var(--primary)}
.toggle input:checked+.toggle-slider::before{transform:translateX(18px)}

/* TOAST */
.toast-container{position:fixed;bottom:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:6px;pointer-events:none;max-width:350px}
.toast{padding:10px 16px;border-radius:10px;color:#fff;font-weight:600;font-size:12px;transform:translateX(120%);transition:all .3s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;gap:8px;pointer-events:auto;box-shadow:0 6px 24px rgba(0,0,0,.3)}
.toast.show{transform:translateX(0)}
.toast.success{background:linear-gradient(135deg,#0a2a1a,#0d3320);border:1px solid rgba(0,255,156,.3)}
.toast.error{background:linear-gradient(135deg,#2a0a0a,#330d0d);border:1px solid rgba(255,0,60,.3)}
.toast .toast-icon{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.toast.success .toast-icon{background:rgba(0,255,156,.15);color:var(--primary)}
.toast.error .toast-icon{background:rgba(255,0,60,.15);color:var(--danger)}
.toast .toast-msg{flex:1;line-height:1.3;font-size:11px}
.toast .toast-close{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px;padding:2px}

/* UPI / PAYMENT */
.upi-link-box{background:var(--bg-dark);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px}
.upi-link-box .upi-header{display:flex;align-items:center;gap:6px;margin-bottom:10px;font-size:11px;color:var(--text-dim)}
.upi-detail-row{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--bg-card);border-radius:6px;margin-bottom:4px}
.upi-detail-row .label{font-size:10px;color:var(--text-muted)}
.upi-detail-row .val{font-size:12px;font-weight:700;color:var(--warning)}
.upi-link-box .pay-btn{display:inline-flex;align-items:center;gap:5px;background:var(--info);color:#000;padding:7px 14px;border-radius:7px;text-decoration:none;font-weight:700;font-size:11px;margin-top:6px}
.proof-preview{max-width:180px;max-height:180px;border-radius:8px;border:1px solid var(--border);margin-top:6px;cursor:pointer}

/* INFO BOX */
.info-box{padding:8px 12px;border-radius:8px;font-size:11px;margin-bottom:12px;display:flex;align-items:flex-start;gap:6px;line-height:1.4}
.info-box.green{background:rgba(0,255,156,.06);border:1px solid rgba(0,255,156,.15);color:var(--primary)}
.info-box.yellow{background:rgba(255,170,0,.06);border:1px solid rgba(255,170,0,.15);color:var(--warning)}
.info-box.red{background:rgba(255,0,60,.06);border:1px solid rgba(255,0,60,.15);color:var(--danger)}

/* CHAT */
.chat-container{display:grid;grid-template-columns:260px 1fr;gap:0;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;background:var(--bg-card);min-height:460px;max-height:72vh}
.chat-sidebar{border-right:1px solid var(--border);display:flex;flex-direction:column}
.chat-sidebar-header{padding:10px 12px;border-bottom:1px solid var(--border)}
.chat-list{flex:1;overflow-y:auto}
.chat-user-item{display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer;transition:all .1s;border-bottom:1px solid var(--border);position:relative}
.chat-user-item:hover{background:rgba(0,255,156,.04)}
.chat-user-item.active{background:rgba(0,255,156,.08)}
.chat-user-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--primary)}
.chat-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--primary-dark),var(--primary));display:flex;align-items:center;justify-content:center;color:#000;font-weight:700;font-size:13px;flex-shrink:0}
.chat-user-info{flex:1;min-width:0}
.chat-user-name{font-weight:600;font-size:12px;display:flex;align-items:center;justify-content:space-between;gap:4px}
.chat-user-name .chat-time{font-size:9px;color:var(--text-muted);font-weight:400}
.chat-user-preview{font-size:10px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.chat-unread-dot{min-width:16px;height:16px;border-radius:50%;background:var(--danger);color:#fff;font-size:8px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;animation:redPulse 1.2s infinite}
.chat-main{display:flex;flex-direction:column;background:var(--bg-dark)}
.chat-main-header{padding:10px 14px;background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.chat-main-header .chat-header-info{flex:1}
.chat-main-header .chat-header-name{font-weight:700;font-size:13px}
.chat-main-header .chat-header-uid{font-size:9px;color:var(--text-muted);font-family:monospace}
.chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:4px}
.chat-bubble{max-width:75%;padding:8px 12px;border-radius:12px;font-size:12px;line-height:1.4;word-break:break-word;position:relative}
.chat-bubble.user{background:var(--bg-card);border:1px solid var(--border);align-self:flex-start;border-bottom-left-radius:3px}
.chat-bubble.admin{background:rgba(0,255,156,.1);border:1px solid rgba(0,255,156,.12);align-self:flex-end;border-bottom-right-radius:3px}
.chat-bubble .time{font-size:8px;color:var(--text-muted);margin-top:3px;display:flex;align-items:center;gap:3px}
.chat-bubble.admin .time{justify-content:flex-end}
.chat-input-bar{display:flex;gap:6px;padding:10px 12px;background:var(--bg-card);border-top:1px solid var(--border)}
.chat-input-bar input{flex:1}
.chat-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--text-muted);gap:8px}
.chat-empty i{font-size:36px;opacity:.25}

/* RESULT */
.result-screenshot-box{border:2px dashed var(--border);border-radius:var(--radius);padding:16px;text-align:center;min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .2s;cursor:pointer}
.result-screenshot-box:hover{border-color:var(--primary-dark)}
.result-screenshot-box img{max-width:100%;max-height:250px;border-radius:6px;margin-top:6px}
.result-screenshot-box.has-img{border-color:var(--primary)}

/* RESULT TABLE */
.result-table{width:100%;border-collapse:collapse;font-size:12px;min-width:0}
.result-table th{position:sticky;top:0;background:var(--bg-dark);padding:8px;text-align:left;font-size:9px;color:var(--text-muted);text-transform:uppercase;border-bottom:1px solid var(--border)}
.result-table td{padding:8px;border-bottom:1px solid var(--border);vertical-align:middle}
.result-table input{width:60px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:6px;font-family:inherit;font-size:12px;text-align:center;outline:none}
.result-table input:focus{border-color:var(--primary)}
.result-table .prize-cell{color:var(--primary);font-weight:700;font-family:'Orbitron',sans-serif;font-size:11px}

/* WALLET CARD INLINE */
.wallet-proof-cell{display:flex;align-items:center;gap:6px}
.wallet-proof-cell img{width:32px;height:32px;border-radius:5px;object-fit:cover;cursor:pointer;border:1px solid var(--border)}
.wallet-utr{font-size:10px;font-family:monospace;color:var(--info);font-weight:700;background:rgba(0,170,255,.08);padding:2px 6px;border-radius:4px}

/* USER TABS */
.detail-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:14px;overflow-x:auto}
.detail-tab{padding:8px 14px;font-size:11px;font-weight:600;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap}
.detail-tab.active{color:var(--primary);border-bottom-color:var(--primary)}
.detail-tab:hover{color:var(--text)}
.detail-panel{display:none}
.detail-panel.active{display:block}
.user-stat-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px}
.user-stat-row:last-child{border-bottom:none}
.user-stat-row .stat-label{color:var(--text-dim);display:flex;align-items:center;gap:5px}
.user-stat-row .stat-label i{width:14px;text-align:center;color:var(--text-muted);font-size:11px}
.user-stat-row .stat-val{font-weight:700}
.exp-bar{width:100%;height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:4px}
.exp-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--cyan));border-radius:3px;transition:width .3s}

/* MANUAL WALLET */
.manual-wallet-card{background:var(--bg-card2);border:1px solid var(--border-light);border-radius:10px;padding:14px;margin-bottom:14px}

/* DB PATH INDICATOR */
.db-path-tag{font-size:8px;color:var(--text-muted);font-family:monospace;background:rgba(0,170,255,.06);padding:1px 5px;border-radius:3px;border:1px solid rgba(0,170,255,.1);display:inline-flex;align-items:center;gap:3px;margin-left:6px}
.db-path-tag i{font-size:7px;color:var(--info)}

/* PROPOSED VALUE HIGHLIGHT */
.proposed-val{background:rgba(0,255,156,.08);border:1px solid rgba(0,255,156,.2);border-radius:6px;padding:3px 8px;font-weight:700;color:var(--primary);font-size:12px;display:inline-flex;align-items:center;gap:4px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.proposed-val i{font-size:9px;color:var(--primary);flex-shrink:0}
.proposed-val.warning{background:rgba(255,170,0,.08);border-color:rgba(255,170,0,.2);color:var(--warning)}
.proposed-val.warning i{color:var(--warning)}
.current-val{font-size:10px;color:var(--text-muted);display:flex;align-items:center;gap:3px;margin-top:2px}
.current-val i{font-size:8px}
.change-arrow{color:var(--primary);font-size:10px;margin:0 2px}
.profile-compare{display:flex;flex-direction:column;gap:2px}
.profile-compare .old{font-size:10px;color:var(--text-muted);text-decoration:line-through}
.profile-compare .new{font-size:12px;color:var(--primary);font-weight:700}

/* RESPONSIVE */
@media(min-width:1200px){.stats-grid{grid-template-columns:repeat(6,1fr)}}
@media(min-width:768px) and (max-width:1199px){.stats-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:1024px){
.sidebar{transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.sidebar-overlay.show{display:block}
.hamburger{display:flex}
.main-content{margin-left:0}
.grid-2,.grid-3{grid-template-columns:1fr}
.topbar{padding-left:50px}
.global-search{max-width:160px}
.chat-container{grid-template-columns:1fr;max-height:none}
.chat-sidebar{max-height:200px}
.chat-main{min-height:320px}
}
/* BAR CHART */
.bar-chart{display:flex;align-items:flex-end;gap:6px;height:140px;padding:10px 0}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;height:100%}
.bar-fill-container{flex:1;width:100%;display:flex;flex-direction:column;justify-content:flex-end}
.bar-fill{width:100%;background:linear-gradient(180deg,var(--primary),var(--primary-dark));border-radius:4px 4px 0 0;min-height:4px;transition:height .3s}
.bar-value{font-size:9px;color:var(--primary);margin-bottom:4px;white-space:nowrap}
.bar-label{font-size:9px;color:var(--text-muted);margin-top:4px}

/* QUEUE ITEMS */
.queue-item{background:var(--bg-card2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px}
.queue-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.queue-num{font-size:10px;font-weight:700;color:var(--text-muted);background:var(--bg-dark);padding:2px 8px;border-radius:4px}
.queue-body{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
.queue-user strong{font-size:13px}
.queue-upi{text-align:right}
.queue-amount{text-align:right}
.queue-actions{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}

/* ACTIVITY LOG */
.activity-list{max-height:60vh;overflow-y:auto}
.activity-item{padding:12px;border-bottom:1px solid var(--border);transition:background .15s}
.activity-item:hover{background:rgba(0,255,156,.02)}
.activity-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.activity-type{display:flex;align-items:center;gap:6px}
.activity-icon{font-size:14px}
.activity-label{font-size:11px;font-weight:700;letter-spacing:.5px}
.activity-time{font-size:10px;color:var(--text-muted)}
.activity-details{display:flex;flex-wrap:wrap;gap:8px}
.activity-detail{font-size:11px;display:flex;align-items:center;gap:4px}
.activity-detail i{font-size:9px;color:var(--text-muted)}

/* QUICK REPLIES */
.quick-replies-container{padding:6px 12px;background:var(--bg-card2);border-top:1px solid var(--border);display:flex;align-items:center;gap:6px;overflow-x:auto}
.quick-replies-label{font-size:9px;color:var(--text-muted);white-space:nowrap}
.quick-replies-list{display:flex;gap:4px}
.quick-reply-btn{background:var(--bg-dark);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:12px;font-size:12px;cursor:pointer;transition:all .15s}
.quick-reply-btn:hover{border-color:var(--primary);color:var(--primary)}

/* TEMPLATE CARDS */
.template-card{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-card2);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;margin-bottom:6px}
.template-card:hover{border-color:var(--primary);background:rgba(0,255,156,.03)}
.template-icon{font-size:20px}
.template-info{flex:1;min-width:0}
.template-title{font-size:12px;font-weight:700}
.template-preview{font-size:10px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

@media(max-width:480px){
.section{padding:10px}
.stats-grid{gap:8px}
.stat-card{padding:10px}
.stat-card .value{font-size:18px}
.stat-card .stat-icon{width:28px;height:28px;font-size:11px;margin-bottom:6px}
.section-title{font-size:13px}
.topbar-title{font-size:10px}
.topbar{height:44px;padding:0 10px;padding-left:44px}
.global-search{max-width:130px}
.global-search input{padding:5px 8px 5px 28px;font-size:10px}
.toast-container{bottom:10px;right:10px;left:10px;max-width:none}
.modal{border-radius:12px}
.modal-body{padding:12px}
table{font-size:11px}
th,td{padding:6px 8px}
.id-tag{padding:2px 6px;font-size:10px}
.id-tag .id-name{max-width:60px}
.id-tag .id-uid{max-width:50px}
.btn{padding:6px 10px;font-size:10px}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
<div class="login-card">
<div class="login-icon"><i class="fas fa-gamepad"></i></div>
<div class="login-title">MINI ESPORT</div>
<div class="login-subtitle">Admin Control Center</div>
<div class="login-error" id="loginError"><i class="fas fa-exclamation-circle"></i> <span id="loginErrorMsg"></span></div>
<form id="loginForm" onsubmit="handleLogin(event)">
<div class="form-group"><input type="email" id="loginEmail" class="form-input" placeholder="Admin Email" required></div>
<div class="form-group"><input type="password" id="loginPassword" class="form-input" placeholder="Password" required></div>
<button type="submit" class="btn btn-primary w-full" id="loginBtn" style="padding:11px;font-size:13px"><i class="fas fa-shield-halved"></i> Access Admin Panel</button>
</form>
</div>
</div>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen" style="display:none">
<div class="spinner"></div>
<p>INITIALIZING</p>
</div>

<!-- APP -->
<div class="app-container" id="mainApp" style="display:none">

<button class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
<div class="sidebar-header">
<div class="sidebar-logo"><i class="fas fa-gamepad"></i></div>
<div class="sidebar-brand-group">
<div class="sidebar-brand">MINI ESPORT</div>
<div class="sidebar-brand-sub">Admin Panel v4.0</div>
</div>
</div>
<div class="sidebar-nav">
<div class="nav-section-label">Overview</div>
<div class="nav-item active" onclick="showSection('dashboard',this)"><i class="fas fa-chart-line"></i><span class="nav-label">Dashboard</span></div>
<div class="nav-section-label">Verification</div>
<div class="nav-item" onclick="showSection('profileVerification',this)"><i class="fas fa-user-check"></i><span class="nav-label">New Verifications</span><span class="nav-badge orange" id="profileBadge" style="display:none">0</span></div>
<div class="nav-item" onclick="showSection('profileUpdates',this)"><i class="fas fa-user-edit"></i><span class="nav-label">Profile Updates</span><span class="nav-badge purple" id="profileUpdateBadge" style="display:none">0</span></div>
<div class="nav-item" onclick="showSection('users',this)"><i class="fas fa-users"></i><span class="nav-label">Users</span></div>
<div class="nav-divider"></div>
<div class="nav-section-label">Matches</div>
<div class="nav-item" onclick="showSection('tournaments',this)"><i class="fas fa-trophy"></i><span class="nav-label">Matches</span></div>
<div class="nav-item" onclick="showSection('joinedPlayers',this)"><i class="fas fa-clipboard-check"></i><span class="nav-label">Joined Players</span></div>
<div class="nav-item" onclick="showSection('results',this)"><i class="fas fa-bullseye"></i><span class="nav-label">Match Results</span></div>
<div class="nav-divider"></div>
<div class="nav-section-label">Finance</div>
<div class="nav-item" onclick="showSection('wallets',this)"><i class="fas fa-wallet"></i><span class="nav-label">Wallet Requests</span><span class="nav-badge green" id="walletBadge" style="display:none">0</span></div>
<div class="nav-item" onclick="showSection('teams',this)"><i class="fas fa-user-friends"></i><span class="nav-label">Team Requests</span><span class="nav-badge cyan" id="teamBadge" style="display:none">0</span></div>
<div class="nav-divider"></div>
<div class="nav-section-label">Communication</div>
<div class="nav-item support-pulse" id="supportNavItem" onclick="showSection('support',this)"><i class="fas fa-comments"></i><span class="nav-label">Support Chat</span><span class="nav-badge red" id="supportBadge" style="display:none">0</span></div>
<div class="nav-item" onclick="showSection('notifications',this)"><i class="fas fa-bell"></i><span class="nav-label">Notifications</span></div>
<div class="nav-item" onclick="showSection('settings',this)"><i class="fas fa-cog"></i><span class="nav-label">Settings</span></div>
<div class="nav-divider"></div>
<div class="nav-section-label">Tools</div>
<div class="nav-item" onclick="showSection('roster',this);loadRosterMatches();"><i class="fas fa-shield-alt"></i><span class="nav-label">Live Roster</span></div>
<div class="nav-item" onclick="showSection('analytics',this);loadAnalytics();"><i class="fas fa-chart-bar"></i><span class="nav-label">Analytics</span></div>
<div class="nav-item" onclick="showSection('lookup',this)"><i class="fas fa-search"></i><span class="nav-label">Player Lookup</span></div>
<div class="nav-item" onclick="showSection('activity',this);loadActivityLog();"><i class="fas fa-history"></i><span class="nav-label">Activity Log</span></div>
</div>
<div class="sidebar-footer">
<div class="admin-info">
<div class="admin-avatar"><i class="fas fa-user-shield"></i></div>
<div class="admin-details">
<div class="admin-name"><span>Admin</span><span class="online-dot"></span></div>
<div class="admin-email-text" id="adminEmail">admin@mini.esport</div>
</div>
</div>
<button class="logout-btn" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
</div>
</div>

<!-- MAIN -->
<div class="main-content">
<div class="maint-banner" id="maintBanner"><i class="fas fa-exclamation-triangle"></i> Maintenance Mode ACTIVE</div>
<div class="topbar">
<div class="topbar-left">
<div class="topbar-title" id="topbarTitle"><i class="fas fa-chart-line" style="color:var(--primary);margin-right:6px"></i>Dashboard</div>
</div>
<div class="global-search">
<i class="fas fa-search search-icon"></i>
<input type="text" id="globalSearchInput" placeholder="Search UID / Username..." oninput="handleGlobalSearch(this.value)" onfocus="handleGlobalSearch(this.value)" onblur="setTimeout(()=>document.getElementById('globalSearchResults').classList.remove('show'),200)">
<div class="search-results" id="globalSearchResults"></div>
</div>
<div class="topbar-actions">
<button class="logout-btn" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i><span class="hide-mobile"> Logout</span></button>
</div>
</div>

<!-- DASHBOARD -->
<div class="section active" id="section-dashboard">
<div class="section-header"><div class="section-title"><i class="fas fa-chart-line text-primary"></i> Dashboard</div><button class="btn btn-ghost btn-sm" onclick="refreshDashboard()"><i class="fas fa-sync-alt"></i> Refresh</button></div>
<div class="stats-grid">
<div class="stat-card"><div class="stat-icon green"><i class="fas fa-users"></i></div><h3>Total Users</h3><div class="value" id="statUsers">0</div><div class="sub">Registered</div></div>
<div class="stat-card"><div class="stat-icon blue"><i class="fas fa-trophy"></i></div><h3>Matches</h3><div class="value" id="statTournaments">0</div><div class="sub">Created</div></div>
<div class="stat-card"><div class="stat-icon orange"><i class="fas fa-clock"></i></div><h3>Wallet Pending</h3><div class="value" id="statWalletReq">0</div><div class="sub">Awaiting</div></div>
<div class="stat-card"><div class="stat-icon purple"><i class="fas fa-user-clock"></i></div><h3>Profile Pending</h3><div class="value" id="statPendingProfiles">0</div><div class="sub">Verify</div></div>
<div class="stat-card"><div class="stat-icon cyan"><i class="fas fa-gamepad"></i></div><h3>Active Matches</h3><div class="value" id="statActiveMatches">0</div><div class="sub">Live</div></div>
<div class="stat-card"><div class="stat-icon red"><i class="fas fa-money-bill-wave"></i></div><h3>Withdrawals</h3><div class="value" id="statPendingWithdraw">0</div><div class="sub">Pending</div></div>
</div>
<div class="grid-2">
<div class="card"><div class="card-header"><span><i class="fas fa-user-clock"></i> Recent Profiles</span></div><div class="card-body compact" id="recentProfiles"><p class="text-muted text-xs">Loading...</p></div></div>
<div class="card"><div class="card-header"><span><i class="fas fa-trophy"></i> Active Matches</span></div><div class="card-body compact" id="activeTournaments"><p class="text-muted text-xs">Loading...</p></div></div>
</div>
<div class="card mt-3"><div class="card-header"><span><i class="fas fa-bolt"></i> Live Activity Feed</span></div><div class="card-body compact" id="liveActivityFeed" style="max-height:200px;overflow-y:auto"><p class="text-muted text-xs">Loading...</p></div></div>

<!-- ADMIN FEATURE QUICK ACTIONS -->
<div class="card mt-3">
<div class="card-header"><span><i class="fas fa-tools" style="color:var(--primary)"></i> Quick Tools</span></div>
<div class="card-body" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;padding:12px">
<button class="btn btn-ghost btn-sm" onclick="window.showBulkMessage&&showBulkMessage()"><i class="fas fa-bullhorn"></i> Bulk Message</button>
<button class="btn btn-ghost btn-sm" onclick="window.runFraudCheck&&runFraudCheck()"><i class="fas fa-shield-halved"></i> Fraud Check</button>
<button class="btn btn-ghost btn-sm" onclick="window.showDisputes&&showDisputes()"><i class="fas fa-exclamation-triangle"></i> Disputes</button>
<button class="btn btn-ghost btn-sm" onclick="window.exportCSV&&exportCSV('users')"><i class="fas fa-file-csv"></i> Export Users</button>
<button class="btn btn-ghost btn-sm" onclick="window.exportCSV&&exportCSV('matches')"><i class="fas fa-download"></i> Export Matches</button>
<button class="btn btn-ghost btn-sm" onclick="window.showWithdrawalConfig&&showWithdrawalConfig()"><i class="fas fa-cog"></i> WD Config</button>
<button class="btn btn-ghost btn-sm" onclick="window.showPrizeCalculator&&showPrizeCalculator()"><i class="fas fa-calculator"></i> Prize Calc</button>
<button class="btn btn-ghost btn-sm" onclick="window.showScheduleAnnouncement&&showScheduleAnnouncement()"><i class="fas fa-calendar-plus"></i> Schedule Ann</button>
<button class="btn btn-ghost btn-sm" onclick="window.showActionLog&&showActionLog()"><i class="fas fa-history"></i> Action Log</button>
<button class="btn btn-ghost btn-sm" onclick="window.showBanAppeals&&showBanAppeals()"><i class="fas fa-gavel"></i> Ban Appeals</button>
<button class="btn btn-ghost btn-sm" onclick="window.showLiveScoreboard&&showLiveScoreboard('')"><i class="fas fa-list-ol"></i> Scoreboard</button>
<button class="btn btn-ghost btn-sm" onclick="window.showAutoPayoutRules&&showAutoPayoutRules()"><i class="fas fa-robot"></i> Auto Payout</button>
<button class="btn btn-ghost btn-sm" onclick="window.checkPlatformHealth&&checkPlatformHealth()"><i class="fas fa-heartbeat"></i> Platform Health</button>
<button class="btn btn-ghost btn-sm" onclick="window.showUpiSettings&&showUpiSettings()"><i class="fas fa-university"></i> UPI Settings</button>
<button class="btn btn-ghost btn-sm" onclick="window.showVoucherManager&&showVoucherManager()"><i class="fas fa-ticket-alt"></i> Vouchers</button>
<button class="btn btn-ghost btn-sm" onclick="window.showBannerManager&&showBannerManager()"><i class="fas fa-image"></i> Banner Mgr</button>
<button class="btn btn-ghost btn-sm" onclick="window.showTickerManager&&showTickerManager()"><i class="fas fa-scroll"></i> Ticker Mgr</button>
<button class="btn btn-ghost btn-sm" onclick="window.showKillProofs&&showKillProofs()"><i class="fas fa-camera"></i> Kill Proofs</button>
<button class="btn btn-ghost btn-sm" onclick="window.showAllNotes&&showAllNotes()"><i class="fas fa-sticky-note"></i> User Notes</button>
<button class="btn btn-ghost btn-sm" onclick="window.runTeamJoinHealthCheck&&runTeamJoinHealthCheck()"><i class="fas fa-users-cog"></i> Team Check</button>
<button class="btn btn-ghost btn-sm" onclick="window.showSeasonManager&&showSeasonManager()"><i class="fas fa-crown"></i> Season Mgr</button>
<button class="btn btn-ghost btn-sm" onclick="window.showMatchFeedbacks&&showMatchFeedbacks()"><i class="fas fa-star"></i> Feedbacks</button>
<button class="btn btn-ghost btn-sm" onclick="window.showAppSettings&&showAppSettings()"><i class="fas fa-mobile-alt"></i> App Settings</button>
<button class="btn btn-ghost btn-sm" onclick="window.showLiveUserCount&&showLiveUserCount()"><i class="fas fa-users"></i> Live Count</button>
<button class="btn btn-ghost btn-sm" onclick="window.showResultHistory&&showResultHistory()"><i class="fas fa-history"></i> Result History</button>
<button class="btn btn-ghost btn-sm" onclick="window.showPendingProfiles&&showPendingProfiles()"><i class="fas fa-user-check"></i> Pending Profiles</button>
<button class="btn btn-ghost btn-sm" onclick="window.showPendingWallet&&showPendingWallet()"><i class="fas fa-wallet"></i> Pending Wallets</button>
<button class="btn btn-ghost btn-sm" onclick="window.showQuickMatchCreate&&showQuickMatchCreate()"><i class="fas fa-plus-circle"></i> Quick Create</button>
<button class="btn btn-ghost btn-sm" onclick="window.showBulkStatusUpdate&&showBulkStatusUpdate()"><i class="fas fa-tasks"></i> Bulk Status</button>
<button class="btn btn-ghost btn-sm" onclick="window.initAdminDashboard&&initAdminDashboard()"><i class="fas fa-sync"></i> Re-init Dash</button>
</div>
</div>

<!-- ANALYTICS WIDGETS ROW -->
<div class="grid-2 mt-3">
<div class="card"><div class="card-header"><span><i class="fas fa-chart-line"></i> Revenue Analytics</span></div><div class="card-body compact" id="revenueAnalyticsWrap"><button class="btn btn-ghost btn-sm" onclick="window.renderRevenueAnalytics&&renderRevenueAnalytics()"><i class="fas fa-play"></i> Load</button></div></div>
<div class="card"><div class="card-header"><span><i class="fas fa-users"></i> Platform Stats</span></div><div class="card-body compact" id="platformStatsWrap"><button class="btn btn-ghost btn-sm" onclick="window.renderPlatformStats&&renderPlatformStats('platformStatsWrap')"><i class="fas fa-play"></i> Load</button></div></div>
</div>
</div>

<!-- PROFILE VERIFY — NEW USERS (type: verification) -->
<div class="section" id="section-profileVerification">
<div class="section-header"><div class="section-title"><i class="fas fa-user-check text-primary"></i> New Verifications <span class="count" id="profileCount">0</span></div></div>
<div class="info-box yellow mb-3" style="align-items:center"><i class="fas fa-shield-halved"></i> <strong>New Verifications:</strong> Approve karne se IGN &amp; FF UID set hoga aur user ko full access milega.</div>
<div class="card"><div class="card-body compact"><div class="table-wrapper"><table><thead><tr><th>User</th><th>Requested IGN</th><th>Requested FF UID</th><th>Phone</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody id="profileRequestsTable"></tbody></table></div></div></div>
</div>

<!-- PROFILE UPDATES — EXISTING VERIFIED USERS (type: update) -->
<div class="section" id="section-profileUpdates">
<div class="section-header"><div class="section-title"><i class="fas fa-user-edit text-primary"></i> Profile Updates <span class="count" id="profileUpdateCount">0</span></div></div>
<div class="info-box green mb-3" style="align-items:center"><i class="fas fa-exchange-alt"></i> <strong>Profile Updates:</strong> Verified users ki update requests — approve karne se current IGN/FF UID overwrite hoga.</div>
<div class="card"><div class="card-body compact"><div class="table-wrapper"><table><thead><tr><th>User Name</th><th>User UID</th><th>Current IGN</th><th>Current FF UID</th><th>→ New IGN</th><th>→ New FF UID</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody id="profileUpdateTable"></tbody></table></div></div></div>
</div>

<!-- USERS -->
<div class="section" id="section-users">
<div class="section-header">
<div class="section-title"><i class="fas fa-users text-primary"></i> Users <span class="count" id="userCount">0</span></div>
<div class="section-actions">
<button class="btn btn-purple btn-sm" onclick="openManualWalletModal()"><i class="fas fa-plus-minus"></i> Credit/Debit</button>
<input type="text" id="searchUser" class="form-input" placeholder="Search..." style="max-width:160px;padding:6px 10px;font-size:11px" onkeyup="renderUsers()">
</div>
</div>
<div class="card"><div class="card-body compact"><div class="table-wrapper"><table><thead><tr><th>Identity</th><th>Balance</th><th>Matches</th><th>Level</th><th>Status</th><th>Actions</th></tr></thead><tbody id="usersTable"></tbody></table></div></div></div>
</div>

<!-- TOURNAMENTS / MATCHES -->
<div class="section" id="section-tournaments">
<div class="section-header"><div class="section-title"><i class="fas fa-trophy text-primary"></i> Matches <span class="count" id="tournamentCount">0</span><span class="db-path-tag"><i class="fas fa-database"></i> matches/</span></div><div class="section-actions"><button class="btn btn-ghost btn-sm" onclick="openBulkScheduler()"><i class="fas fa-calendar-plus"></i> Bulk</button><button class="btn btn-primary btn-sm" onclick="openTournamentModal()"><i class="fas fa-plus"></i> Create</button></div></div>
<div class="filter-tabs">
<button class="filter-tab active" onclick="filterTournaments('all',this)">All</button>
<button class="filter-tab" onclick="filterTournaments('upcoming',this)">🕐 Upcoming</button>
<button class="filter-tab" onclick="filterTournaments('live',this)">🔴 Live</button>
<button class="filter-tab" onclick="filterTournaments('completed',this)">✅ Completed</button>
<button class="filter-tab" onclick="filterTournaments('paid',this)">Paid</button>
<button class="filter-tab" onclick="filterTournaments('coin',this)">Coin</button>
<button class="filter-tab" onclick="filterTournaments('special',this)">⭐ Special</button>
</div>
<div class="info-box yellow" style="padding:4px 10px;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"><i class="fas fa-info-circle"></i> Upcoming→Live (match time) →Completed (1h). Publish=final, Cancel=auto-refund.</div>
<div class="card"><div class="card-body compact"><div class="table-wrapper"><table><thead><tr><th>Name</th><th>Mode</th><th>Entry</th><th>Prize</th><th>Slots</th><th>Map</th><th>Time</th><th>Status</th><th>Actions</th></tr></thead><tbody id="tournamentsTable"></tbody></table></div></div></div>
</div>

<!-- JOINED PLAYERS -->
<div class="section" id="section-joinedPlayers">
<div class="section-header"><div class="section-title"><i class="fas fa-clipboard-check text-primary"></i> Joined Players <span class="count" id="joinedCount">0</span></div>
<div class="section-actions">
<button class="btn btn-ghost btn-sm" onclick="refreshJoinedPlayers()"><i class="fas fa-sync-alt"></i> Refresh</button>
<select id="joinedTournamentFilter" class="form-input" style="max-width:220px;padding:6px 10px" onchange="loadJoinedPlayers()"><option value="all">All Matches</option></select>
</div></div>
<div class="card"><div class="card-body compact"><div class="table-wrapper"><table><thead><tr><th>Player / FF UID</th><th>Match</th><th>Mode</th><th>Entry</th><th>Joined At</th><th>Status</th></tr></thead><tbody id="joinedPlayersTable"></tbody></table></div></div></div>
</div>

<!-- RESULTS -->
<div class="section" id="section-results">
<div class="section-header"><div class="section-title"><i class="fas fa-bullseye text-primary"></i> Match Results</div></div>
<div class="card"><div class="card-body">
<div class="form-group"><label>Select Match</label><select id="resultTournamentSelect" class="form-input" onchange="loadParticipants()"><option value="">-- Select Match --</option></select></div>
<div id="resultsContainer" style="display:none">
<div class="grid-2 mb-4">
<div>
<div class="form-group"><label>Screenshot (optional)</label>
<div class="result-screenshot-box" id="resultScreenshotBox" onclick="document.getElementById('resultFileInput').click()"><i class="fas fa-cloud-upload-alt" style="font-size:24px;color:var(--text-muted)"></i><p class="text-muted text-xxs mt-2">Click to upload</p><input type="file" id="resultFileInput" accept="image/*" onchange="previewResultScreenshot(this)" style="display:none"></div></div>
</div>
<div>
<div class="info-box green"><i class="fas fa-calculator"></i> Enter Kills per player → prize auto-calculated as <strong>Kills × Per Kill Price</strong> + Rank Prize</div>
<div id="resultTournamentInfo" class="manual-wallet-card text-xs"></div>
</div>
</div>
<div class="form-group"><label>Search Participant</label><input type="text" class="form-input" placeholder="Search by name..." onkeyup="filterParticipants(this.value)"></div>
<div class="table-wrapper" style="max-height:50vh"><table class="result-table"><thead><tr><th>#</th><th>Player / FF UID</th><th>Position <small style="font-weight:400;opacity:.7">(0=no rank prize)</small></th><th>Kills</th><th>Prize (Auto)</th></tr></thead><tbody id="participantsList"></tbody></table></div>
<button class="btn btn-primary w-full mt-3" id="publishResultsBtn" onclick="publishResults()" style="padding:10px"><i class="fas fa-check-double"></i> Publish Results & Distribute Prizes</button>
</div>
</div></div>
</div>

<!-- WALLETS -->
<div class="section" id="section-wallets">
<div class="section-header"><div class="section-title"><i class="fas fa-wallet text-primary"></i> Wallet Requests <span class="count" id="walletCount">0</span></div>
<div class="section-actions">
<button class="btn btn-purple btn-sm" onclick="openManualWalletModal()"><i class="fas fa-plus-minus"></i> Manual</button>
<select id="walletFilter" class="form-input" style="max-width:140px;padding:6px 10px" onchange="renderWalletRequests()"><option value="all">All</option><option value="add">Add Money</option><option value="withdraw">Withdrawal</option></select>
</div></div>
<!-- Withdrawal Queue -->
<div class="card mb-3"><div class="card-header"><i class="fas fa-list-ol"></i> Withdrawal Queue <span class="text-muted text-xs ml-2" id="withdrawalQueueSummary"></span></div><div class="card-body compact" id="withdrawalQueueList" style="max-height:250px;overflow-y:auto"><p class="text-muted text-xs">Loading queue...</p></div></div>
<div class="card"><div class="card-body compact"><div class="table-wrapper"><table><thead><tr><th>Identity</th><th>Type</th><th>Amount</th><th>UTR / UPI</th><th>Proof</th><th>Status</th><th>Actions</th></tr></thead><tbody id="walletRequestsTable"></tbody></table></div></div></div>
</div>

<!-- TEAMS -->
<div class="section" id="section-teams">
<div class="section-header"><div class="section-title"><i class="fas fa-user-friends text-primary"></i> Team Requests <span class="count" id="teamCount">0</span></div></div>
<div class="card"><div class="card-body compact"><div class="table-wrapper"><table><thead><tr><th>Owner</th><th>Type</th><th>Member</th><th>Status</th><th>Actions</th></tr></thead><tbody id="teamRequestsTable"></tbody></table></div></div></div>
</div>

<!-- SUPPORT CHAT -->
<div class="section" id="section-support">
<div class="section-header"><div class="section-title"><i class="fas fa-comments text-primary"></i> Support Chat <span class="db-path-tag"><i class="fas fa-database"></i> support/{uid}/</span></div></div>
<div class="chat-container">
<div class="chat-sidebar">
<div class="chat-sidebar-header"><input type="text" class="form-input" placeholder="Search users..." style="padding:7px 10px;font-size:11px" id="chatSearchInput" onkeyup="filterChatUsers(this.value)"></div>
<div class="chat-list" id="chatUserList"><div class="chat-empty" style="padding:30px 0"><i class="fas fa-comments"></i><span class="text-xs">No conversations</span></div></div>
</div>
<div class="chat-main" id="chatMainArea">
<div class="chat-empty"><i class="fas fa-comment-dots"></i><span class="text-sm">Select a conversation</span><span class="text-xs text-muted">Choose a user to start chatting</span></div>
</div>
</div>
</div>

<!-- NOTIFICATIONS -->
<div class="section" id="section-notifications">
<div class="section-header"><div class="section-title"><i class="fas fa-bell text-primary"></i> Notifications</div></div>
<div class="grid-2">
<div class="card"><div class="card-header"><i class="fas fa-bullhorn"></i> Global</div><div class="card-body">
<div class="form-group"><label>Title</label><input type="text" id="globalNotifTitle" class="form-input" placeholder="Title"></div>
<div class="form-group"><label>Message</label><textarea id="globalNotifMsg" class="form-input" placeholder="Message..."></textarea></div>
<button class="btn btn-primary w-full" id="sendGlobalBtn" onclick="sendGlobalNotification()"><i class="fas fa-paper-plane"></i> Send to All</button>
</div></div>
<div class="card"><div class="card-header"><i class="fas fa-trophy"></i> Match</div><div class="card-body">
<div class="form-group"><label>Match</label><select id="notifTournamentSelect" class="form-input"><option value="">-- Select --</option></select></div>
<div class="form-group"><label>Title</label><input type="text" id="matchNotifTitle" class="form-input" placeholder="Title"></div>
<div class="form-group"><label>Message</label><textarea id="matchNotifMsg" class="form-input" placeholder="Details..."></textarea></div>
<button class="btn btn-primary w-full" id="sendMatchBtn" onclick="sendMatchNotification()"><i class="fas fa-paper-plane"></i> Send to Players</button>
</div></div>
</div>
<div class="card mt-3"><div class="card-header"><i class="fas fa-user-tag"></i> Send to Specific User</div><div class="card-body">
<div class="info-box green"><i class="fas fa-info-circle"></i> Send a custom notification to any user by entering their UID. The notification will appear in their app instantly.</div>
<div class="grid-2">
<div>
<div class="form-group"><label>User UID *</label><input type="text" id="customNotifUid" class="form-input" placeholder="Paste UID here"><button class="btn btn-ghost btn-xs mt-2" onclick="lookupCustomNotifUser()"><i class="fas fa-search"></i> Lookup</button></div>
<div id="customNotifUserInfo" style="display:none" class="manual-wallet-card">
<div class="flex items-center gap-2"><span class="font-bold text-primary" id="customNotifUserName">—</span><span class="badge green" id="customNotifUserStatus">Active</span></div>
</div>
</div>
<div>
<div class="form-group"><label>Title *</label><input type="text" id="customNotifTitle" class="form-input" placeholder="Notification title"></div>
<div class="form-group"><label>Message *</label><textarea id="customNotifMsg" class="form-input" placeholder="Your message..." style="min-height:50px"></textarea></div>
</div>
</div>
<button class="btn btn-primary" id="sendCustomNotifBtn" onclick="sendCustomNotification()"><i class="fas fa-paper-plane"></i> Send Custom Notification</button>
</div></div>
</div>

<!-- SETTINGS -->
<div class="section" id="section-settings">
<div class="section-header"><div class="section-title"><i class="fas fa-cog text-primary"></i> Settings</div></div>
<div class="grid-2">
<div class="card"><div class="card-header"><i class="fas fa-credit-card"></i> Payment</div><div class="card-body">
<div class="form-group"><label>UPI ID</label><input type="text" id="settUpiId" class="form-input" placeholder="example@upi"></div>
<div class="form-group"><label>Min Withdrawal (₹)</label><input type="number" id="settMinWithdraw" class="form-input" placeholder="50"></div>
<button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save"></i> Save</button>
</div></div>
<div class="card"><div class="card-header"><i class="fas fa-gamepad"></i> Game</div><div class="card-body">
<div class="form-group"><label>Coins Per Ad</label><input type="number" id="settCoinsPerAd" class="form-input" placeholder="5"></div>
<div class="form-group"><label>Referral Reward (₹)</label><input type="number" id="settReferralReward" class="form-input" placeholder="10"></div>
<button class="btn btn-primary" onclick="saveGameSettings()"><i class="fas fa-save"></i> Save</button>
</div></div>
</div>
<div class="grid-2 mt-3">
<div class="card"><div class="card-header"><i class="fas fa-tools"></i> Maintenance</div><div class="card-body">
<div class="flex items-center justify-between mb-4"><div><strong class="text-sm">Maintenance Mode</strong><p class="text-dim text-xxs">Block user access</p></div><label class="toggle"><input type="checkbox" id="maintToggle" onchange="toggleMaintenance()"><span class="toggle-slider"></span></label></div>
<div class="form-group"><label>Global Message</label><textarea id="settGlobalMsg" class="form-input" placeholder="Message..."></textarea></div>
<div class="flex gap-2"><button class="btn btn-primary btn-sm" onclick="saveGlobalMessage()"><i class="fas fa-save"></i> Save</button><button class="btn btn-danger btn-sm" onclick="clearGlobalMessage()"><i class="fas fa-trash"></i> Clear</button></div>
</div></div>
<div class="card"><div class="card-header"><i class="fas fa-eye"></i> Spectate</div><div class="card-body">
<div class="form-group"><label>Live Spectate Link</label><input type="text" id="settSpectateLink" class="form-input" placeholder="https://..."></div>
<button class="btn btn-primary" onclick="saveSpectateLink()"><i class="fas fa-save"></i> Save</button>
</div></div>
</div>
<div class="card mt-3"><div class="card-header"><i class="fas fa-ticket-alt"></i> Vouchers</div><div class="card-body">
<div class="grid-3 mb-3">
<div class="form-group"><label>Code</label><input type="text" id="voucherCode" class="form-input" placeholder="CODE2024"></div>
<div class="form-group"><label>Value (₹)</label><input type="number" id="voucherValue" class="form-input" placeholder="50"></div>
<div class="form-group"><label>Max Uses</label><input type="number" id="voucherMaxUses" class="form-input" placeholder="100"></div>
</div>
<button class="btn btn-primary mb-3" onclick="createVoucher()"><i class="fas fa-plus"></i> Create</button>
<div class="table-wrapper"><table><thead><tr><th>Code</th><th>Value</th><th>Uses</th><th>Max</th><th>Actions</th></tr></thead><tbody id="vouchersTable"></tbody></table></div>
</div></div>
</div>

<!-- LIVE ROSTER -->
<div class="section" id="section-roster">
<div class="section-header"><div class="section-title"><i class="fas fa-shield-alt text-primary"></i> Live Roster</div>
<div class="section-actions">
<select id="rosterMatchSelect" class="form-input" style="max-width:250px" onchange="loadRoster()"><option value="">-- Select Match --</option></select>
<button class="btn btn-ghost btn-sm" onclick="loadRoster()"><i class="fas fa-sync-alt"></i></button>
</div></div>
<div class="info-box green mb-3"><i class="fas fa-info-circle"></i> Select a live/upcoming match. Mark players as Present/Kicked during the match. Use "Copy IGN List" to get all player names.</div>
<div id="rosterStats" class="stats-grid mb-3" style="grid-template-columns:repeat(4,1fr)"></div>
<div class="card"><div class="card-body compact"><div class="table-wrapper"><table><thead><tr><th>#</th><th>IGN</th><th>FF UID</th><th>Status</th><th>Action</th></tr></thead><tbody id="rosterTable"><tr><td colspan="5" class="text-muted text-center">Select a match first</td></tr></tbody></table></div></div></div>
<div class="flex gap-2 mt-3">
<button class="btn btn-primary" onclick="exportRosterList()"><i class="fas fa-copy"></i> Copy IGN List</button>
<button class="btn btn-ghost" onclick="clearRosterStatus()"><i class="fas fa-redo"></i> Clear All Status</button>
</div>
</div>

<!-- ANALYTICS -->
<div class="section" id="section-analytics">
<div class="section-header"><div class="section-title"><i class="fas fa-chart-bar text-primary"></i> Analytics</div>
<button class="btn btn-ghost btn-sm" onclick="refreshAnalytics()"><i class="fas fa-sync-alt"></i> Refresh</button>
</div>
<div class="stats-grid mb-4" style="grid-template-columns:repeat(3,1fr)">
<div class="stat-card"><div class="stat-icon green"><i class="fas fa-arrow-down"></i></div><h3>Total Revenue</h3><div class="value text-primary" id="analRevenue">₹0</div><div class="sub">From deposits</div></div>
<div class="stat-card"><div class="stat-icon red"><i class="fas fa-arrow-up"></i></div><h3>Total Payouts</h3><div class="value text-warning" id="analPayout">₹0</div><div class="sub">Withdrawals + Prizes</div></div>
<div class="stat-card"><div class="stat-icon blue"><i class="fas fa-coins"></i></div><h3>Net Profit</h3><div class="value" id="analNet">₹0</div><div class="sub">Revenue - Payouts</div></div>
</div>
<div class="grid-2">
<div class="card"><div class="card-header"><i class="fas fa-chart-line"></i> Last 7 Days Revenue</div><div class="card-body" id="analChart"><p class="text-muted text-xs">Loading...</p></div></div>
<div class="card"><div class="card-header"><i class="fas fa-trophy"></i> Top Matches (by Prize)</div><div class="card-body compact" id="analTopMatches"><p class="text-muted text-xs">Loading...</p></div></div>
</div>
<div class="card mt-3"><div class="card-header"><i class="fas fa-crown"></i> Top Earners</div><div class="card-body compact" id="analTopPlayers"><p class="text-muted text-xs">Loading...</p></div></div>
</div>

<!-- PLAYER LOOKUP -->
<div class="section" id="section-lookup">
<div class="section-header"><div class="section-title"><i class="fas fa-search text-primary"></i> Player Lookup</div>
<button class="btn btn-ghost btn-sm" onclick="clearLookup()"><i class="fas fa-times"></i> Clear</button>
</div>
<div class="card mb-3"><div class="card-body">
<div class="form-group"><label>Search by IGN, UID, FF UID, or Phone</label>
<div class="flex gap-2"><input type="text" id="playerSearchInput" class="form-input" placeholder="Enter search term..." onkeyup="if(event.key==='Enter')searchPlayers()">
<button class="btn btn-primary" onclick="searchPlayers()"><i class="fas fa-search"></i> Search</button></div></div>
</div></div>
<div id="lookupResults"><p class="text-muted text-xs" style="padding:20px;text-align:center">Enter IGN, UID, FF UID, or Phone to search</p></div>
<div id="investigationDetail" style="display:none" class="card mt-3"><div class="card-header"><i class="fas fa-user-secret"></i> Investigation Report</div><div class="card-body"></div></div>
</div>

<!-- ACTIVITY LOG -->
<div class="section" id="section-activity">
<div class="section-header"><div class="section-title"><i class="fas fa-history text-primary"></i> Activity Log <span class="count" id="activityLogCount">0</span></div>
<div class="section-actions">
<select class="form-input" style="max-width:140px" onchange="filterActivityLog(this.value)">
<option value="all">All Types</option>
<option value="ban">Bans</option>
<option value="wallet">Wallet</option>
<option value="result">Results</option>
<option value="profile">Profiles</option>
<option value="match">Matches</option>
<option value="credit">Credits</option>
<option value="debit">Debits</option>
</select>
<button class="btn btn-ghost btn-sm" onclick="refreshActivityLog()"><i class="fas fa-sync-alt"></i></button>
<button class="btn btn-ghost btn-sm" onclick="exportActivityLog()"><i class="fas fa-download"></i> Export</button>
</div></div>
<div class="card"><div class="card-body compact" id="activityLogList"><p class="text-muted text-xs" style="padding:20px;text-align:center">Loading activity logs...</p></div></div>
</div>

</div><!-- main-content end -->
</div><!-- app end -->

<!-- MODALS -->
<!-- Tournament Modal -->
<div class="modal-overlay" id="tournamentModal">
<div class="modal">
<div class="modal-header"><div class="modal-title"><i class="fas fa-trophy"></i> Match <span class="db-path-tag"><i class="fas fa-database"></i> matches/</span></div><button class="modal-close" onclick="closeModal('tournamentModal')">&times;</button></div>
<div class="modal-body">
<input type="hidden" id="tournamentId">
<div class="grid-2">
<div class="form-group"><label>Name *</label><input type="text" id="tName" class="form-input" placeholder="Match name"></div>
<div class="form-group"><label>Game Mode *</label><select id="tGameMode" class="form-input"><option value="solo">Solo</option><option value="duo">Duo</option><option value="squad">Squad</option></select></div>
</div>
<div class="grid-2">
<div class="form-group"><label>Map *</label><select id="tMap" class="form-input"><option>Bermuda</option><option>Kalahari</option><option>Purgatory</option><option>Alpine</option><option>Nexterra</option><option>Bermuda Remastered</option></select></div>
<div class="form-group"><label>Entry Type *</label><select id="tEntryType" class="form-input" onchange="onEntryTypeChange()"><option value="paid">Paid</option><option value="coin">Coin</option></select></div>
</div>
<div id="entryTypeHint" class="info-box green"><i class="fas fa-info-circle"></i> Paid — real money (₹)</div>
<div id="currentStatusHint" class="info-box yellow" style="display:none"><i class="fas fa-clock"></i> <span id="currentStatusText">Current Status: —</span></div>
<div class="grid-3">
<div class="form-group"><label>Entry Fee *</label><input type="number" id="tEntryFee" class="form-input" placeholder="0"></div>
<div class="form-group"><label>Prize Pool</label><input type="number" id="tPrizePool" class="form-input" placeholder="0"></div>
<div class="form-group"><label>Per Kill ₹ *</label><input type="number" id="tPerKillPrize" class="form-input" placeholder="0"></div>
</div>
<div class="grid-3">
<div class="form-group"><label>1st Prize</label><input type="number" id="tFirstPrize" class="form-input" placeholder="0"></div>
<div class="form-group"><label>2nd Prize</label><input type="number" id="tSecondPrize" class="form-input" placeholder="0"></div>
<div class="form-group"><label>3rd Prize</label><input type="number" id="tThirdPrize" class="form-input" placeholder="0"></div>
</div>
<div class="grid-2">
<div class="form-group"><label>Max Slots *</label><input type="number" id="tMaxSlots" class="form-input" placeholder="12"></div>
<div class="form-group"><label>Match Time *</label><input type="datetime-local" id="tMatchTime" class="form-input"></div>
</div>
<div class="grid-2">
<div class="form-group"><label>Room ID</label><input type="text" id="tRoomId" class="form-input" placeholder="Room ID"></div>
<div class="form-group"><label>Room Password</label><input type="text" id="tRoomPass" class="form-input" placeholder="Password"></div>
</div>
<div class="flex items-center justify-between mb-3"><label class="font-bold text-xs">⭐ Special Match</label><label class="toggle"><input type="checkbox" id="tIsSpecial"><span class="toggle-slider"></span></label></div>
</div>
<div class="modal-footer">
<button class="btn btn-ghost" onclick="closeModal('tournamentModal')">Cancel</button>
<button class="btn btn-primary" id="saveTournamentBtn" onclick="saveTournament()"><i class="fas fa-save"></i> Save & Update</button>
</div>
</div>
</div>

<!-- User Modal -->
<div class="modal-overlay" id="userModal">
<div class="modal" style="width:600px">
<div class="modal-header"><div class="modal-title"><i class="fas fa-user"></i> <span id="userModalName">User</span></div><button class="modal-close" onclick="closeModal('userModal')">&times;</button></div>
<div class="modal-body" id="userModalBody"><p class="text-muted">Loading...</p></div>
<div class="modal-footer" id="userModalFooter"></div>
</div>
</div>

<!-- Manual Wallet Modal -->
<div class="modal-overlay" id="manualWalletModal">
<div class="modal" style="width:440px">
<div class="modal-header"><div class="modal-title"><i class="fas fa-plus-minus"></i> Manual Credit/Debit</div><button class="modal-close" onclick="closeModal('manualWalletModal')">&times;</button></div>
<div class="modal-body">
<div class="info-box yellow"><i class="fas fa-exclamation-triangle"></i> Directly modifies wallet. Use with caution.</div>
<div class="form-group"><label>User UID *</label><input type="text" id="manualUid" class="form-input" placeholder="Paste UID"><button class="btn btn-ghost btn-xs mt-2" onclick="lookupManualUser()"><i class="fas fa-search"></i> Lookup</button></div>
<div id="manualUserInfo" style="display:none" class="manual-wallet-card">
<div class="flex items-center gap-2 mb-2"><span class="font-bold text-primary" id="manualUserName">—</span><span class="badge green" id="manualUserStatus">—</span></div>
<div class="flex gap-3 text-xs"><span>Dep: <strong class="text-primary" id="manualUserDep">₹0</strong></span><span>Win: <strong class="text-primary" id="manualUserWin">₹0</strong></span></div>
</div>
<div class="grid-2">
<div class="form-group"><label>Action *</label><select id="manualAction" class="form-input"><option value="credit">Credit (Add)</option><option value="debit">Debit (Remove)</option></select></div>
<div class="form-group"><label>Wallet *</label><select id="manualWalletType" class="form-input"><option value="deposit">Deposit</option><option value="winning">Winning</option></select></div>
</div>
<div class="form-group"><label>Amount (₹) *</label><input type="number" id="manualAmount" class="form-input" placeholder="Amount" min="1"></div>
<div class="form-group"><label>Reason</label><input type="text" id="manualReason" class="form-input" placeholder="Reason"></div>
</div>
<div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('manualWalletModal')">Cancel</button><button class="btn btn-primary" onclick="processManualWallet()"><i class="fas fa-check"></i> Process</button></div>
</div>
</div>

<!-- Withdrawal Modal -->
<div class="modal-overlay" id="withdrawalModal">
<div class="modal">
<div class="modal-header"><div class="modal-title"><i class="fas fa-money-bill-wave"></i> Process Withdrawal</div><button class="modal-close" onclick="closeModal('withdrawalModal')">&times;</button></div>
<div class="modal-body">
<div class="upi-link-box">
<div class="upi-header"><i class="fas fa-user"></i> Withdrawal Details</div>
<div class="upi-detail-row"><span class="label">Username</span><span class="val" id="withdrawUserName">—</span></div>
<div class="upi-detail-row"><span class="label">UID</span><span class="val" id="withdrawUserUid" style="font-size:9px;font-family:monospace;color:var(--text-dim)">—</span></div>
<div class="upi-detail-row"><span class="label">UPI ID</span><span class="val" id="withdrawUpiId">—</span></div>
<div class="upi-detail-row"><span class="label">Amount</span><span class="val" id="withdrawAmount">₹0</span></div>
<a href="#" id="withdrawPayLink" class="pay-btn" target="_blank"><i class="fas fa-external-link-alt"></i> Open UPI</a>
</div>
<div class="form-group"><label>Payment Proof *</label><input type="file" accept="image/*" class="form-input" onchange="previewWithdrawProof(this)"><img id="withdrawProofPreview" class="proof-preview" style="display:none"></div>
<div class="form-group"><label>TXN ID / Message</label><input type="text" id="withdrawAdminMsg" class="form-input" placeholder="TXN ID"></div>
</div>
<div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('withdrawalModal')">Cancel</button><button class="btn btn-primary" id="confirmWithdrawBtn" onclick="confirmWithdrawal()" disabled><i class="fas fa-check"></i> Confirm</button></div>
</div>
</div>

<!-- Reject Modal -->
<div class="modal-overlay" id="rejectModal">
<div class="modal" style="width:420px">
<div class="modal-header"><div class="modal-title"><i class="fas fa-times-circle"></i> Reject</div><button class="modal-close" onclick="closeModal('rejectModal')">&times;</button></div>
<div class="modal-body"><div class="form-group"><label>Reason *</label><textarea id="rejectReason" class="form-input" placeholder="Enter reason..."></textarea></div></div>
<div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('rejectModal')">Cancel</button><button class="btn btn-danger" onclick="submitReject()"><i class="fas fa-times"></i> Reject</button></div>
</div>
</div>

<!-- Bulk Scheduler Modal -->
<div class="modal-overlay" id="bulkSchedulerModal">
<div class="modal" style="width:500px">
<div class="modal-header"><div class="modal-title"><i class="fas fa-calendar-plus"></i> Bulk Match Scheduler</div><button class="modal-close" onclick="closeBulkScheduler()">&times;</button></div>
<div class="modal-body">
<div class="info-box green mb-3"><i class="fas fa-info-circle"></i> Create multiple matches at once with the same settings on different days.</div>
<div class="grid-2">
<div class="form-group"><label>Match Name Template *</label><input type="text" id="bulkName" class="form-input" placeholder="Daily Squad Battle"></div>
<div class="form-group"><label>Game Mode *</label><select id="bulkMode" class="form-input"><option value="solo">Solo</option><option value="duo">Duo</option><option value="squad" selected>Squad</option></select></div>
</div>
<div class="grid-2">
<div class="form-group"><label>Map</label><select id="bulkMap" class="form-input"><option>Bermuda</option><option>Kalahari</option><option>Purgatory</option><option>Alpine</option></select></div>
<div class="form-group"><label>Entry Type</label><select id="bulkEntryType" class="form-input"><option value="paid">Paid</option><option value="coin">Coin</option></select></div>
</div>
<div class="grid-3">
<div class="form-group"><label>Entry Fee (₹) *</label><input type="number" id="bulkFee" class="form-input" value="30"></div>
<div class="form-group"><label>Per Kill (₹) *</label><input type="number" id="bulkPerKill" class="form-input" value="10"></div>
<div class="form-group"><label>Max Slots *</label><input type="number" id="bulkSlots" class="form-input" value="12"></div>
</div>
<div class="grid-3">
<div class="form-group"><label>1st Prize</label><input type="number" id="bulkPrize1" class="form-input" value="0"></div>
<div class="form-group"><label>2nd Prize</label><input type="number" id="bulkPrize2" class="form-input" value="0"></div>
<div class="form-group"><label>3rd Prize</label><input type="number" id="bulkPrize3" class="form-input" value="0"></div>
</div>
<div class="grid-3">
<div class="form-group"><label>Start Date</label><input type="date" id="bulkStartDate" class="form-input"></div>
<div class="form-group"><label>Time Daily *</label><input type="time" id="bulkTime" class="form-input" value="20:00"></div>
<div class="form-group"><label>Days to Create *</label><input type="number" id="bulkDays" class="form-input" value="7" min="1" max="30"></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-ghost" onclick="previewBulkSchedule()"><i class="fas fa-eye"></i> Preview</button>
<button class="btn btn-ghost" onclick="closeBulkScheduler()">Cancel</button>
<button class="btn btn-primary" onclick="executeBulkCreate()"><i class="fas fa-calendar-plus"></i> Create Matches</button>
</div>
</div>
</div>

<!-- Screenshot Modal -->
<div class="modal-overlay" id="screenshotModal" onclick="closeModal('screenshotModal')">
<div class="modal" style="max-width:90vw;max-height:90vh;overflow:auto;background:transparent;border:none;box-shadow:none" onclick="event.stopPropagation()">
<img id="screenshotFullImg" style="width:100%;border-radius:10px">
</div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
/* =============================================
   FIREBASE CONFIG
   ============================================= */
const firebaseConfig={apiKey:"AIzaSyA-v9AYigDrg96D_fos0vOW3wU2GY2UYec",authDomain:"fft-app-1e283.firebaseapp.com",databaseURL:"https://fft-app-1e283-default-rtdb.firebaseio.com",projectId:"fft-app-1e283",storageBucket:"fft-app-1e283.appspot.com",messagingSenderId:"247829466483",appId:"1:247829466483:web:6961488f1d3c4e3fff4906"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),rtdb=firebase.database(),db=firebase.firestore();

/* =============================================
   DATABASE NODE CONSTANTS — SINGLE SOURCE OF TRUTH
   matches/ = where all tournament data lives (synced with User Panel)
   supportChats/{uid}/ = chat messages with senderId field
   ============================================= */
const DB_MATCHES='matches';         // was 'tournaments' — now synced with user panel
const DB_JOIN='joinRequests';
const DB_USERS='users';
const DB_WALLET='walletRequests';
const DB_PROFILE='profileRequests';
const DB_PROFILE_UPDATE='profileUpdateRequests';
const DB_TEAM='teamRequests';
const DB_CHAT='supportChats';
const DB_VOUCHERS='vouchers';

/* =============================================
   GLOBAL VARIABLES
   ============================================= */
let currentFilter='all',pendingRejectData=null,pendingWithdrawData=null,withdrawProofBase64=null,resultScreenshotBase64=null;
let usersSnapshot=null,usersCache={},activeChatUid=null,chatListener=null,currentTournamentData=null;
let allWalletRequests={},allTournaments={},allJoinRequests={};

/* =============================================
   HELPERS
   ============================================= */
function idTag(name,uid){
  const n=name||'Unknown',u=uid||'N/A';
  return '<div class="id-tag"><span class="id-name" title="'+n+'">'+n+'</span><span class="id-sep">|</span><span class="id-uid" title="'+u+'">'+(u.length>20?u.substring(0,20)+'…':u)+'</span></div>';
}
function slotBar(f,m){const p=m>0?Math.min((f/m)*100,100):0;const c=p>=100?'full':p>=75?'warn':'';return '<div class="slot-bar"><div class="slot-track"><div class="slot-fill '+c+'" style="width:'+p+'%"></div></div><span class="slot-text">'+f+'/'+m+'</span></div>';}

function showToast(msg,isErr){
  isErr=isErr||false;
  const c=document.getElementById('toastContainer'),t=document.createElement('div');
  t.className='toast '+(isErr?'error':'success');
  t.innerHTML='<div class="toast-icon"><i class="fas '+(isErr?'fa-times':'fa-check')+'"></i></div><div class="toast-msg">'+msg+'</div><button class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>';
  c.appendChild(t);
  requestAnimationFrame(function(){t.classList.add('show')});
  setTimeout(function(){t.classList.remove('show');setTimeout(function(){t.remove()},350)},3200);
  console.log((isErr?'ERR':'OK')+':',msg);
}

function getUid(obj){return obj.uid||obj.userId||obj.oderId||null;}

/* =============================================
   LOADING STATE FOR BUTTONS
   ============================================= */
function setLoading(btn,loading){
  if(!btn)return;
  if(loading){
    btn.classList.add('loading');
    btn.disabled=true;
    if(!btn.dataset.origHtml)btn.dataset.origHtml=btn.innerHTML;
    btn.innerHTML='<span class="btn-text">'+btn.dataset.origHtml+'</span>';
  }else{
    btn.classList.remove('loading');
    btn.disabled=false;
    if(btn.dataset.origHtml)btn.innerHTML=btn.dataset.origHtml;
  }
}

/* =============================================
   DUPLICATE DUO JOIN CHECK
   Checks if a user or their partner already joined a match
   ============================================= */
async function checkDuplicateDuoJoin(uid,matchId){
  try{
    var partnerSnap=await rtdb.ref(DB_USERS+'/'+uid+'/partnerUid').once('value');
    var partnerUid=partnerSnap.val();
    var joinSnap=await rtdb.ref(DB_JOIN).once('value');
    var found=false;
    joinSnap.forEach(function(c){
      var j=c.val();
      var tid=j.tournamentId||j.matchId;
      var jUid=getUid(j);
      var isJoined=(j.status==='approved'||j.status==='joined'||j.status==='confirmed'||!j.status);
      if(tid===matchId&&isJoined){
        if(jUid===uid){found='self';return;}
        if(partnerUid&&jUid===partnerUid){found='partner';return;}
      }
    });
    return found;
  }catch(e){console.error('checkDuplicateDuoJoin error:',e);return false;}
}

/* =============================================
   REFERRAL FRAUD CHECK
   Ensures referral code can only be used ONCE per user
   ============================================= */
async function checkReferralUsed(uid){
  try{
    var snap=await rtdb.ref(DB_USERS+'/'+uid+'/isReferralUsed').once('value');
    return snap.val()===true;
  }catch(e){return false;}
}
async function markReferralUsed(uid){
  try{await rtdb.ref(DB_USERS+'/'+uid+'/isReferralUsed').set(true);}catch(e){}
}

/* =============================================
   AUTH
   ============================================= */
auth.onAuthStateChanged(async function(u){
  console.log('Auth:',u?u.email:'null');
  if(u){
    try{
      const s=await rtdb.ref('admins/'+u.uid).once('value');
      if(s.exists()){
        document.getElementById('loginScreen').style.display='none';
        document.getElementById('loadingScreen').style.display='flex';
        document.getElementById('adminEmail').textContent=u.email;
        await initializeAdminPanel();
        document.getElementById('loadingScreen').style.display='none';
        document.getElementById('mainApp').style.display='block';
        setTimeout(function(){document.getElementById('mainApp').classList.add('show')},50);
      }else{showLoginError('Not admin');auth.signOut();}
    }catch(e){showLoginError('Error: '+e.message);auth.signOut();}
  }else{
    document.getElementById('loginScreen').style.display='flex';
    document.getElementById('loadingScreen').style.display='none';
    document.getElementById('mainApp').style.display='none';
    document.getElementById('mainApp').classList.remove('show');
  }
});
function handleLogin(e){e.preventDefault();const em=document.getElementById('loginEmail').value,pw=document.getElementById('loginPassword').value,btn=document.getElementById('loginBtn');btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Authenticating...';hideLoginError();auth.signInWithEmailAndPassword(em,pw).catch(function(er){showLoginError(er.message);btn.disabled=false;btn.innerHTML='<i class="fas fa-shield-halved"></i> Access Admin Panel';});}
function showLoginError(m){document.getElementById('loginErrorMsg').textContent=m;document.getElementById('loginError').classList.add('show');}
function hideLoginError(){document.getElementById('loginError').classList.remove('show');}
function logoutAdmin(){if(confirm('Logout?'))auth.signOut();}

/* =============================================
   INIT
   ============================================= */
async function initializeAdminPanel(){
  console.log('Init — using DB node: '+DB_MATCHES+'/ for matches');
  setupProfileListener();
  setupProfileUpdateListener();
  setupUsersListener();
  setupWalletListener();
  setupRealtimeListeners();
  loadMaintenanceState();
  setTimeout(function(){
    if(window.initLiveDashboard)initLiveDashboard();
    if(window.initWithdrawalQueue)initWithdrawalQueue();
  },1000);
  await Promise.all([refreshDashboard(),loadTournaments(),loadTeamRequests(),loadSupportChats(),loadSettings(),loadVouchers()]);
  setInterval(syncTournamentStatuses,30000);
  setInterval(sendScheduledReminders,300000);
  
  /* Initialize back button history management */
  initHistoryState();
  
  console.log('Ready — all listeners active, history initialized');
}

/* =============================================
   GLOBAL SEARCH
   ============================================= */
function handleGlobalSearch(q){
  var res=document.getElementById('globalSearchResults');
  if(!q||q.length<2||!usersSnapshot){res.classList.remove('show');return;}
  q=q.toLowerCase();var html='',c=0;
  usersSnapshot.forEach(function(ch){
    if(c>=8)return;
    var u=ch.val(),uid=ch.key,ign=u.ign||'N/A',ffUid=u.ffUid||'';
    if(ign.toLowerCase().indexOf(q)>=0||uid.toLowerCase().indexOf(q)>=0||ffUid.toLowerCase().indexOf(q)>=0){
      c++;var init=(ign||'U').charAt(0).toUpperCase();var isBanned=u.isBanned||u.blocked;
      html+='<div class="search-result-item" onmousedown="openUserModal(\''+uid+'\');document.getElementById(\'globalSearchResults\').classList.remove(\'show\');document.getElementById(\'globalSearchInput\').value=\'\';"><div class="sr-avatar">'+init+'</div><div class="sr-info"><div class="sr-name">'+ign+(isBanned?' <span class="badge red">Banned</span>':'')+'</div><div class="sr-uid">'+uid+'</div></div></div>';
    }
  });
  if(c===0)html='<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:11px">No users found</div>';
  res.innerHTML=html;res.classList.add('show');
}

/* =============================================
   REALTIME BADGE LISTENERS
   ============================================= */
function setupRealtimeListeners(){
  rtdb.ref(DB_PROFILE).on('value',function(s){var c=0;s.forEach(function(x){if(!x.val().status||x.val().status==='pending')c++;});updateBadge('profileBadge',c);});
  rtdb.ref(DB_WALLET).on('value',function(s){var c=0;s.forEach(function(x){if(x.val().status==='pending')c++;});updateBadge('walletBadge',c);});
  rtdb.ref(DB_TEAM).on('value',function(s){var c=0;s.forEach(function(x){if(x.val().status==='pending')c++;});updateBadge('teamBadge',c);});

  /* CHAT BADGE — uses senderId (not sender) to detect non-admin messages
     Checks BOTH supportChats/ and support/ paths
  */
  function updateChatBadge(){
    var totalUnread=0;
    
    Promise.all([
      rtdb.ref(CHAT_PATH_PRIMARY).once('value'),
      rtdb.ref(CHAT_PATH_SECONDARY).once('value')
    ]).then(function(results){
      results.forEach(function(s){
        if(s.exists()){
          s.forEach(function(u){
            u.forEach(function(m){
              var mv=m.val();
              /* Check BOTH senderId and sender for backward compat */
              var isAdmin=(mv.senderId==='admin'||mv.sender==='admin');
              if(!isAdmin&&!mv.read)totalUnread++;
            });
          });
        }
      });
      
      updateBadge('supportBadge',totalUnread);
      var el=document.getElementById('supportNavItem');
      if(totalUnread>0)el.classList.add('has-unread');else el.classList.remove('has-unread');
    });
  }
  
  /* Listen to both chat paths for badge updates */
  rtdb.ref(CHAT_PATH_PRIMARY).on('value',function(){updateChatBadge();});
  rtdb.ref(CHAT_PATH_SECONDARY).on('value',function(){updateChatBadge();});

  rtdb.ref(DB_PROFILE_UPDATE).on('value',function(s){var c=0;s.forEach(function(x){if(!x.val().status||x.val().status==='pending')c++;});updateBadge('profileUpdateBadge',c);});
}
function updateBadge(id,c){var e=document.getElementById(id);if(!e)return;if(c>0){e.textContent=c;e.style.display='flex';}else e.style.display='none';}

/* =============================================
   PROFILE VERIFICATION
   ============================================= */
function setupProfileListener(){rtdb.ref(DB_PROFILE).on('value',function(s){renderProfileRequests(s)});}
function renderProfileRequests(snap){
  var tb=document.getElementById('profileRequestsTable');tb.innerHTML='';var c=0;var rows=[];
  snap.forEach(function(ch){
    var d=ch.val(),id=ch.key,p=!d.status||d.status==='pending';
    // Banned users still show here but with indicator - admin can see and manage
    var isBanned = usersCache[d.uid||d.userId] && (usersCache[d.uid||d.userId].isBanned||usersCache[d.uid||d.userId].blocked);
    // Don't skip - show with ban indicator
    if(p)c++;rows.push({id:id,d:d,pending:p});
  });
  rows.sort(function(a,b){return a.pending===b.pending?0:a.pending?-1:1});
  rows.forEach(function(r){
    var d=r.d,id=r.id,pending=r.pending;
    var uid=getUid(d)||'N/A';
    /* ═══ SOURCE OF TRUTH: profileRequests/ node ═══
       Check ALL possible field names the User Panel might use */
    var proposedIgn=d.requestedIgn||d.ign||d.username||d.newIgn||d.newUsername||d.playerName||d.gameName||'N/A';
    var proposedFfUid=d.requestedUid||d.requestedFfUid||d.ffUid||d.gameUid||d.newFfUid||d.newUid||d.gameId||d.freeFireUid||'N/A';
    var proposedPhone=d.phone||d.newPhone||d.mobileNumber||d.mobile||'';
    var date=d.createdAt?new Date(d.createdAt).toLocaleDateString():'N/A';
    var status=d.status||'pending';
    var sb=status==='approved'?'green':status==='rejected'?'red':'yellow';
    
    /* Smart display name: request data FIRST (new unverified users), then cache */
    var currentUser=usersCache[uid]||{};
    var displayName=d.displayName||d.userName||d.name||d.requestedIgn||currentUser.displayName||currentUser.name||d.ign||d.username||'Unknown';
    if(isBanned) displayName = '🚫 ' + displayName;
    
    /* Debug: Log what we found in the request */
    if(pending)console.log('Profile Request '+id+': uid='+uid+', ign='+proposedIgn+', ffUid='+proposedFfUid+', raw keys='+Object.keys(d).join(','));
    
    var acts=pending?'<button class="btn btn-primary btn-xs" onclick="approveProfile(\''+id+'\')" title="Approve — writes IGN & FF UID to users/{uid}"><i class="fas fa-check"></i> Approve</button> <button class="btn btn-danger btn-xs" onclick="openRejectModal(\'profile\',\''+id+'\')"><i class="fas fa-times"></i> Reject</button>':'<span class="text-xxs text-muted">'+status+'</span>';
    
    tb.innerHTML+='<tr>'+
      /* Col 1: User Name */
      '<td><div style="white-space:nowrap;font-size:13px;font-weight:700">'+displayName+'</div><div class="font-mono text-xxs" style="color:var(--info);cursor:pointer;margin-top:2px" title="Click to copy" onclick="navigator.clipboard&&navigator.clipboard.writeText(\''+uid+'\').then(function(){showToast(\'UID copied!\')})">'+uid.substring(0,16)+'... <i class="fas fa-copy" style="font-size:8px;opacity:.5"></i></div></td>'+
      /* Col 3: Requested IGN — the IGN user wants */
      '<td><div class="proposed-val"><i class="fas fa-gamepad"></i> '+proposedIgn+'</div><div class="text-xxs text-muted mt-1">Will be set as IGN</div></td>'+
      /* Col 4: Requested FF UID — the FF UID user wants */
      '<td><div class="proposed-val"><i class="fas fa-fingerprint"></i> '+proposedFfUid+'</div><div class="text-xxs text-muted mt-1">Will be set as FF UID</div></td>'+
      /* Col 5: Phone */
      '<td class="text-xxs font-mono">'+(proposedPhone||'<span class="text-muted">—</span>')+'</td>'+
      /* Col 6: Date */
      '<td class="text-xxs">'+date+'</td>'+
      /* Col 7: Status */
      '<td><span class="badge '+sb+'">'+status+'</span></td>'+
      /* Col 8: Actions */
      '<td>'+acts+'</td>'+
    '</tr>';
  });
  document.getElementById('profileCount').textContent=c;
  if(rows.length===0){
    tb.innerHTML='<tr><td colspan="8" class="text-muted text-xs" style="text-align:center;padding:20px"><i class="fas fa-user-check" style="font-size:20px;opacity:0.3;display:block;margin-bottom:6px"></i>No new verification requests</td></tr>';
  }
}

async function approveProfile(rid){
  console.log('═══════════════════════════════');
  console.log('APPROVE PROFILE REQUEST: '+rid);
  /* Disable the button that was clicked to prevent double-clicks */
  if(event&&event.target){var clickedBtn=event.target.closest('.btn');if(clickedBtn){clickedBtn.disabled=true;clickedBtn.style.opacity='0.5';clickedBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';}}
  try{
    /* STEP 1: Read the profile request */
    var rs=await rtdb.ref(DB_PROFILE+'/'+rid).once('value');
    if(!rs.exists()){showToast('Request not found!',true);return;}
    var r=rs.val();
    var uid=getUid(r);
    if(!uid){showToast('UID missing in request! Cannot approve.',true);return;}
    
    /* STEP 2: Read pending profile data (if any) */
    var ps=await rtdb.ref(DB_USERS+'/'+uid+'/pendingProfile').once('value');
    var p=ps.val()||{};
    
    /* STEP 3: Get current user data for comparison */
    var currentSnap=await rtdb.ref(DB_USERS+'/'+uid).once('value');
    var currentUser=currentSnap.val()||{};
    
    /* STEP 4: Determine proposed values — check ALL possible field names
       Source: profileRequests/ node FIRST, then pendingProfile, then current user */
    var proposedIgn=r.requestedIgn||r.ign||r.username||r.newIgn||r.newUsername||r.playerName||r.gameName||p.ign||p.username||p.requestedIgn||'';
    var proposedFfUid=r.requestedUid||r.requestedFfUid||r.ffUid||r.gameUid||r.newFfUid||r.newUid||r.gameId||r.freeFireUid||p.ffUid||p.gameUid||p.requestedFfUid||'';
    var proposedPhone=r.phone||r.newPhone||r.mobileNumber||r.mobile||p.phone||'';
    var proposedAvatar=r.avatar||r.newAvatar||r.profileImage||r.photo||p.avatar||'';
    
    console.log('Request raw data keys: '+Object.keys(r).join(', '));
    
    console.log('Current User Data:');
    console.log('  IGN: '+(currentUser.ign||'NOT SET'));
    console.log('  FF UID: '+(currentUser.ffUid||'NOT SET'));
    console.log('  Phone: '+(currentUser.phone||'NOT SET'));
    console.log('Proposed (from request):');
    console.log('  IGN: '+(proposedIgn||'NOT PROVIDED'));
    console.log('  FF UID: '+(proposedFfUid||'NOT PROVIDED'));
    console.log('  Phone: '+(proposedPhone||'NOT PROVIDED'));
    
    /* STEP 5: Validate uniqueness — IGN must be unique */
    if(proposedIgn){
      var allUsers=await rtdb.ref(DB_USERS).once('value');
      var ignDup=false;
      allUsers.forEach(function(u){
        if(u.key!==uid&&u.val().ign&&u.val().ign.toLowerCase()===proposedIgn.toLowerCase()){
          ignDup=true;
          console.log('❌ IGN DUPLICATE found: "'+proposedIgn+'" already used by '+u.key);
        }
      });
      if(ignDup){showToast('❌ IGN "'+proposedIgn+'" is already taken by another user!',true);return;}
      console.log('✅ IGN "'+proposedIgn+'" is unique');
    }
    
    /* STEP 6: Validate uniqueness — Phone must be unique */
    if(proposedPhone){
      var allUsers2=await rtdb.ref(DB_USERS).once('value');
      var phoneDup=false;
      allUsers2.forEach(function(u){
        if(u.key!==uid&&u.val().phone&&u.val().phone===proposedPhone)phoneDup=true;
      });
      if(phoneDup){showToast('❌ Phone "'+proposedPhone+'" already used by another user!',true);return;}
      console.log('✅ Phone is unique');
    }
    
    /* STEP 7: Validate FF UID — must be unique in ffUIDIndex */
    if(proposedFfUid){
      var fi=await rtdb.ref('ffUIDIndex/'+proposedFfUid).once('value');
      if(fi.exists()&&fi.val()!==uid){
        showToast('❌ FF UID "'+proposedFfUid+'" is already linked to another user!',true);
        return;
      }
      console.log('✅ FF UID is unique or belongs to same user');
    }
    
    /* STEP 8: Build the update object — ONLY include fields that have values */
    var userData={
      approved:true,
      accessMode:'FULL',
      profileVerified:true,
      profileStatus:'verified',
      profile_status:'APPROVED',
      profileUpdatePending:false,
      status:'active',
      pendingProfile:null
    };
    
    /* CRITICAL: Update IGN and FF UID in user node */
    if(proposedIgn){
      userData.ign=proposedIgn;
      console.log('📝 Will set users/'+uid+'/ign = "'+proposedIgn+'"');
    }
    if(proposedFfUid){
      userData.ffUid=proposedFfUid;
      console.log('📝 Will set users/'+uid+'/ffUid = "'+proposedFfUid+'"');
    }
    if(proposedAvatar){
      userData.avatar=proposedAvatar;
      console.log('📝 Will set users/'+uid+'/avatar');
    }
    if(proposedPhone){
      userData.phone=proposedPhone;
      console.log('📝 Will set users/'+uid+'/phone = "'+proposedPhone+'"');
    }
    
    /* STEP 9: WRITE to users/{uid} — this is the CRITICAL update */
    await rtdb.ref(DB_USERS+'/'+uid).update(userData);
    console.log('✅ User node updated at users/'+uid);
    
    /* STEP 10: Update FF UID index */
    if(proposedFfUid){
      /* Remove old FF UID from index if it changed */
      if(currentUser.ffUid&&currentUser.ffUid!==proposedFfUid){
        await rtdb.ref('ffUIDIndex/'+currentUser.ffUid).remove();
        console.log('🗑️ Removed old ffUIDIndex/'+currentUser.ffUid);
      }
      await rtdb.ref('ffUIDIndex/'+proposedFfUid).set(uid);
      console.log('✅ Updated ffUIDIndex/'+proposedFfUid+' = '+uid);
    }
    
    /* STEP 11: Update the request status (NEVER delete, always update) */
    await rtdb.ref(DB_PROFILE+'/'+rid).update({
      status:'approved',
      processedAt:Date.now(),
      processedBy:auth.currentUser.uid,
      approvedIgn:proposedIgn,
      approvedFfUid:proposedFfUid
    });
    console.log('✅ Request status updated to approved');
    
    /* STEP 12: Send notification to user */
    await rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({
      title:'Profile Approved! ✅',
      message:'Your profile has been verified. IGN: '+(proposedIgn||'unchanged')+', FF UID: '+(proposedFfUid||'unchanged'),
      timestamp:Date.now(),
      createdAt:Date.now(),
      read:false,
      type:'profile_approved'
    });
    
    /* STEP 13: Log the action */
    await rtdb.ref('activityLogs').push({
      type:'profile_approved',
      uid:uid,
      requestId:rid,
      proposedIgn:proposedIgn,
      proposedFfUid:proposedFfUid,
      previousIgn:currentUser.ign||null,
      previousFfUid:currentUser.ffUid||null,
      admin:auth.currentUser.uid,
      timestamp:Date.now()
    });
    
    console.log('═══════════════════════════════');
    console.log('✅ PROFILE APPROVED SUCCESSFULLY');
    console.log('  User: '+uid);
    console.log('  IGN: '+(currentUser.ign||'none')+' → '+(proposedIgn||'unchanged'));
    console.log('  FF UID: '+(currentUser.ffUid||'none')+' → '+(proposedFfUid||'unchanged'));
    console.log('═══════════════════════════════');
    
    showToast('✅ Profile approved! IGN: '+(proposedIgn||'N/A')+', FF: '+(proposedFfUid||'N/A'));
  }catch(e){
    console.error('approveProfile error:',e);
    showToast('Error: '+e.message,true);
  }
}

/* =============================================
   PROFILE UPDATES
   ============================================= */
function setupProfileUpdateListener(){rtdb.ref(DB_PROFILE_UPDATE).on('value',function(s){renderProfileUpdates(s)});}
function renderProfileUpdates(snap){
  var tb=document.getElementById('profileUpdateTable');tb.innerHTML='';var c=0;var rows=[];
  snap.forEach(function(ch){var d=ch.val(),id=ch.key,ip=!d.status||d.status==='pending';if(ip)c++;rows.push({id:id,d:d,pending:ip});});
  rows.sort(function(a,b){return a.pending===b.pending?0:a.pending?-1:1});
  rows.forEach(function(r){
    var d=r.d,id=r.id,ip=r.pending;
    var uid=getUid(d)||'N/A';
    /* ═══ SOURCE OF TRUTH: profileUpdateRequests/ node ═══ */
    var newIgn=d.requestedIgn||d.newIgn||d.ign||d.newUsername||d.username||d.playerName||'';
    var newFfUid=d.requestedUid||d.requestedFfUid||d.newFfUid||d.ffUid||d.newUid||d.gameUid||d.gameId||'';
    var date=d.createdAt?new Date(d.createdAt).toLocaleDateString():'N/A';
    var st=d.status||'pending';
    var sb=st==='approved'?'green':st==='rejected'?'red':'yellow';
    
    /* Get current user data from cache for comparison */
    var currentUser=usersCache[uid]||{};
    var currentIgn=currentUser.ign||'Not set';
    var currentFfUid=currentUser.ffUid||'Not set';
    var displayName=d.displayName||d.userName||d.name||d.requestedIgn||currentUser.ign||currentUser.displayName||currentUser.name||d.newIgn||d.ign||'Unknown';
    
    /* Debug: Log what we found */
    if(ip)console.log('Profile Update '+id+': uid='+uid+', newIgn='+newIgn+', newFfUid='+newFfUid+', raw keys='+Object.keys(d).join(','));
    
    /* Check what changed */
    var ignChanged=(newIgn&&newIgn!==currentIgn);
    var ffChanged=(newFfUid&&newFfUid!==currentFfUid);
    
    var acts=ip?'<button class="btn btn-primary btn-xs" onclick="approveProfileUpdate(\''+id+'\')" title="Approve — overwrites current IGN/FF UID"><i class="fas fa-check"></i> Approve</button> <button class="btn btn-danger btn-xs" onclick="openRejectModal(\'profileUpdate\',\''+id+'\')"><i class="fas fa-times"></i> Reject</button>':'<span class="text-xxs text-muted">'+st+'</span>';
    
    tb.innerHTML+='<tr>'+
      /* Col 1: User Name */
      '<td><strong class="text-sm">'+displayName+'</strong><div class="text-xxs text-muted mt-1"><i class="fas fa-user-shield" style="font-size:8px;color:var(--primary)"></i> Verified User</div></td>'+
      /* Col 2: User UID — FULL, always visible */
      '<td><div class="font-mono text-xxs" style="color:var(--info);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:130px;cursor:pointer" title="Click to copy" onclick="navigator.clipboard&&navigator.clipboard.writeText(\''+uid+'\').then(function(){showToast(\'UID copied!\')})">'+uid+'</div><div class="text-xxs text-muted mt-1"><i class="fas fa-copy" style="font-size:8px;opacity:.5;margin-left:3px"></i></div></td>'+
      /* Col 3: Current IGN */
      '<td><span class="text-xs font-bold">'+currentIgn+'</span></td>'+
      /* Col 4: Current FF UID */
      '<td class="font-mono text-xxs">'+currentFfUid+'</td>'+
      /* Col 5: → New IGN */
      '<td>'+(newIgn?'<div class="proposed-val'+(ignChanged?' warning':'')+'"><i class="fas '+(ignChanged?'fa-arrow-right':'fa-equals')+'"></i> '+newIgn+'</div>'+(ignChanged?'<div class="text-xxs text-muted mt-1"><s>'+currentIgn+'</s> → <b class="text-primary">'+newIgn+'</b></div>':'<div class="text-xxs text-muted">No change</div>'):'<span class="text-muted text-xxs">—</span>')+'</td>'+
      /* Col 6: → New FF UID */
      '<td>'+(newFfUid?'<div class="proposed-val'+(ffChanged?' warning':'')+'"><i class="fas '+(ffChanged?'fa-arrow-right':'fa-equals')+'"></i> '+newFfUid+'</div>'+(ffChanged?'<div class="text-xxs text-muted mt-1"><s>'+currentFfUid+'</s> → <b class="text-primary">'+newFfUid+'</b></div>':'<div class="text-xxs text-muted">No change</div>'):'<span class="text-muted text-xxs">—</span>')+'</td>'+
      /* Col 7: Date */
      '<td class="text-xxs">'+date+'</td>'+
      /* Col 8: Status */
      '<td><span class="badge '+sb+'">'+st+'</span></td>'+
      /* Col 9: Actions */
      '<td>'+acts+'</td>'+
    '</tr>';
  });
  document.getElementById('profileUpdateCount').textContent=c;
  if(rows.length===0){
    tb.innerHTML='<tr><td colspan="9" class="text-muted text-xs" style="text-align:center;padding:20px"><i class="fas fa-user-edit" style="font-size:20px;opacity:0.3;display:block;margin-bottom:6px"></i>No profile update requests</td></tr>';
  }
}
async function approveProfileUpdate(rid){
  console.log('═══════════════════════════════');
  console.log('APPROVE PROFILE UPDATE: '+rid);
  /* Disable button to prevent double-clicks */
  if(event&&event.target){var clickedBtn=event.target.closest('.btn');if(clickedBtn){clickedBtn.disabled=true;clickedBtn.style.opacity='0.5';clickedBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';}}
  try{
    var rs=await rtdb.ref(DB_PROFILE_UPDATE+'/'+rid).once('value');
    if(!rs.exists()){showToast('Request not found!',true);return;}
    var r=rs.val();
    var uid=getUid(r);
    if(!uid){showToast('UID missing in request!',true);return;}
    
    /* Get proposed values — check ALL possible field names from request */
    var newIgn=r.requestedIgn||r.newIgn||r.ign||r.newUsername||r.username||r.playerName||r.gameName||'';
    var newFfUid=r.requestedUid||r.requestedFfUid||r.newFfUid||r.ffUid||r.newUid||r.gameUid||r.gameId||r.freeFireUid||'';
    var newAvatar=r.newAvatar||r.avatar||r.profileImage||r.photo||'';
    var newPhone=r.newPhone||r.phone||r.mobileNumber||r.mobile||'';
    
    console.log('Profile Update request raw keys: '+Object.keys(r).join(', '));
    
    /* Get current user data */
    var currentSnap=await rtdb.ref(DB_USERS+'/'+uid).once('value');
    var currentUser=currentSnap.val()||{};
    
    console.log('Current: IGN="'+(currentUser.ign||'')+'", FF="'+(currentUser.ffUid||'')+'"');
    console.log('New: IGN="'+newIgn+'", FF="'+newFfUid+'"');
    
    /* Validate IGN uniqueness */
    if(newIgn){
      var allUsers=await rtdb.ref(DB_USERS).once('value');
      var dup=false;
      allUsers.forEach(function(u){
        if(u.key!==uid&&u.val().ign&&u.val().ign.toLowerCase()===newIgn.toLowerCase())dup=true;
      });
      if(dup){showToast('❌ IGN "'+newIgn+'" already taken!',true);return;}
    }
    
    /* Build update object */
    var upd={profileUpdatePending:false};
    
    /* CRITICAL: Update IGN in user node */
    if(newIgn){
      upd.ign=newIgn;
      console.log('📝 Setting users/'+uid+'/ign = "'+newIgn+'" (was "'+currentUser.ign+'")');
    }
    
    /* CRITICAL: Update FF UID in user node + ffUIDIndex */
    if(newFfUid){
      /* Remove old FF UID from index if changed */
      var oldFf=currentUser.ffUid;
      if(oldFf&&oldFf!==newFfUid){
        await rtdb.ref('ffUIDIndex/'+oldFf).remove();
        console.log('🗑️ Removed old ffUIDIndex/'+oldFf);
      }
      upd.ffUid=newFfUid;
      await rtdb.ref('ffUIDIndex/'+newFfUid).set(uid);
      console.log('📝 Setting users/'+uid+'/ffUid = "'+newFfUid+'" + ffUIDIndex');
    }
    
    if(newAvatar){upd.avatar=newAvatar;console.log('📝 Updating avatar');}
    if(newPhone){upd.phone=newPhone;console.log('📝 Setting phone = "'+newPhone+'"');}
    
    /* WRITE to user node FIRST */
    await rtdb.ref(DB_USERS+'/'+uid).update(upd);
    console.log('✅ User node updated');
    
    /* Then update request status (NEVER delete) */
    await rtdb.ref(DB_PROFILE_UPDATE+'/'+rid).update({
      status:'approved',
      processedAt:Date.now(),
      processedBy:auth.currentUser.uid,
      approvedIgn:newIgn,
      approvedFfUid:newFfUid
    });
    
    /* Notify user */
    var changeMsg=[];
    if(newIgn)changeMsg.push('IGN → '+newIgn);
    if(newFfUid)changeMsg.push('FF UID → '+newFfUid);
    
    await rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({
      title:'Profile Updated! ✅',
      message:'Your profile update was approved. '+(changeMsg.length>0?changeMsg.join(', '):''),
      timestamp:Date.now(),
      createdAt:Date.now(),
      read:false,
      type:'profile_update_approved'
    });
    
    /* Log action */
    await rtdb.ref('activityLogs').push({
      type:'profile_update_approved',
      uid:uid,
      requestId:rid,
      changes:{newIgn:newIgn,newFfUid:newFfUid,oldIgn:currentUser.ign||null,oldFfUid:currentUser.ffUid||null},
      admin:auth.currentUser.uid,
      timestamp:Date.now()
    });
    
    console.log('✅ Profile update approved!');
    console.log('═══════════════════════════════');
    showToast('✅ Profile update approved! '+(changeMsg.join(', ')||''));
  }catch(e){
    console.error('approveProfileUpdate error:',e);
    showToast('Error: '+e.message,true);
  }
}

/* =============================================
   USERS
   ============================================= */
function setupUsersListener(){rtdb.ref(DB_USERS).on('value',function(s){usersSnapshot=s;usersCache={};s.forEach(function(c){usersCache[c.key]=c.val();});renderUsers();});}
/* getUserName — Smart fallback: ign → displayName → name → email prefix → UID truncated */
function getUserName(uid){
  if(!uid)return 'Unknown';
  var u=usersCache[uid];
  if(!u)return uid.substring(0,10);
  return u.ign||u.displayName||u.name||u.userName||(u.email?u.email.split('@')[0]:null)||uid.substring(0,10);
}
/* getUserInfo — Get full user identity info for display */
function getUserInfo(uid){
  var u=usersCache[uid]||{};
  return {
    name:u.ign||u.displayName||u.name||u.userName||'Unknown',
    ffUid:u.ffUid||'N/A',
    phone:u.phone||'',
    email:u.email||'',
    level:u.level||1,
    verified:u.profileVerified||false,
    banned:u.isBanned||u.blocked||false
  };
}
function renderUsers(){
  if(!usersSnapshot)return;var tb=document.getElementById('usersTable'),q=(document.getElementById('searchUser').value||'').toLowerCase();tb.innerHTML='';var c=0;
  usersSnapshot.forEach(function(ch){
    var u=ch.val(),uid=ch.key,ign=u.ign||'N/A',ff=u.ffUid||'N/A';
    if(q&&ign.toLowerCase().indexOf(q)<0&&ff.toLowerCase().indexOf(q)<0&&uid.toLowerCase().indexOf(q)<0)return;c++;
    var db_=u.wallet?u.wallet.depositBalance||0:u.realMoney?u.realMoney.deposited||0:0;
    var wb=u.wallet?u.wallet.winningBalance||0:u.realMoney?u.realMoney.winnings||0:0;
    var bal=db_+wb,mt=u.stats?u.stats.matches||0:0,lv=u.level||1,bn=u.isBanned||u.blocked;
    var st=bn?'<span class="badge red">Banned</span>':u.approved?'<span class="badge green">Active</span>':'<span class="badge yellow">Pending</span>';
    tb.innerHTML+='<tr><td>'+idTag(ign,uid)+'<div class="text-xxs text-muted mt-1 font-mono" style="word-break:break-all;max-width:160px">FF: '+ff+'</div></td><td><span class="text-primary font-bold">₹'+bal+'</span><div class="text-xxs text-muted">D:₹'+db_+' W:₹'+wb+'</div></td><td>'+mt+'</td><td><span class="badge cyan">Lv'+lv+'</span></td><td>'+st+'</td><td class="flex gap-1 flex-wrap"><button class="btn btn-ghost btn-xs" onclick="openUserModal(\''+uid+'\')"><i class="fas fa-eye"></i></button> '+(bn?'<button class="btn btn-primary btn-xs" onclick="unbanUser(\''+uid+'\')"><i class="fas fa-unlock"></i></button>':'<button class="btn btn-warning btn-xs" onclick="banUser(\''+uid+'\')"><i class="fas fa-ban"></i></button>')+' <button class="btn btn-ghost btn-xs" style="color:var(--warning)" onclick="window.showAddNote&&showAddNote(\''+uid+'\',\''+ign+'\')" title="Add Note"><i class="fas fa-sticky-note"></i></button> <button class="btn btn-danger btn-xs" onclick="deleteUser(\''+uid+'\')"><i class="fas fa-trash"></i></button></td></tr>';
  });
  document.getElementById('userCount').textContent=c;
}

async function openUserModal(uid){
  var sn=await rtdb.ref(DB_USERS+'/'+uid).once('value');if(!sn.exists())return showToast('Not found',true);var u=sn.val();
  document.getElementById('userModalName').textContent=(u.ign||'Unknown');var bd=document.getElementById('userModalBody');
  var db_=u.wallet?u.wallet.depositBalance||0:u.realMoney?u.realMoney.deposited||0:0;
  var wb=u.wallet?u.wallet.winningBalance||0:u.realMoney?u.realMoney.winnings||0:0;
  var lv=u.level||1,xp=u.exp||0,mx=lv*100,pct=Math.min((xp/mx)*100,100),ref=u.referralCount||u.referrals||0;
  var mh='<p class="text-muted text-xs">No match history</p>';
  var ms=await rtdb.ref('userMatches/'+uid+'/matches').limitToLast(10).once('value');
  if(ms.exists()){mh='<div class="table-wrapper" style="max-height:180px"><table><thead><tr><th>Match</th><th>Rank</th><th>Kills</th><th>Reward</th></tr></thead><tbody>';ms.forEach(function(m){var d=m.val(),tn=allTournaments[m.key]?allTournaments[m.key].name:m.key.substring(0,10);mh+='<tr><td class="text-xs">'+tn+'</td><td>#'+(d.rank||'—')+'</td><td>'+(d.kills||0)+'</td><td class="text-primary">₹'+(d.reward||0)+'</td></tr>';});mh+='</tbody></table></div>';}
  bd.innerHTML='<div class="flex items-center gap-3 mb-3"><div class="chat-avatar" style="width:44px;height:44px;font-size:16px">'+(u.ign||'U').charAt(0).toUpperCase()+'</div><div><div class="font-bold" style="font-size:14px">'+(u.ign||'N/A')+'</div><div class="text-xxs text-muted font-mono">'+uid+'</div><div class="text-xxs text-dim">FF: '+(u.ffUid||'N/A')+' | Ph: '+(u.phone||'N/A')+'</div></div></div><div class="detail-tabs"><div class="detail-tab active" onclick="switchTab(this,\'to_'+uid+'\')">Overview</div><div class="detail-tab" onclick="switchTab(this,\'th_'+uid+'\')">History</div><div class="detail-tab" onclick="switchTab(this,\'tl_'+uid+'\')">Level</div></div><div class="detail-panel active" id="to_'+uid+'"><div class="user-stat-row"><div class="stat-label"><i class="fas fa-wallet"></i> Deposit</div><div class="stat-val text-primary">₹'+db_+'</div></div><div class="user-stat-row"><div class="stat-label"><i class="fas fa-trophy"></i> Winning</div><div class="stat-val text-primary">₹'+wb+'</div></div><div class="user-stat-row"><div class="stat-label"><i class="fas fa-gamepad"></i> Matches</div><div class="stat-val">'+(u.stats?u.stats.matches||0:0)+'</div></div><div class="user-stat-row"><div class="stat-label"><i class="fas fa-crown"></i> Wins</div><div class="stat-val">'+(u.stats?u.stats.wins||0:0)+'</div></div><div class="user-stat-row"><div class="stat-label"><i class="fas fa-crosshairs"></i> Kills</div><div class="stat-val">'+(u.totalKills||(u.stats?u.stats.kills||0:0))+'</div></div><div class="user-stat-row"><div class="stat-label"><i class="fas fa-coins"></i> Earnings</div><div class="stat-val text-primary">₹'+(u.totalWinnings||(u.stats?u.stats.earnings||0:0))+'</div></div><div class="user-stat-row"><div class="stat-label"><i class="fas fa-users"></i> Referrals</div><div class="stat-val">'+ref+'</div></div><div class="user-stat-row"><div class="stat-label"><i class="fas fa-shield-halved"></i> Profile</div><div class="stat-val">'+(u.profileVerified?'<span class="badge green">Verified</span>':'<span class="badge yellow">Unverified</span>')+'</div></div></div><div class="detail-panel" id="th_'+uid+'">'+mh+'</div><div class="detail-panel" id="tl_'+uid+'"><div class="user-stat-row"><div class="stat-label"><i class="fas fa-star"></i> Level</div><div class="stat-val"><span class="badge cyan">Lv '+lv+'</span></div></div><div class="mb-3"><div class="flex justify-between text-xxs mb-1"><span class="text-dim">EXP</span><span class="text-primary">'+xp+'/'+mx+'</span></div><div class="exp-bar"><div class="exp-fill" style="width:'+pct+'%"></div></div></div><div class="grid-2 mt-3"><div class="form-group"><label>Level</label><input type="number" id="eL_'+uid+'" class="form-input" value="'+lv+'" min="1"></div><div class="form-group"><label>EXP</label><input type="number" id="eX_'+uid+'" class="form-input" value="'+xp+'" min="0"></div></div><button class="btn btn-primary btn-sm" onclick="saveUserLevel(\''+uid+'\')"><i class="fas fa-save"></i> Save</button></div>';
  var ft=document.getElementById('userModalFooter'),bn=u.isBanned||u.blocked;
  ft.innerHTML=(bn?'<button class="btn btn-primary btn-sm" onclick="unbanUser(\''+uid+'\');closeModal(\'userModal\')"><i class="fas fa-unlock"></i> Unban</button>':'<button class="btn btn-warning btn-sm" onclick="banUser(\''+uid+'\');closeModal(\'userModal\')"><i class="fas fa-ban"></i> Ban</button>')+' <button class="btn btn-danger btn-sm" onclick="deleteUser(\''+uid+'\');closeModal(\'userModal\')"><i class="fas fa-trash"></i> Delete</button> <button class="btn btn-ghost btn-sm" onclick="closeModal(\'userModal\')">Close</button>';
  document.getElementById('userModal').classList.add('show');
}
function switchTab(el,pid){el.parentElement.querySelectorAll('.detail-tab').forEach(function(t){t.classList.remove('active')});el.classList.add('active');el.closest('.modal-body').querySelectorAll('.detail-panel').forEach(function(p){p.classList.remove('active')});document.getElementById(pid).classList.add('active');}
async function saveUserLevel(uid){var lv=Number(document.getElementById('eL_'+uid).value)||1,xp=Number(document.getElementById('eX_'+uid).value)||0;try{await rtdb.ref(DB_USERS+'/'+uid).update({level:lv,exp:xp});showToast('Level updated!');}catch(e){showToast('Error: '+e.message,true);}}
async function banUser(uid){var r=prompt('Ban reason:');if(!r)return;try{await rtdb.ref(DB_USERS+'/'+uid).update({isBanned:true,blocked:true,status:'banned',banReason:r,bannedAt:Date.now()});await rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({title:'Account Banned ⛔',message:'Reason: '+r,timestamp:Date.now(),read:false});showToast('User banned');}catch(e){showToast('Error: '+e.message,true);}}
async function unbanUser(uid){if(!confirm('Unban?'))return;try{await rtdb.ref(DB_USERS+'/'+uid).update({isBanned:false,blocked:false,status:'active',banReason:null,bannedAt:null});showToast('User unbanned');}catch(e){showToast('Error: '+e.message,true);}}
async function deleteUser(uid){if(!confirm('DELETE permanently?'))return;try{var s=await rtdb.ref(DB_USERS+'/'+uid).once('value');var ff=s.val()?s.val().ffUid:null;await rtdb.ref(DB_USERS+'/'+uid).remove();await rtdb.ref('userMatches/'+uid).remove();if(ff)await rtdb.ref('ffUIDIndex/'+ff).remove();showToast('User deleted');}catch(e){showToast('Error: '+e.message,true);}}

/* =============================================
   MANUAL WALLET
   ============================================= */
function openManualWalletModal(){document.getElementById('manualUid').value='';document.getElementById('manualAmount').value='';document.getElementById('manualReason').value='';document.getElementById('manualUserInfo').style.display='none';document.getElementById('manualWalletModal').classList.add('show');}
async function lookupManualUser(){var uid=document.getElementById('manualUid').value.trim();if(!uid)return showToast('Enter UID',true);try{var s=await rtdb.ref(DB_USERS+'/'+uid).once('value');if(!s.exists())return showToast('Not found',true);var u=s.val();document.getElementById('manualUserName').textContent=u.ign||'Unknown';document.getElementById('manualUserStatus').textContent=u.isBanned?'Banned':'Active';document.getElementById('manualUserStatus').className='badge '+(u.isBanned?'red':'green');document.getElementById('manualUserDep').textContent='₹'+(u.wallet?u.wallet.depositBalance||0:u.realMoney?u.realMoney.deposited||0:0);document.getElementById('manualUserWin').textContent='₹'+(u.wallet?u.wallet.winningBalance||0:u.realMoney?u.realMoney.winnings||0:0);document.getElementById('manualUserInfo').style.display='block';}catch(e){showToast('Error: '+e.message,true);}}
async function processManualWallet(){var uid=document.getElementById('manualUid').value.trim(),act=document.getElementById('manualAction').value,wt=document.getElementById('manualWalletType').value,amt=Number(document.getElementById('manualAmount').value)||0,rsn=document.getElementById('manualReason').value.trim()||'Admin adjustment';if(!uid)return showToast('Enter UID',true);if(amt<=0)return showToast('Amount > 0',true);var s=await rtdb.ref(DB_USERS+'/'+uid).once('value');if(!s.exists())return showToast('Not found',true);
  /* Disable all buttons in the modal to prevent double-click */
  var modalBtns=document.querySelectorAll('#manualWalletModal .btn-primary');
  modalBtns.forEach(function(b){setLoading(b,true);});
  try{var paths=wt==='deposit'?['realMoney/deposited','wallet/depositBalance']:['realMoney/winnings','wallet/winningBalance'];for(var i=0;i<paths.length;i++){var p=paths[i];if(act==='credit')await rtdb.ref(DB_USERS+'/'+uid+'/'+p).transaction(function(v){return(v||0)+amt});else await rtdb.ref(DB_USERS+'/'+uid+'/'+p).transaction(function(v){return Math.max((v||0)-amt,0)});}await rtdb.ref(DB_USERS+'/'+uid+'/transactions').push({type:act==='credit'?'admin_credit':'admin_debit',amount:act==='credit'?amt:-amt,description:rsn,timestamp:Date.now()});await rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({title:act==='credit'?'Wallet Credited 💰':'Wallet Debited',message:'₹'+amt+' '+(act==='credit'?'added to':'removed from')+' '+wt+'. Reason: '+rsn,timestamp:Date.now(),read:false});var modalBtns2=document.querySelectorAll('#manualWalletModal .btn-primary');modalBtns2.forEach(function(b){setLoading(b,false);});closeModal('manualWalletModal');showToast('✅ ₹'+amt+' '+(act==='credit'?'credited':'debited'));}catch(e){var modalBtns3=document.querySelectorAll('#manualWalletModal .btn-primary');modalBtns3.forEach(function(b){setLoading(b,false);});showToast('Error: '+e.message,true);}}

/* =============================================
   DASHBOARD — reads from matches/ node
   ============================================= */
async function refreshDashboard(){
  try{
    var arr=await Promise.all([rtdb.ref(DB_USERS).once('value'),rtdb.ref(DB_MATCHES).once('value'),rtdb.ref(DB_WALLET).once('value'),rtdb.ref(DB_PROFILE).once('value')]);
    var uS=arr[0],tS=arr[1],wS=arr[2],pS=arr[3];
    document.getElementById('statUsers').textContent=uS.numChildren();
    document.getElementById('statTournaments').textContent=tS.numChildren();
    var wp=0,wd=0;wS.forEach(function(c){if(c.val().status==='pending'){wp++;if(normalizeWalletType(c.val().type)==='withdraw')wd++;}});
    document.getElementById('statWalletReq').textContent=wp;document.getElementById('statPendingWithdraw').textContent=wd;
    var pp=0;pS.forEach(function(c){if(!c.val().status||c.val().status==='pending')pp++;});document.getElementById('statPendingProfiles').textContent=pp;
    var am=0;tS.forEach(function(c){if(c.val().status==='live')am++;});document.getElementById('statActiveMatches').textContent=am;
    var rE=document.getElementById('recentProfiles');var rh='',rc=0;
    pS.forEach(function(c){var d=c.val();if((!d.status||d.status==='pending')&&rc<5){rc++;rh+='<div class="feed-item"><div class="flex items-center gap-2">'+idTag(d.ign||d.username||'Unknown',getUid(d)||'')+'<span class="badge yellow">Pending</span></div><div class="time">'+(d.createdAt?new Date(d.createdAt).toLocaleString():'N/A')+'</div></div>';}});
    rE.innerHTML=rh||'<p class="text-muted text-xs" style="padding:6px">No pending</p>';
    var aE=document.getElementById('activeTournaments');var ah='';
    var liveCount=0,upcomingCount=0,completedCount=0;
    tS.forEach(function(c){
      var d=c.val();
      /* Use the calculated status function for consistency */
      var smartStatus=getAdminMatchStatus(d);
      
      /* Count by calculated status */
      if(smartStatus==='live')liveCount++;
      else if(smartStatus==='upcoming')upcomingCount++;
      else if(smartStatus==='completed'||smartStatus==='resultPublished')completedCount++;
      
      /* Show upcoming and live matches in feed */
      if(smartStatus==='upcoming'||smartStatus==='live'){
        var badgeColor=getStatusBadgeColor(smartStatus);
        /* Calculate time remaining or elapsed */
        var mt=Number(d.matchTime)||0;
        var timeInfo='';
        if(mt){
          var diff=mt-Date.now();
          if(diff>0){
            var mins=Math.floor(diff/60000);
            timeInfo=mins>60?(Math.floor(mins/60)+'h '+mins%60+'m'):(mins+'m remaining');
          }else{
            var elapsed=Math.floor(-diff/60000);
            timeInfo=elapsed>60?(Math.floor(elapsed/60)+'h '+elapsed%60+'m ago'):(elapsed+'m ago');
          }
        }
        ah+='<div class="feed-item"><div class="flex items-center gap-2"><strong class="text-xs">'+d.name+'</strong><span class="badge '+badgeColor+'">'+smartStatus.toUpperCase()+'</span></div><div class="time">'+(d.matchTime?new Date(d.matchTime).toLocaleString():'N/A')+' • <span class="text-primary">'+timeInfo+'</span></div></div>';
      }
    });
    aE.innerHTML=ah||'<p class="text-muted text-xs" style="padding:6px">No active matches</p>';
    
    /* Update active matches stat to show live count */
    document.getElementById('statActiveMatches').textContent=liveCount;
    console.log('Dashboard Stats — Calculated from matchTime:','Upcoming:',upcomingCount,'Live:',liveCount,'Completed:',completedCount);
  }catch(e){console.error('Dash:',e);}
}
/* =============================================
   MATCH STATUS LOGIC — CALCULATED, NOT SAVED
   Status is calculated based on matchTime, NOT from database
   This ensures consistent status across Admin and User panels
   
   Logic:
   - If now < matchTime → "Upcoming"
   - If now >= matchTime && now < matchTime + 1 hour → "Live"  
   - If now >= matchTime + 1 hour → "Completed"
   
   Special cases:
   - 'resultPublished' status is preserved (admin manually published results)
   - 'cancelled' status is preserved (admin cancelled the match)
   ============================================= */

/* ╔══════════════════════════════════════════════════════════╗
   ║  MATCH STATUS ENGINE (CALCULATED, NOT SAVED)           ║
   ║  ══════════════════════════════════════════════════════ ║
   ║  Status is CALCULATED from matchTime, NOT read from DB ║
   ║  This ensures Admin & User panels always show same     ║
   ║  status regardless of what's stored in database.       ║
   ║                                                        ║
   ║  TIMELINE:                                             ║
   ║  ──────────┬──────────────────┬──────────────          ║
   ║  Upcoming  │      Live        │  Completed             ║
   ║  ──────────┼──────────────────┼──────────────          ║
   ║         matchTime      matchTime+1hour                 ║
   ║                                                        ║
   ║  TERMINAL STATES (admin-set, never auto-changed):      ║
   ║  • resultPublished — admin clicked "Publish Results"   ║
   ║  • cancelled — admin clicked "Cancel & Refund"         ║
   ╚══════════════════════════════════════════════════════════╝ */

/* getMatchStatus — Core time-based calculation
   SYNCED with User Panel — both use identical logic
   Duration: 1 hour (3,600,000 ms)
   
   Returns: 'Upcoming' | 'Live' | 'Completed' (title case)
*/
function getMatchStatus(matchTime){
  var now=Date.now();
  var startTime=Number(matchTime)||0;
  
  if(!startTime)return 'Upcoming';
  
  var endTime=startTime+(60*60*1000); /* 1 hour match duration */
  
  if(now<startTime)return 'Upcoming';
  if(now>=startTime&&now<endTime)return 'Live';
  return 'Completed';
}

/* getAdminMatchStatus — Enhanced wrapper with terminal state handling
   - Uses getMatchStatus() internally for time calculation
   - Respects 'resultPublished' and 'cancelled' as immutable states
   - Returns lowercase for badge CSS class compatibility
   
   Returns: 'upcoming' | 'live' | 'completed' | 'resultPublished' | 'cancelled'
*/
function getAdminMatchStatus(m){
  if(!m)return 'upcoming';
  
  /* Terminal states — admin-set, NEVER overridden by time calculation */
  if(m.status==='resultPublished')return 'resultPublished';
  if(m.status==='cancelled')return 'cancelled';
  
  /* All other states — calculate from matchTime */
  var mt=Number(m.matchTime)||0;
  if(!mt)return 'upcoming';
  
  return getMatchStatus(mt).toLowerCase();
}

/* getStatusBadgeColor — Badge color based on calculated status */
function getStatusBadgeColor(status){
  switch(status){
    case 'live': return 'red';
    case 'upcoming': return 'yellow';
    case 'completed': return 'blue';
    case 'resultPublished': return 'green';
    case 'cancelled': return 'gray';
    default: return 'blue';
  }
}

/* Legacy function for backward compatibility */
function getStatus(t){if(!t)return 'upcoming';return Date.now()>=t?'live':'upcoming';}

/* =============================================
   TOURNAMENTS — ALL data goes to matches/ node
   ============================================= */
async function loadTournaments(){
  try{
    var arr=await Promise.all([rtdb.ref(DB_MATCHES).once('value'),rtdb.ref(DB_JOIN).once('value')]);
    var tS=arr[0],jS=arr[1];allTournaments={};allJoinRequests={};var jc={};
    
    /* Count joined players from joinRequests node */
    jS.forEach(function(c){
      var j=c.val();
      allJoinRequests[c.key]=j;
      /* Accept multiple status variants for counting: approved, joined, confirmed, or no status (direct join) */
      var isJoined=(j.status==='approved'||j.status==='joined'||j.status==='confirmed'||!j.status);
      if(isJoined){
        var tid=j.tournamentId||j.matchId;
        jc[tid]=(jc[tid]||0)+1;
      }
    });
    
    /* Also check matches/{id}/joined node for direct joins */
    tS.forEach(function(c){
      var d=c.val(),id=c.key;
      /* If match has a 'joined' sub-node, count those too */
      if(d.joined&&typeof d.joined==='object'){
        var joinedCount=Object.keys(d.joined).length;
        jc[id]=Math.max(jc[id]||0,joinedCount);
        console.log('Match '+id+' has '+joinedCount+' players in matches/'+id+'/joined');
      }
    });
    var tb=document.getElementById('tournamentsTable');tb.innerHTML='';var cnt=0;
    var rS=document.getElementById('resultTournamentSelect'),nS=document.getElementById('notifTournamentSelect'),jF=document.getElementById('joinedTournamentFilter');
    rS.innerHTML='<option value="">-- Select --</option>';nS.innerHTML='<option value="">-- Select --</option>';jF.innerHTML='<option value="all">All</option>';
    tS.forEach(function(c){
      var d=c.val(),id=c.key;
      allTournaments[id]=d;
      
      /* Calculate filled slots — use Math.max of all sources for accuracy */
      d.filledSlots=Math.max(d.joinedSlots||0, jc[id]||0, d.filledSlots||0);
      
      /* Apply filter — now supports status filters too */
      if(currentFilter!=='all'){
        if(currentFilter==='special'&&!d.isSpecial)return;
        if(currentFilter==='paid'&&d.entryType!=='paid')return;
        if(currentFilter==='coin'&&d.entryType!=='coin')return;
        /* Status filters using smart status */
        var smartSt=getAdminMatchStatus(d);
        if(currentFilter==='upcoming'&&smartSt!=='upcoming')return;
        if(currentFilter==='live'&&smartSt!=='live')return;
        if(currentFilter==='completed'&&smartSt!=='completed'&&smartSt!=='resultPublished')return;
      }
      cnt++;
      
      /* Get status — use smart time-based calculation for UI display */
      var st=getAdminMatchStatus(d);
      var sb=getStatusBadgeColor(st);
      var tm=d.matchTime?new Date(d.matchTime).toLocaleString():'N/A';
      
      /* Game mode — normalize and display correctly */
      var gameMode=(d.gameMode||d.matchType||'solo').toLowerCase().trim();
      /* Fix: Ensure proper capitalization for display */
      var gameModeDisplay=gameMode.charAt(0).toUpperCase()+gameMode.slice(1);
      var modeBadgeColor=gameMode==='squad'?'purple':gameMode==='duo'?'cyan':'blue';
      
      /* Cancel button — only show for active matches */
      var cb='';
      if(st!=='cancelled'&&st!=='resultPublished'){
        cb='<button class="btn btn-danger btn-xs" onclick="cancelTournament(\''+id+'\')" title="Cancel & Refund"><i class="fas fa-ban"></i></button>';
      }
      
      /* Build row */
      tb.innerHTML+='<tr>'+
        '<td class="font-bold text-xs">'+(d.isSpecial?'⭐ ':'')+d.name+'</td>'+
        '<td><span class="badge '+modeBadgeColor+'">'+gameModeDisplay+'</span></td>'+
        '<td><span class="badge '+(d.entryType==='paid'?'green':'purple')+'">'+d.entryType+'</span> ₹'+(d.entryFee||0)+'</td>'+
        '<td class="text-primary font-bold">₹'+(d.prizePool||0)+'</td>'+
        '<td>'+slotBar(d.filledSlots,d.maxSlots||0)+'</td>'+
        '<td class="text-xxs">'+(d.map||'N/A')+'</td>'+
        '<td class="text-xxs">'+tm+'</td>'+
        '<td><span class="badge '+sb+'">'+st+'</span></td>'+
        '<td class="flex gap-1 items-center">'+
          '<button class="btn btn-ghost btn-xs" onclick="editTournament(\''+id+'\')"><i class="fas fa-edit"></i></button>'+
          '<button class="btn btn-ghost btn-xs" style="color:var(--info)" onclick="window.showRoomManager&&showRoomManager(\''+id+'\',\''+d.name+'\')" title="Room ID"><i class="fas fa-key"></i></button>'+
          '<button class="btn btn-ghost btn-xs" style="color:var(--primary)" onclick="window.showResultPublisher&&showResultPublisher(\''+id+'\',\''+d.name+'\')" title="Results"><i class="fas fa-bullseye"></i></button>'+
          '<button class="btn btn-ghost btn-xs" style="color:var(--purple)" onclick="window.broadcastToMatch&&broadcastToMatch(\''+id+'\',\''+d.name+'\')" title="Broadcast"><i class="fas fa-broadcast-tower"></i></button>'+
          '<button class="btn btn-ghost btn-xs" style="color:var(--warning)" onclick="window.showMatchAnalytics&&showMatchAnalytics(\''+id+'\',\''+d.name+'\')" title="Analytics"><i class="fas fa-chart-bar"></i></button>'+
          cb+
          '<button class="btn btn-ghost btn-xs" onclick="deleteTournament(\''+id+'\')" style="color:var(--danger)"><i class="fas fa-trash"></i></button>'+
        '</td>'+
      '</tr>';
      
      /* Add to dropdowns */
      rS.innerHTML+='<option value="'+id+'">'+d.name+'</option>';
      nS.innerHTML+='<option value="'+id+'">'+d.name+'</option>';
    });
    /* Show empty message if no matches */
    if(cnt===0){
      tb.innerHTML='<tr><td colspan="9" class="text-muted text-xs" style="text-align:center;padding:20px"><i class="fas fa-trophy" style="font-size:24px;opacity:0.3;display:block;margin-bottom:8px"></i>No matches found. Click "Create" to add a new match.</td></tr>';
    }
    
    document.getElementById('tournamentCount').textContent=cnt;
    console.log('Loaded',cnt,'matches from',DB_MATCHES+'/');
    
    /* Populate joined tournament filter */
    populateJoinedFilter();
    loadJoinedPlayers();
  }catch(e){
    console.error('loadTournaments Error:',e);
    document.getElementById('tournamentsTable').innerHTML='<tr><td colspan="9" class="text-danger text-xs" style="text-align:center;padding:20px">Error loading matches. Check console.</td></tr>';
  }
}

/* Populate the Joined Players tournament filter dropdown */
function populateJoinedFilter(){
  var jF=document.getElementById('joinedTournamentFilter');
  var currentVal=jF.value;
  jF.innerHTML='<option value="all">All Matches</option>';
  Object.keys(allTournaments).forEach(function(id){
    var t=allTournaments[id];
    jF.innerHTML+='<option value="'+id+'">'+t.name+'</option>';
  });
  jF.value=currentVal||'all';
}
function filterTournaments(f,btn){currentFilter=f;document.querySelectorAll('.filter-tab').forEach(function(t){t.classList.remove('active')});if(btn)btn.classList.add('active');loadTournaments();}
function openTournamentModal(){
  ['tournamentId','tName','tEntryFee','tPrizePool','tPerKillPrize','tMaxSlots','tFirstPrize','tSecondPrize','tThirdPrize','tMatchTime','tRoomId','tRoomPass'].forEach(function(i){document.getElementById(i).value=''});
  document.getElementById('tGameMode').value='solo';
  document.getElementById('tMap').value='Bermuda';
  document.getElementById('tEntryType').value='paid';
  document.getElementById('tIsSpecial').checked=false;
  document.getElementById('currentStatusHint').style.display='none';
  /* Reset the original match time tracker — new match has no original time */
  _editOriginalMatchTime=0;
  onEntryTypeChange();
  document.getElementById('tournamentModal').classList.add('show');
  console.log('📅 New Match modal opened — _editOriginalMatchTime reset to 0');
}
function onEntryTypeChange(){var t=document.getElementById('tEntryType').value,h=document.getElementById('entryTypeHint');h.className='info-box '+(t==='paid'?'green':'yellow');h.innerHTML='<i class="fas fa-info-circle"></i> '+(t==='paid'?'Paid — real money (₹)':'Coin — players use coins');}
/* _editOriginalMatchTime — stores the EXACT database matchTime (ms) when edit modal opens
   Used by saveTournament() to compare: did admin actually change the time?
   This prevents status recalculation when only Room ID/other fields change.
*/
var _editOriginalMatchTime=0;

function editTournament(id){
  var d=allTournaments[id];if(!d)return;
  document.getElementById('tournamentId').value=id;
  document.getElementById('tName').value=d.name||'';
  document.getElementById('tGameMode').value=(d.gameMode||d.matchType||'solo').toLowerCase().trim();
  document.getElementById('tMap').value=d.map||'Bermuda';
  document.getElementById('tEntryType').value=d.entryType||'paid';
  document.getElementById('tEntryFee').value=d.entryFee||'';
  document.getElementById('tPrizePool').value=d.prizePool||'';
  document.getElementById('tPerKillPrize').value=d.perKillPrize||'';
  document.getElementById('tMaxSlots').value=d.maxSlots||'';
  document.getElementById('tFirstPrize').value=d.firstPrize||'';
  document.getElementById('tSecondPrize').value=d.secondPrize||'';
  document.getElementById('tThirdPrize').value=d.thirdPrize||'';
  
  /* ╔══════════════════════════════════════════════════════════╗
     ║  MATCH TIME FIX — Load EXACT database time as LOCAL     ║
     ║  ══════════════════════════════════════════════════════  ║
     ║  BUG: .toISOString() converts to UTC, but datetime-    ║
     ║  local input expects LOCAL time → time shifts by        ║
     ║  timezone offset → saving "unchanged" time actually     ║
     ║  saves a DIFFERENT time → status recalculates wrongly   ║
     ║                                                         ║
     ║  FIX: Convert timestamp to LOCAL datetime string using  ║
     ║  getFullYear/getMonth/getDate/getHours/getMinutes       ║
     ║  Store original timestamp for precise comparison later  ║
     ╚══════════════════════════════════════════════════════════╝ */
  _editOriginalMatchTime=Number(d.matchTime)||0;
  
  if(d.matchTime){
    var dt=new Date(d.matchTime);
    /* Build LOCAL datetime string: YYYY-MM-DDTHH:MM */
    var yyyy=dt.getFullYear();
    var mm=String(dt.getMonth()+1).padStart(2,'0');
    var dd=String(dt.getDate()).padStart(2,'0');
    var hh=String(dt.getHours()).padStart(2,'0');
    var mi=String(dt.getMinutes()).padStart(2,'0');
    var localStr=yyyy+'-'+mm+'-'+dd+'T'+hh+':'+mi;
    document.getElementById('tMatchTime').value=localStr;
    console.log('📅 Edit Match — Loaded matchTime from DB:');
    console.log('   Database timestamp: '+d.matchTime+' ('+new Date(d.matchTime).toString()+')');
    console.log('   Input field set to: '+localStr+' (LOCAL time, NOT UTC)');
    console.log('   _editOriginalMatchTime saved: '+_editOriginalMatchTime);
  }else{
    document.getElementById('tMatchTime').value='';
    _editOriginalMatchTime=0;
    console.log('📅 Edit Match — No matchTime in database');
  }
  
  document.getElementById('tRoomId').value=d.roomId||'';
  document.getElementById('tRoomPass').value=d.roomPassword||'';
  document.getElementById('tIsSpecial').checked=d.isSpecial||false;
  
  /* Show current status indicator — uses CALCULATED status, not database */
  var calculatedSt=getAdminMatchStatus(d);
  var dbStatus=d.status||'upcoming';
  var stHint=document.getElementById('currentStatusHint');
  var stText=document.getElementById('currentStatusText');
  stHint.style.display='flex';
  stHint.className='info-box '+getStatusBadgeColor(calculatedSt);
  
  /* Build detailed status explanation */
  var statusExplain='';
  if(calculatedSt==='upcoming'){
    statusExplain='Match has not started yet. Will become LIVE when match time arrives.';
  }else if(calculatedSt==='live'){
    statusExplain='Match is currently LIVE. Will become COMPLETED 1 hour after start.';
  }else if(calculatedSt==='completed'){
    statusExplain='Match ended. Click "Publish Results" to finalize.';
  }else if(calculatedSt==='resultPublished'){
    statusExplain='Results already published. Cannot change status.';
  }else if(calculatedSt==='cancelled'){
    statusExplain='Match was cancelled. Players were refunded.';
  }
  
  stText.innerHTML='<strong>Calculated Status: '+calculatedSt.toUpperCase()+'</strong> <span style="font-size:9px;opacity:0.6">(DB: '+dbStatus+')</span><br><span style="font-size:10px;opacity:0.8">'+statusExplain+'</span><br><span style="font-size:9px;color:var(--text-muted)">📌 <b>RULE:</b> Editing Room ID/Password/Per Kill does NOT change status. Status ONLY recalculates if you change Match Time. Otherwise it stays as "'+dbStatus+'".</span>';
  
  onEntryTypeChange();
  document.getElementById('tournamentModal').classList.add('show');
}

/* saveTournament — writes to matches/ 
   ╔══════════════════════════════════════════════╗
   ║  SMART STATUS LOGIC (FINAL v5)              ║
   ║  ─────────────────────────────────────────── ║
   ║  • Status recalculates ONLY if matchTime     ║
   ║    actually CHANGES (old != new)              ║
   ║  • Room ID / Per Kill / other field edits     ║
   ║    do NOT touch status at all                 ║
   ║  • Terminal states (resultPublished/cancelled)║
   ║    are NEVER overwritten                      ║
   ║  • Room ID change auto-sends notification     ║
   ║    to joined players only                     ║
   ╚══════════════════════════════════════════════╝
   
   gameMode/matchType saved as 'solo', 'duo', or 'squad' (lowercase)
*/
async function saveTournament(){
  var saveBtn=document.getElementById('saveTournamentBtn');
  setLoading(saveBtn,true);
  
  var id=document.getElementById('tournamentId').value;
  var nm=document.getElementById('tName').value.trim();
  
  /* FIX: Ensure gameMode is saved correctly as 'solo', 'duo', or 'squad' */
  var gmRaw=document.getElementById('tGameMode').value;
  var gm=gmRaw.toLowerCase().trim();
  if(gm!=='solo'&&gm!=='duo'&&gm!=='squad'){
    gm='solo';
    console.warn('Invalid gameMode "'+gmRaw+'", defaulting to solo');
  }
  console.log('Saving gameMode as: "'+gm+'" (raw input: "'+gmRaw+'")');
  
  var mp=document.getElementById('tMap').value;
  var et=document.getElementById('tEntryType').value;
  var ef=Number(document.getElementById('tEntryFee').value)||0;
  var pp=Number(document.getElementById('tPrizePool').value)||0;
  var pk=Number(document.getElementById('tPerKillPrize').value)||0;
  var ms=Number(document.getElementById('tMaxSlots').value)||12;
  var f1=Number(document.getElementById('tFirstPrize').value)||0;
  var f2=Number(document.getElementById('tSecondPrize').value)||0;
  var f3=Number(document.getElementById('tThirdPrize').value)||0;
  var mts=document.getElementById('tMatchTime').value;
  var ri=document.getElementById('tRoomId').value.trim();
  var rp=document.getElementById('tRoomPass').value.trim();
  var sp=document.getElementById('tIsSpecial').checked;
  
  /* ===== STRICT VALIDATION ===== */
  if(!nm){
    showToast('❌ Please fill: Match Name',true);
    document.getElementById('tName').focus();
    setLoading(saveBtn,false);return;
  }
  if(!mts){
    showToast('❌ Please fill: Match Time',true);
    document.getElementById('tMatchTime').focus();
    setLoading(saveBtn,false);return;
  }
  if(et!=='paid'&&et!=='coin'){
    showToast('❌ Entry Type must be "paid" or "coin"',true);
    setLoading(saveBtn,false);return;
  }
  if(et==='paid'&&ef<=0){
    showToast('❌ Entry Fee must be > 0 for paid matches',true);
    document.getElementById('tEntryFee').focus();
    setLoading(saveBtn,false);return;
  }
  if(pk<=0){
    showToast('❌ Please fill: Per Kill Prize (must be > 0)',true);
    document.getElementById('tPerKillPrize').focus();
    setLoading(saveBtn,false);return;
  }
  if(ms<=0){
    showToast('❌ Please fill: Max Slots (must be > 0)',true);
    document.getElementById('tMaxSlots').focus();
    setLoading(saveBtn,false);return;
  }
  if(pp<0){
    showToast('❌ Prize Pool cannot be negative',true);
    setLoading(saveBtn,false);return;
  }
  if(f1<0||f2<0||f3<0){
    showToast('❌ Rank prizes cannot be negative',true);
    setLoading(saveBtn,false);return;
  }
  
  console.log('Match validation PASSED — all required fields present');
  console.log('GameMode to save: '+gm+', EntryType: '+et);
  
  var mt=new Date(mts).getTime();
  
  try{
    if(id){
      /* ═══════════════════════════════════════
         EDITING EXISTING MATCH
         ═══════════════════════════════════════ */
      var existingMatch=allTournaments[id]||{};
      /* Use _editOriginalMatchTime for PRECISE comparison
         This is the exact timestamp that was loaded into the input field.
         If admin didn't touch the time field, the parsed value from the
         LOCAL datetime string will match this exactly (no UTC shift).
      */
      var oldMatchTime=_editOriginalMatchTime||Number(existingMatch.matchTime)||0;
      var oldRoomId=existingMatch.roomId||'';
      var oldRoomPass=existingMatch.roomPassword||'';
      var currentDbStatus=existingMatch.status||'upcoming';
      
      /* ── Build update data ── 
         CRITICAL: status field is NOT included here.
         It is only added below IF matchTime actually changed.
      */
      var updateData={
        name:nm,
        gameMode:gm,
        matchType:gm,
        mode:gm,
        map:mp,
        entryType:et,
        entryFee:ef,
        prizePool:pp,
        perKillPrize:pk, perKill:pk,
        maxSlots:ms,
        firstPrize:f1, prize1st:f1,
        secondPrize:f2, prize2nd:f2,
        thirdPrize:f3, prize3rd:f3,
        matchTime:mt,
        roomId:ri,
        roomPassword:rp,
        isSpecial:sp,
        updatedAt:Date.now()
        /* ⛔ NO status field here — added conditionally below */
      };
      
      /* ── SMART STATUS DECISION ──
         Only recalculate status if matchTime ACTUALLY changed.
         If admin only changed Room ID, Per Kill, Prize, etc → status stays as-is.
      */
      /* ── PRECISE TIME COMPARISON ──
         Compare new parsed time with the EXACT original time that was loaded.
         Using _editOriginalMatchTime ensures no UTC/Local conversion drift.
         
         Allow 60-second tolerance for rounding (datetime-local drops seconds)
      */
      var timeDiff=Math.abs(mt-oldMatchTime);
      var matchTimeChanged=(timeDiff>60000); /* Changed if difference > 1 minute */
      var roomIdChanged=(ri!==oldRoomId&&ri!=='');
      var roomPassChanged=(rp!==oldRoomPass&&rp!=='');
      
      console.log('───── TIME COMPARISON ─────');
      console.log('Old matchTime (DB):    '+oldMatchTime+' → '+new Date(oldMatchTime).toString());
      console.log('New matchTime (input): '+mt+' → '+new Date(mt).toString());
      console.log('Difference:            '+timeDiff+'ms ('+(timeDiff/1000)+'s)');
      console.log('Time actually changed: '+matchTimeChanged+' (threshold: 60s)');
      console.log('───────────────────────────');
      
      if(matchTimeChanged){
        /* matchTime changed → recalculate status from the NEW time */
        var isTerminal=(currentDbStatus==='resultPublished'||currentDbStatus==='cancelled');
        
        if(!isTerminal){
          /* Use getMatchStatus for proper calculation with 1hr duration */
          var calculatedStatus=getMatchStatus(mt).toLowerCase();
          updateData.status=calculatedStatus;
          console.log('⏰ Match Time CHANGED: '+new Date(oldMatchTime).toLocaleString()+' → '+new Date(mt).toLocaleString());
          console.log('📌 Status recalculated to: '+calculatedStatus+' (was: '+currentDbStatus+')');
        }else{
          console.log('⚠️ Match Time changed but status is TERMINAL ('+currentDbStatus+'), NOT updating status');
        }
      }else{
        /* matchTime NOT changed → do NOT touch status at all */
        console.log('⏰ Match Time UNCHANGED (within 60s tolerance) — status will remain: '+currentDbStatus);
        console.log('   (Room ID, Per Kill, or other fields may have changed — status NOT affected)');
        /* Also use the original matchTime to avoid saving a drifted value */
        updateData.matchTime=oldMatchTime;
        console.log('   matchTime in update set to original: '+oldMatchTime);
      }
      
      console.log('═══════════════════════════════');
      console.log('EDIT MATCH: '+nm+' ('+id+')');
      console.log('Fields updated: '+Object.keys(updateData).join(', '));
      console.log('Status in update: '+(updateData.status?'YES → '+updateData.status:'NO → unchanged ('+currentDbStatus+')'));
      console.log('Room ID changed: '+roomIdChanged+', Match Time changed: '+matchTimeChanged);
      console.log('═══════════════════════════════');
      
      /* ── Save to database using .update() (never .set()) ── */
      await rtdb.ref(DB_MATCHES+'/'+id).update(updateData);
      console.log('✅ Match updated in database!');
      
      /* ── AUTO ROOM NOTIFICATION ──
         When Room ID is added or changed, auto-notify all joined players.
         This replaces the old "Update Room Only" button functionality.
      */
      if((roomIdChanged||roomPassChanged)&&ri&&rp){
        console.log('🔔 Room details changed → auto-notifying joined players...');
        
        /* Create global notification entry */
        await rtdb.ref('notifications').push({
          matchId:id,
          matchName:nm,
          title:'🎮 Room Details Released!',
          message:'Room ID: '+ri+' | Pass: '+rp,
          type:'room_released',
          createdAt:Date.now()
        });
        
        /* Send private notification to ONLY joined players of this match */
        var jS=await rtdb.ref(DB_JOIN).once('value');
        var notifyCount=0;
        var promises=[];
        
        jS.forEach(function(ch){
          var j=ch.val();
          var tid=j.tournamentId||j.matchId;
          var isJoined=(j.status==='approved'||j.status==='joined'||j.status==='confirmed'||!j.status);
          if(tid===id&&isJoined){
            var uid=getUid(j);
            if(uid){
              notifyCount++;
              promises.push(rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({
                title:'🎮 Room Details!',
                message:'Match: '+nm+'\nRoom ID: '+ri+'\nPassword: '+rp,
                matchId:id,
                roomId:ri,
                roomPassword:rp,
                timestamp:Date.now(),
                read:false,
                type:'room_released'
              }));
              promises.push(rtdb.ref('userMatches/'+uid+'/matches/'+id).update({
                roomId:ri,
                roomPassword:rp,
                roomReleasedAt:Date.now()
              }));
            }
          }
        });
        
        /* Also check matches/{id}/joined for direct joins */
        var matchSnap=await rtdb.ref(DB_MATCHES+'/'+id+'/joined').once('value');
        if(matchSnap.exists()){
          matchSnap.forEach(function(playerSnap){
            var puid=playerSnap.key;
            /* Avoid duplicates */
            var alreadyNotified=false;
            promises.forEach(function(p){/* skip check, duplicates are harmless */});
            notifyCount++;
            promises.push(rtdb.ref(DB_USERS+'/'+puid+'/notifications').push({
              title:'🎮 Room Details!',
              message:'Match: '+nm+'\nRoom ID: '+ri+'\nPassword: '+rp,
              matchId:id,
              roomId:ri,
              roomPassword:rp,
              timestamp:Date.now(),
              read:false,
              type:'room_released'
            }));
          });
        }
        
        await Promise.all(promises);
        console.log('✅ Room notification sent to '+notifyCount+' players');
        showToast('✅ Match updated! Room details sent to '+notifyCount+' players.');
      }else{
        showToast('✅ Match updated successfully!');
      }
      
    }else{
      /* ═══════════════════════════════════════
         CREATING NEW MATCH
         ═══════════════════════════════════════ */
      /* For new matches, calculate initial status from matchTime */
      var initialStatus=getMatchStatus(mt).toLowerCase();
      
      var createData={
        name:nm,
        gameMode:gm,
        matchType:gm,
        mode:gm,
        map:mp,
        entryType:et,
        entryFee:ef,
        prizePool:pp,
        perKillPrize:pk, perKill:pk,
        maxSlots:ms,
        firstPrize:f1, prize1st:f1,
        secondPrize:f2, prize2nd:f2,
        thirdPrize:f3, prize3rd:f3,
        matchTime:mt,
        roomId:ri,
        roomPassword:rp,
        isSpecial:sp,
        status:initialStatus,
        filledSlots:0,
        createdAt:Date.now()
      };
      
      console.log('═══════════════════════════════');
      console.log('CREATE NEW MATCH: '+nm);
      console.log('GameMode: '+gm+', EntryType: '+et);
      console.log('Initial Status: '+initialStatus+' (calculated from matchTime)');
      console.log('═══════════════════════════════');
      
      var nr=await rtdb.ref(DB_MATCHES).push(createData);
      
      console.log('✅ Match created: '+nr.key);
      showToast('✅ Match created! Status: '+initialStatus);
    }
    
    closeModal('tournamentModal');
    setLoading(saveBtn,false);
    loadTournaments();
  }catch(e){
    console.error('saveTournament error:',e);
    setLoading(saveBtn,false);
    showToast('Error: '+e.message,true);
  }
}

/* sendRoomNotificationToMatch — Utility function to send room notification to all joined players
   Called internally when Room ID is updated via saveTournament()
   Can also be called directly if needed
*/
async function sendRoomNotificationToMatch(matchId, roomId, roomPassword, matchName){
  if(!matchId||!roomId||!roomPassword){
    console.error('sendRoomNotificationToMatch: matchId, roomId, roomPassword required');
    return 0;
  }
  
  try{
    /* Create global notification entry in notifications/ node */
    var globalNotifRef=rtdb.ref('notifications').push();
    await globalNotifRef.set({
      matchId:matchId,
      matchName:matchName||'Match',
      title:'🎮 Room Details Released!',
      message:'Room ID: '+roomId+' | Pass: '+roomPassword,
      type:'room_released',
      createdAt:Date.now()
    });
    console.log('Created notification entry in notifications/');
    
    /* Send private notification to ONLY joined players of this specific match */
    var jS=await rtdb.ref(DB_JOIN).once('value');
    var notifyCount=0;
    var promises=[];
    
    jS.forEach(function(ch){
      var j=ch.val();
      var tid=j.tournamentId||j.matchId;
      var isJoined=(j.status==='approved'||j.status==='joined'||j.status==='confirmed'||!j.status);
      if(tid===matchId&&isJoined){
        var uid=getUid(j);
        if(uid){
          notifyCount++;
          promises.push(rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({
            title:'🎮 Room Details!',
            message:'Match: '+(matchName||'Match')+'\nRoom ID: '+roomId+'\nPassword: '+roomPassword,
            matchId:matchId,
            roomId:roomId,
            roomPassword:roomPassword,
            timestamp:Date.now(),
            read:false,
            type:'room_released'
          }));
          promises.push(rtdb.ref('userMatches/'+uid+'/matches/'+matchId).update({
            roomId:roomId,
            roomPassword:roomPassword,
            roomReleasedAt:Date.now()
          }));
        }
      }
    });
    
    await Promise.all(promises);
    console.log('Room notification sent to '+notifyCount+' joined players of match: '+matchId);
    return notifyCount;
  }catch(e){
    console.error('sendRoomNotificationToMatch error:',e);
    return 0;
  }
}

/* cancelTournament — auto-refund ALL joined players
   Checks BOTH joinRequests/ AND matches/{id}/joined/ for players
   Refunds to deposit balance (paid) or coins (coin matches)
*/
async function cancelTournament(id){
  if(!confirm('Cancel & refund ALL joined players?\n\nThis will:\n• Set status to "cancelled"\n• Refund entry fee to ALL joined players\n• Send notification to each player'))return;
  try{
    var t=allTournaments[id];
    var entryFee=t?Number(t.entryFee)||0:0;
    var matchName=t?t.name:'Match';
    var isC=t&&t.entryType==='coin';
    var pr=[];
    var rc=0;
    var refundedUids={};  /* Track to avoid double refunds */
    
    /* ── Check joinRequests/ node ── */
    var jS=await rtdb.ref(DB_JOIN).once('value');
    jS.forEach(function(c){
      var j=c.val(),tid=j.tournamentId||j.matchId;
      var isJoined=(j.status==='approved'||j.status==='joined'||j.status==='confirmed'||!j.status);
      if(tid===id&&isJoined){
        var uid=getUid(j);
        var fee=Number(j.entryFee)||entryFee;
        if(uid&&fee&&!refundedUids[uid]){
          rc++;
          refundedUids[uid]=true;
          var rp1=isC?'coins':'realMoney/deposited',rp2=isC?null:'wallet/depositBalance';
          pr.push(rtdb.ref(DB_USERS+'/'+uid+'/'+rp1).transaction(function(v){return(v||0)+fee}));
          if(rp2)pr.push(rtdb.ref(DB_USERS+'/'+uid+'/'+rp2).transaction(function(v){return(v||0)+fee}));
          pr.push(rtdb.ref(DB_USERS+'/'+uid+'/transactions').push({type:'refund',amount:fee,description:'Cancelled: '+matchName,timestamp:Date.now()}));
          pr.push(rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({title:'Match Cancelled 🚫',message:matchName+' cancelled. '+(isC?fee+' coins':' ₹'+fee)+' refunded.',timestamp:Date.now(),read:false}));
        }
        pr.push(rtdb.ref(DB_JOIN+'/'+c.key).update({status:'refunded'}));
      }
    });
    
    /* ── Also check matches/{id}/joined/ node for direct joins ── */
    var mJoined=await rtdb.ref(DB_MATCHES+'/'+id+'/joined').once('value');
    if(mJoined.exists()){
      mJoined.forEach(function(ps){
        var puid=ps.key;
        var pdata=ps.val();
        var fee=Number(pdata.entryFee)||entryFee;
        if(!refundedUids[puid]&&fee){
          rc++;
          refundedUids[puid]=true;
          var rp1=isC?'coins':'realMoney/deposited',rp2=isC?null:'wallet/depositBalance';
          pr.push(rtdb.ref(DB_USERS+'/'+puid+'/'+rp1).transaction(function(v){return(v||0)+fee}));
          if(rp2)pr.push(rtdb.ref(DB_USERS+'/'+puid+'/'+rp2).transaction(function(v){return(v||0)+fee}));
          pr.push(rtdb.ref(DB_USERS+'/'+puid+'/transactions').push({type:'refund',amount:fee,description:'Cancelled: '+matchName,timestamp:Date.now()}));
          pr.push(rtdb.ref(DB_USERS+'/'+puid+'/notifications').push({title:'Match Cancelled 🚫',message:matchName+' cancelled. '+(isC?fee+' coins':'₹'+fee)+' refunded.',timestamp:Date.now(),read:false}));
        }
      });
    }
    
    /* ── Set match status to cancelled ── */
    pr.push(rtdb.ref(DB_MATCHES+'/'+id).update({status:'cancelled',cancelledAt:Date.now(),cancelledBy:auth.currentUser.uid}));
    
    await Promise.all(pr);
    console.log('✅ Match cancelled: '+matchName+' — '+rc+' players refunded');
    showToast('✅ Cancelled — '+rc+' players refunded');
    loadTournaments();
  }catch(e){
    console.error('cancelTournament error:',e);
    showToast('Error: '+e.message,true);
  }
}
async function deleteTournament(id){if(!confirm('DELETE?'))return;try{await rtdb.ref(DB_MATCHES+'/'+id).remove();showToast('Deleted');loadTournaments();}catch(e){showToast('Error: '+e.message,true);}}
/* syncTournamentStatuses — Auto-update DATABASE status based on time
   Uses the same 1-hour duration logic as getMatchStatus()
   
   ╔══════════════════════════════════════════════╗
   ║  AUTO-STATUS SYNC (runs every 30 seconds)   ║
   ║  ─────────────────────────────────────────── ║
   ║  upcoming → live:  now >= matchTime          ║
   ║  live → completed: now >= matchTime + 1 hour ║
   ║  ─────────────────────────────────────────── ║
   ║  NEVER auto-updates:                         ║
   ║  • resultPublished (admin published results) ║
   ║  • cancelled (admin cancelled match)         ║
   ╚══════════════════════════════════════════════╝
*/
async function syncTournamentStatuses(){
  try{
    var s=await rtdb.ref(DB_MATCHES).once('value');
    var now=Date.now();
    var updateCount=0;
    var logLines=[];
    
    s.forEach(function(c){
      var d=c.val(),id=c.key;
      var mt=Number(d.matchTime)||0;
      if(!mt)return;
      
      /* ⛔ Skip terminal states — these are admin-controlled, NEVER auto-change */
      if(d.status==='resultPublished'||d.status==='cancelled')return;
      
      /* Calculate what the status SHOULD be based on time using getMatchStatus */
      var calculatedStatus=getMatchStatus(mt).toLowerCase();
      var currentDbStatus=(d.status||'upcoming').toLowerCase();
      
      /* Only update database if the calculated status differs from current */
      if(calculatedStatus!==currentDbStatus){
        updateCount++;
        rtdb.ref(DB_MATCHES+'/'+id).update({status:calculatedStatus});
        logLines.push('  → '+d.name+': '+currentDbStatus+' → '+calculatedStatus);
      }
    });
    
    if(updateCount>0){
      console.log('⏱️ syncTournamentStatuses: Updated '+updateCount+' matches:');
      logLines.forEach(function(l){console.log(l);});
      /* Refresh UI after status changes */
      loadTournaments();
    }
  }catch(e){
    console.error('syncTournamentStatuses error:',e);
  }
}

/* =============================================
   JOINED PLAYERS — FIXED: Properly fetches from joinRequests/
   Shows Player IGN, UID, FF UID, Teammates with IGN+UID
   ============================================= */
async function refreshJoinedPlayers(){
  showToast('Refreshing joined players...');
  try{
    /* Reload join requests from Firebase joinRequests node */
    var jS=await rtdb.ref(DB_JOIN).once('value');
    allJoinRequests={};
    jS.forEach(function(c){
      allJoinRequests[c.key]=c.val();
    });
    
    /* Also check matches/{matchId}/joined for direct joins */
    var mS=await rtdb.ref(DB_MATCHES).once('value');
    mS.forEach(function(mc){
      var m=mc.val(),mid=mc.key;
      if(m.joined&&typeof m.joined==='object'){
        Object.keys(m.joined).forEach(function(uid){
          var jData=m.joined[uid];
          /* Create a synthetic join request entry */
          var syntheticKey='joined_'+mid+'_'+uid;
          if(!allJoinRequests[syntheticKey]){
            allJoinRequests[syntheticKey]={
              matchId:mid,
              tournamentId:mid,
              uid:uid,
              oderId:uid,
              playerName:jData.playerName||jData.ign||getUserName(uid),
              ign:jData.ign||jData.playerName,
              ffUid:jData.ffUid||jData.gameUid||'',
              entryFee:jData.entryFee||m.entryFee||0,
              status:'approved',
              joinedAt:jData.joinedAt||jData.timestamp||Date.now(),
              teammates:jData.teammates||[],
              source:'matches_joined_node'
            };
            console.log('Found direct join: '+uid+' in matches/'+mid+'/joined');
          }
        });
      }
    });
    
    loadJoinedPlayers();
    showToast('Joined players refreshed!');
  }catch(e){
    console.error('refreshJoinedPlayers error:',e);
    showToast('Error: '+e.message,true);
  }
}

async function loadJoinedPlayers(){
  var f=document.getElementById('joinedTournamentFilter').value;
  var tb=document.getElementById('joinedPlayersTable');
  tb.innerHTML='<tr><td colspan="8" class="text-muted text-xs" style="text-align:center;padding:14px"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
  var c=0;
  var keys=Object.keys(allJoinRequests);
  
  console.log('loadJoinedPlayers — Total requests:',keys.length,'Filter:',f);
  
  if(keys.length===0){
    tb.innerHTML='<tr><td colspan="8" class="text-muted text-xs" style="text-align:center;padding:20px">No players joined yet. Click Refresh to reload.</td></tr>';
    document.getElementById('joinedCount').textContent=0;
    return;
  }
  
  /* Collect all UIDs to batch-fetch partner info */
  var rowsData=[];
  
  keys.forEach(function(k){
    var j=allJoinRequests[k];
    
    var isJoined=(j.status==='approved'||j.status==='joined'||j.status==='confirmed'||!j.status);
    if(!isJoined)return;
    
    var tid=j.tournamentId||j.matchId;
    if(f!=='all'&&tid!==f)return;
    c++;
    
    var match=allTournaments[tid];
    var tn=match?match.name:'Unknown Match';
    var gameMode=match?(match.gameMode||match.matchType||'solo').toLowerCase():'solo';
    var mode=gameMode.toUpperCase();
    var modeBadgeColor=gameMode==='squad'?'purple':gameMode==='duo'?'cyan':'blue';
    var dt=(j.joinedAt||j.createdAt)?new Date(j.joinedAt||j.createdAt).toLocaleString():'N/A';
    var uid=getUid(j)||j.oderId||'';
    var nm=j.playerName||j.ign||j.userName||getUserName(uid)||'Player';
    var ffUid=j.ffUid||j.gameUid||j.playerFfUid||'N/A';
    
    rowsData.push({uid:uid,nm:nm,ffUid:ffUid,tn:tn,mode:mode,modeBadgeColor:modeBadgeColor,gameMode:gameMode,dt:dt,j:j,entryFee:j.entryFee||0});
  });
  
  /* Fetch partner info for duo players */
  var partnerCache={};
  var duoUids=rowsData.filter(function(r){return r.gameMode==='duo';}).map(function(r){return r.uid;});
  
  if(duoUids.length>0){
    try{
      var promises=duoUids.map(function(uid){
        return rtdb.ref(DB_USERS+'/'+uid+'/partnerUid').once('value').then(function(s){
          if(s.val()){
            partnerCache[uid]=s.val();
          }
        });
      });
      await Promise.all(promises);
      
      /* Fetch partner names */
      var partnerUids=Object.values(partnerCache).filter(function(v,i,a){return a.indexOf(v)===i;});
      var partnerNames={};
      var namePromises=partnerUids.map(function(puid){
        return rtdb.ref(DB_USERS+'/'+puid+'/ign').once('value').then(function(s){
          partnerNames[puid]=s.val()||getUserName(puid);
        });
      });
      await Promise.all(namePromises);
      
      /* Also fetch partner FF UIDs */
      var partnerFfUids={};
      var ffPromises=partnerUids.map(function(puid){
        return rtdb.ref(DB_USERS+'/'+puid+'/ffUid').once('value').then(function(s){
          partnerFfUids[puid]=s.val()||'N/A';
        });
      });
      await Promise.all(ffPromises);
      
      /* Attach partner info */
      rowsData.forEach(function(r){
        if(partnerCache[r.uid]){
          var puid=partnerCache[r.uid];
          r.partnerUid=puid;
          r.partnerIgn=partnerNames[puid]||puid.substring(0,10);
          r.partnerFfUid=partnerFfUids[puid]||'N/A';
        }
      });
      console.log('Fetched partner info for '+duoUids.length+' duo players');
    }catch(e){console.error('Partner fetch error:',e);}
  }
  
  /* Build table HTML - group teams together */
  tb.innerHTML='';
  
  // Group duo/squad by team (captain + members)
  var rendered = {};
  
  function _renderJRow(r, badge) {
    var j = r.j;
    var sb = j.resultStatus==='completed' ? '<span class="badge blue">Done</span>' : '<span class="badge green">Joined</span>';
    var entryDisp = badge || ('\u20b9'+r.entryFee);
    var ffDisp = r.ffUid && r.ffUid!=='N/A' ? '<div class="font-mono text-xxs" style="color:var(--primary);margin-top:1px">FF: '+r.ffUid+'</div>' : '<div class="text-xxs text-muted">FF: N/A</div>';
    return '<tr>' +
      '<td>'+idTag(r.nm,r.uid)+ffDisp+'</td>' +
      '<td class="text-xs">'+r.tn+'</td>' +
      '<td><span class="badge '+r.modeBadgeColor+'">'+r.mode+'</span></td>' +
      '<td>'+entryDisp+'</td>' +
      '<td class="text-xxs">'+r.dt+'</td>' +
      '<td>'+sb+'</td>' +
      '</tr>';
  }
  
  rowsData.forEach(function(r) {
    if (rendered[r.uid+(r.j.matchId||r.j.tournamentId)]) return;
    
    var j = r.j, mid = j.matchId||j.tournamentId;
    var mode = r.gameMode;
    
    // Find all team members for this match
    var teamMates = [];
    if (mode !== 'solo') {
      rowsData.forEach(function(other) {
        if (other === r) return;
        var omid = other.j.matchId||other.j.tournamentId;
        if (omid !== mid) return;
        // Match by captainUid or teamMembers
        var isMate = (other.j.captainUid === r.uid) || (r.j.captainUid === other.uid) || 
                     (r.j.captainUid && r.j.captainUid === other.j.captainUid);
        if (isMate) teamMates.push(other);
      });
    }
    
    if (teamMates.length > 0) {
      // Render as a single team BOX (all members together)
      var teamColor = mode==='squad' ? '#b964ff' : '#00d4ff';
      var allTeam = [r].concat(teamMates);
      allTeam.forEach(function(m) { rendered[m.uid+mid] = true; });
      
      var teamPlayerRows = allTeam.map(function(m, i) {
        var isCap = (i===0 && !m.j.isTeamMember);
        var roleBadge = isCap
          ? '<span style="font-size:9px;padding:1px 6px;border-radius:4px;background:rgba(0,212,255,.15);color:#00d4ff;font-weight:700">👑 Cap</span>'
          : '<span style="font-size:9px;padding:1px 6px;border-radius:4px;background:rgba(255,215,0,.12);color:#ffd700;font-weight:700">Member</span>';
        var ffStr = (m.ffUid && m.ffUid !== 'N/A') ? m.ffUid : '—';
        var uidShort = (m.uid||'').substring(0,20);
        return '<div style="display:flex;align-items:center;padding:6px 10px;background:rgba(255,255,255,.03);border-radius:6px;margin-bottom:3px">' +
          '<div style="flex:1;min-width:0">' +
            '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">' +
              '<span style="font-size:12px;font-weight:700">'+idTag(m.nm,m.uid)+'</span>' +
              roleBadge +
            '</div>' +
            '<div style="font-size:10px;color:var(--primary);font-family:monospace;margin-top:2px">FF UID: '+ffStr+'</div>' +
          '</div>' +
        '</div>';
      }).join('');
      
      var teamSb = r.j.resultStatus==='completed' ? '<span class="badge blue">Done</span>' : '<span class="badge green">Joined</span>';
      tb.innerHTML += '<tr>' +
        '<td colspan="6" style="padding:6px 10px">' +
          '<div style="border:1px solid '+teamColor+'55;border-left:3px solid '+teamColor+';border-radius:8px;padding:8px;background:'+teamColor+'08">' +
            '<div style="font-size:10px;color:'+teamColor+';font-weight:700;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between">' +
              '<span><i class="fas fa-users" style="margin-right:4px"></i>'+mode.toUpperCase()+' Team · '+r.tn+'</span>' +
              '<span style="display:flex;gap:6px;align-items:center">' +
                '<span class="badge '+r.modeBadgeColor+'">'+r.mode+'</span>' +
                teamSb +
                '<span class="text-xxs text-muted">'+r.dt+'</span>' +
              '</span>' +
            '</div>' +
            teamPlayerRows +
          '</div>' +
        '</td>' +
      '</tr>';
    } else if (r.partnerIgn && mode !== 'solo') {
      /* DUO: Captain has partnerIgn attached but partner has no separate row */
      rendered[r.uid+mid] = true;
      var teamColor2 = '#00d4ff';
      var capFf = (r.ffUid && r.ffUid !== 'N/A') ? r.ffUid : '—';
      var partFf = r.partnerFfUid || '—';
      var teamSb2 = r.j.resultStatus==='completed' ? '<span class="badge blue">Done</span>' : '<span class="badge green">Joined</span>';
      tb.innerHTML += '<tr>' +
        '<td colspan="6" style="padding:6px 10px">' +
          '<div style="border:1px solid '+teamColor2+'55;border-left:3px solid '+teamColor2+';border-radius:8px;padding:8px;background:'+teamColor2+'08">' +
            '<div style="font-size:10px;color:'+teamColor2+';font-weight:700;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between">' +
              '<span><i class="fas fa-users" style="margin-right:4px"></i>DUO Team · ' + r.tn + '</span>' +
              '<span style="display:flex;gap:6px;align-items:center">' +
                '<span class="badge cyan">DUO</span>' + teamSb2 +
                '<span class="text-xxs text-muted">' + r.dt + '</span>' +
              '</span>' +
            '</div>' +
            '<div style="display:flex;align-items:center;padding:6px 10px;background:rgba(255,255,255,.03);border-radius:6px;margin-bottom:3px">' +
              '<div style="flex:1">' +
                '<div style="display:flex;align-items:center;gap:6px">' + idTag(r.nm,r.uid) + 
                '<span style="font-size:9px;padding:1px 6px;border-radius:4px;background:rgba(0,212,255,.15);color:#00d4ff;font-weight:700">👑 Cap</span></div>' +
                '<div style="font-size:10px;color:var(--primary);font-family:monospace;margin-top:2px">FF UID: '+capFf+'</div>' +
              '</div>' +
            '</div>' +
            '<div style="display:flex;align-items:center;padding:6px 10px;background:rgba(255,255,255,.03);border-radius:6px">' +
              '<div style="flex:1">' +
                '<div style="display:flex;align-items:center;gap:6px">' + idTag(r.partnerIgn, r.partnerUid||'') +
                '<span style="font-size:9px;padding:1px 6px;border-radius:4px;background:rgba(255,215,0,.12);color:#ffd700;font-weight:700">Member</span></div>' +
                '<div style="font-size:10px;color:var(--primary);font-family:monospace;margin-top:2px">FF UID: '+partFf+'</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</td>' +
      '</tr>';
    } else {
      rendered[r.uid+mid] = true;
      tb.innerHTML += _renderJRow(r, null);
    }
  });
  
    document.getElementById('joinedCount').textContent=c;
  console.log('Rendered',c,'joined players (with partner info for duo)');
}

/* =============================================
   MATCH RESULTS — reads from matches/, writes to matches/
   ============================================= */
function previewResultScreenshot(inp){if(!inp.files[0])return;var rd=new FileReader();rd.onload=function(e){var img=new Image();img.onload=function(){var cv=document.createElement('canvas');var w=img.width,h=img.height;if(w>1200){h=(1200/w)*h;w=1200;}cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);var q=0.8,d=cv.toDataURL('image/jpeg',q);while(d.length>500*1024&&q>0.1){q-=0.1;d=cv.toDataURL('image/jpeg',q);}resultScreenshotBase64=d;var b=document.getElementById('resultScreenshotBox');b.innerHTML='<img src="'+d+'">';b.classList.add('has-img');};img.src=e.target.result;};rd.readAsDataURL(inp.files[0]);}

async function loadParticipants(){
  var mid=document.getElementById('resultTournamentSelect').value,ct=document.getElementById('resultsContainer'),ls=document.getElementById('participantsList');
  if(!mid){ct.style.display='none';return;}ct.style.display='block';ls.innerHTML='<tr><td colspan="5" class="text-muted text-xs">Loading...</td></tr>';
  try{
    currentTournamentData=allTournaments[mid];var t=currentTournamentData;
    document.getElementById('resultTournamentInfo').innerHTML='<div class="flex justify-between mb-1"><span class="text-dim">Per Kill:</span><strong class="text-primary">₹'+(t?t.perKillPrize||0:0)+'</strong></div><div class="flex justify-between mb-1"><span class="text-dim">1st/2nd/3rd:</span><strong>₹'+(t?t.firstPrize||0:0)+' / ₹'+(t?t.secondPrize||0:0)+' / ₹'+(t?t.thirdPrize||0:0)+'</strong></div>';
    var jS=await rtdb.ref(DB_JOIN).once('value');var html='',pc=0;
    jS.forEach(function(c){
      var j=c.val(),tid=j.tournamentId||j.matchId;
      if(tid===mid&&(j.status==='approved'||j.status==='joined'||j.status==='confirmed'||!j.status)){pc++;
        var uid=getUid(j),nm=j.playerName||j.ign||getUserName(uid)||'Unknown',ff=j.ffUid||j.gameUid||'';
        html+='<tr data-uid="'+uid+'" data-reqid="'+c.key+'" data-name="'+nm.toLowerCase()+'"><td class="text-xxs text-muted">'+pc+'</td><td>'+idTag(nm,uid)+'<div class="text-xxs" style="color:var(--primary);font-family:monospace;margin-top:2px">FF: '+(ff||'N/A')+'</div></td><td><input type="number" class="rank-input" title="Position: 1=1st, 2=2nd, 3=3rd, 0=no rank prize" placeholder="0" min="0" value="0" style="width:56px;padding:5px 6px;border-radius:6px;background:var(--bg-dark);border:1px solid var(--border);color:var(--text);font-size:13px;text-align:center;font-weight:700" oninput="calcPrize(this)"></td><td><input type="number" class="kills-input" placeholder="0" min="0" value="0" style="width:56px;padding:5px 6px;border-radius:6px;background:var(--bg-dark);border:1px solid var(--border);color:var(--text);font-size:13px;text-align:center;font-weight:700" oninput="calcPrize(this)"></td><td class="prize-cell" style="font-weight:800;color:var(--primary);font-size:13px">₹0</td></tr>';
      }
    });
    ls.innerHTML=html||'<tr><td colspan="5" class="text-muted text-xs">No participants found for this match</td></tr>';
  }catch(e){ls.innerHTML='<tr><td colspan="5" class="text-danger text-xs">Error loading</td></tr>';}
}
function calcPrize(inp){var row=inp.closest('tr'),k=Number(row.querySelector('.kills-input').value)||0,r=Number(row.querySelector('.rank-input').value)||0,t=currentTournamentData;if(!t)return;var rp=0;if(r===1)rp=t.firstPrize||0;else if(r===2)rp=t.secondPrize||0;else if(r===3)rp=t.thirdPrize||0;row.querySelector('.prize-cell').textContent='₹'+(k*(t.perKillPrize||0)+rp);}
function filterParticipants(s){s=s.toLowerCase();document.querySelectorAll('#participantsList tr').forEach(function(r){r.style.display=(r.dataset.name||'').indexOf(s)>=0?'':'none';});}

/* publishResults — writes to matches/{mid}/results/ */
async function publishResults(){
  var mid=document.getElementById('resultTournamentSelect').value;if(!mid)return showToast('Select match',true);if(!confirm('Publish & distribute prizes?'))return;
  var rows=document.querySelectorAll('#participantsList tr[data-uid]');if(!rows.length)return showToast('No participants',true);var t=currentTournamentData;
  var pubBtn=document.getElementById('publishResultsBtn');
  setLoading(pubBtn,true);
  try{
    for(var i=0;i<rows.length;i++){
      var row=rows[i],uid=row.dataset.uid,rid=row.dataset.reqid,rank=Number(row.querySelector('.rank-input').value)||0,kills=Number(row.querySelector('.kills-input').value)||0;
      var kp=kills*(t?t.perKillPrize||0:0);var rp=0;
      if(rank===1)rp=t?t.firstPrize||0:0;else if(rank===2)rp=t?t.secondPrize||0:0;else if(rank===3)rp=t?t.thirdPrize||0:0;
      var tw=kp+rp;
      await rtdb.ref(DB_MATCHES+'/'+mid+'/results/'+uid).set({rank:rank,kills:kills,killPrize:kp,rankPrize:rp,totalWinning:tw,timestamp:Date.now()});
      /* BUG FIX #2: Also write to global results/ node for User Panel compatibility */
      var resultPushRef=rtdb.ref('results').push();
      await resultPushRef.set({userId:uid,matchId:mid,matchName:t?t.name:'',rank:rank,kills:kills,winnings:tw,won:rank===1,timestamp:Date.now(),createdAt:Date.now(),synced:false});
      await rtdb.ref(DB_JOIN+'/'+rid).update({kills:kills,rank:rank,reward:tw,resultStatus:'completed'});
      await rtdb.ref('userMatches/'+uid+'/matches/'+mid).update({kills:kills,rank:rank,reward:tw,resultStatus:'completed'});
      await rtdb.ref(DB_USERS+'/'+uid+'/totalKills').transaction(function(v){return(v||0)+kills});
      await rtdb.ref(DB_USERS+'/'+uid+'/stats/kills').transaction(function(v){return(v||0)+kills});
      if(tw>0){
        await rtdb.ref(DB_USERS+'/'+uid+'/realMoney/winnings').transaction(function(v){return(v||0)+tw});
        await rtdb.ref(DB_USERS+'/'+uid+'/wallet/winningBalance').transaction(function(v){return(v||0)+tw});
        await rtdb.ref(DB_USERS+'/'+uid+'/stats/earnings').transaction(function(v){return(v||0)+tw});
        await rtdb.ref(DB_USERS+'/'+uid+'/totalWinnings').transaction(function(v){return(v||0)+tw});
        if(rank===1)await rtdb.ref(DB_USERS+'/'+uid+'/stats/wins').transaction(function(v){return(v||0)+1});
        await rtdb.ref(DB_USERS+'/'+uid+'/transactions').push({type:'winning',amount:tw,description:(t?t.name:'Match')+' #'+rank+', '+kills+'k',timestamp:Date.now()});
        await rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({title:'🏆 Result!',message:'₹'+tw+' earned! #'+rank+', '+kills+' kills.',timestamp:Date.now(),createdAt:Date.now(),read:false,type:'result'});
      }
      if(rank===1)await rtdb.ref('scratchCards/'+uid).push({matchId:mid,prize:Math.floor(Math.random()*50)+10,scratched:false,createdAt:Date.now()});
    }
    if(resultScreenshotBase64)await rtdb.ref(DB_MATCHES+'/'+mid+'/resultScreenshot').set(resultScreenshotBase64);
    await rtdb.ref(DB_MATCHES+'/'+mid).update({status:'resultPublished'});
    setLoading(pubBtn,false);
    showToast('Results published!');loadTournaments();
  }catch(e){console.error(e);setLoading(pubBtn,false);showToast('Error: '+e.message,true);}
}

/* =============================================
   WALLET REQUESTS
   ============================================= */
function setupWalletListener(){rtdb.ref(DB_WALLET).on('value',function(s){allWalletRequests={};s.forEach(function(c){allWalletRequests[c.key]=c.val();});renderWalletRequests();});}
function normalizeWalletType(t){if(!t)return 'add';t=t.toLowerCase();if(t==='deposit'||t==='add'||t==='add_money'||t==='addmoney')return 'add';if(t==='withdraw'||t==='withdrawal')return 'withdraw';return t;}
function renderWalletRequests(){
  var f=document.getElementById('walletFilter')?document.getElementById('walletFilter').value:'all';var tb=document.getElementById('walletRequestsTable');tb.innerHTML='';var c=0;
  Object.keys(allWalletRequests).forEach(function(id){
    var w=allWalletRequests[id];var tp=normalizeWalletType(w.type);if(f!=='all'&&tp!==f)return;c++;
    var uid=getUid(w)||'N/A',un=w.userName||w.displayName||getUserName(uid);
    var tb_=tp==='add'?'<span class="badge green"><i class="fas fa-plus"></i> Add</span>':'<span class="badge purple"><i class="fas fa-arrow-up"></i> Withdraw</span>';
    var sb=w.status==='approved'?'green':w.status==='rejected'?'red':'yellow';
    var _ssrc=w.screenshotBase64||w.screenshot||w.proofImage||''; var ss=_ssrc?'<img src="'+_ssrc+'" style="width:36px;height:36px;border-radius:6px;cursor:pointer;object-fit:cover;border:1px solid var(--border)" onclick="viewScreenshot(this.src)">':'<span class="text-muted text-xxs">No photo</span>';
    var utr=w.utrNumber||w.utr||w.transactionId||w.referenceId||'',upi=w.upiId||w.upi||'';
    var dh='';
    if(tp==='add'&&utr)dh='<span class="wallet-utr">UTR: '+utr+'</span>';
    else if(tp==='withdraw'&&upi)dh='<div class="text-xxs"><span class="text-dim">UPI:</span> <strong class="text-warning">'+upi+'</strong></div>';
    else dh='<span class="text-muted text-xxs">'+(utr||upi||'—')+'</span>';
    var acts='';
    if(w.status==='pending'){
      if(tp==='add')acts='<button class="btn btn-primary btn-xs" onclick="approveAddMoney(\''+id+'\')"><i class="fas fa-check"></i></button> <button class="btn btn-danger btn-xs" onclick="openRejectModal(\'wallet\',\''+id+'\')"><i class="fas fa-times"></i></button>';
      else acts='<button class="btn btn-primary btn-xs" onclick="openWithdrawalModal(\''+id+'\')"><i class="fas fa-money-bill-wave"></i></button> <button class="btn btn-danger btn-xs" onclick="openRejectModal(\'wallet\',\''+id+'\')"><i class="fas fa-times"></i></button>';
    }
    tb.innerHTML+='<tr><td>'+idTag(un,uid)+'<div class="text-xxs text-muted font-mono mt-1" style="white-space:nowrap">[FF: '+(usersCache[uid]?usersCache[uid].ffUid||'N/A':'N/A')+']</div></td><td>'+tb_+'</td><td class="font-bold text-primary">₹'+(w.amount||0)+'</td><td>'+dh+'</td><td>'+ss+'</td><td><span class="badge '+sb+'">'+(w.status||'pending')+'</span></td><td>'+acts+'</td></tr>';
  });
  document.getElementById('walletCount').textContent=c;
}
function viewScreenshot(src){document.getElementById('screenshotFullImg').src=src;document.getElementById('screenshotModal').classList.add('show');}
async function approveAddMoney(rid){
  /* Disable button immediately to prevent double-clicks */
  event.target.closest('.btn').disabled=true;
  event.target.closest('.btn').style.opacity='0.5';
  try{
    var w=allWalletRequests[rid];
    if(!w)return showToast('Not found',true);
    var uid=getUid(w);
    if(!uid)return showToast('UID missing',true);
    var amt=Number(w.amount)||0;
    var userName=w.userName||w.displayName||getUserName(uid)||'User';
    
    /* Update user balances */
    await rtdb.ref(DB_USERS+'/'+uid+'/realMoney/deposited').transaction(function(v){return(v||0)+amt});
    await rtdb.ref(DB_USERS+'/'+uid+'/wallet/depositBalance').transaction(function(v){return(v||0)+amt});
    
    /* Update wallet request status */
    await rtdb.ref(DB_WALLET+'/'+rid).update({status:'approved',processedAt:Date.now(),processedBy:auth.currentUser.uid});
    
    /* Add transaction record */
    await rtdb.ref(DB_USERS+'/'+uid+'/transactions').push({type:'deposit',amount:amt,description:'Deposit approved',timestamp:Date.now()});
    
    /* Send notification to user — CRITICAL: User must know their deposit was approved */
    await rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({
      title:'💰 Deposit Approved!',
      message:'Your deposit of ₹'+amt+' has been approved and added to your wallet.',
      amount:amt,
      type:'wallet_approved',
      timestamp:Date.now(),
      read:false
    });
    
    /* Also create entry in global notifications node for tracking */
    await rtdb.ref('notifications').push({
      uid:uid,
      userName:userName,
      title:'Wallet Update: Approved',
      message:'Deposit of ₹'+amt+' approved for '+userName,
      type:'deposit_approved',
      amount:amt,
      createdAt:Date.now(),
      adminUid:auth.currentUser.uid
    });
    
    console.log('Add Money approved — ₹'+amt+' for UID: '+uid);
    showToast('✅ Payment approved — ₹'+amt+' added to '+userName);
  }catch(e){
    console.error('approveAddMoney error:',e);
    showToast('Error: '+e.message,true);
  }
}
function openWithdrawalModal(rid){var w=allWalletRequests[rid];if(!w)return;pendingWithdrawData={requestId:rid};withdrawProofBase64=null;document.getElementById('withdrawProofPreview').style.display='none';document.getElementById('confirmWithdrawBtn').disabled=true;document.getElementById('withdrawAdminMsg').value='';var uid=getUid(w)||'N/A',upi=w.upiId||w.upi||'N/A',amt=w.amount||0,un=w.userName||w.displayName||getUserName(uid);document.getElementById('withdrawUserName').textContent=un;document.getElementById('withdrawUserUid').textContent=uid;document.getElementById('withdrawUpiId').textContent=upi;document.getElementById('withdrawAmount').textContent='₹'+amt;document.getElementById('withdrawPayLink').href='upi://pay?pa='+encodeURIComponent(upi)+'&pn='+encodeURIComponent(un)+'&am='+amt+'&cu=INR';document.getElementById('withdrawalModal').classList.add('show');}
function previewWithdrawProof(inp){if(!inp.files[0])return;var rd=new FileReader();rd.onload=function(e){var img=new Image();img.onload=function(){var cv=document.createElement('canvas');var w=img.width,h=img.height;if(w>800){h=(800/w)*h;w=800;}cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);var q=0.8,d=cv.toDataURL('image/jpeg',q);while(d.length>500*1024&&q>0.1){q-=0.1;d=cv.toDataURL('image/jpeg',q);}withdrawProofBase64=d;document.getElementById('withdrawProofPreview').src=d;document.getElementById('withdrawProofPreview').style.display='block';document.getElementById('confirmWithdrawBtn').disabled=false;};img.src=e.target.result;};rd.readAsDataURL(inp.files[0]);}
async function confirmWithdrawal(){
  if(!pendingWithdrawData||!withdrawProofBase64)return showToast('Upload proof',true);
  var btn=document.getElementById('confirmWithdrawBtn');
  setLoading(btn,true);
  var rid=pendingWithdrawData.requestId,w=allWalletRequests[rid],uid=getUid(w);
  if(!uid){setLoading(btn,false);return showToast('UID missing',true);}
  var amt=Number(w.amount)||0,msg=document.getElementById('withdrawAdminMsg').value;
  var userName=w.userName||w.displayName||getUserName(uid)||'User';
  var upiId=w.upiId||w.upi||'N/A';
  var txnId='TXN'+Date.now();
  
  try{
    /* STEP 1: Update wallet request status FIRST */
    await rtdb.ref(DB_WALLET+'/'+rid).update({
      status:'approved',
      proofImage:withdrawProofBase64,
      adminMessage:msg,
      transactionId:txnId,
      processedAt:Date.now(),
      processedBy:auth.currentUser.uid
    });
    
    /* STEP 2: Deduct from user balances */
    await rtdb.ref(DB_USERS+'/'+uid+'/realMoney/winnings').transaction(function(v){return Math.max((v||0)-amt,0)});
    await rtdb.ref(DB_USERS+'/'+uid+'/wallet/winningBalance').transaction(function(v){return Math.max((v||0)-amt,0)});
    
    /* STEP 3: Add transaction record */
    await rtdb.ref(DB_USERS+'/'+uid+'/transactions').push({
      type:'withdrawal',
      amount:-amt,
      description:'Withdrawal processed - TXN: '+txnId,
      timestamp:Date.now()
    });
    
    /* STEP 4: Send notification to user — CRITICAL: User must know their withdrawal was processed */
    await rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({
      title:'💸 Withdrawal Approved!',
      message:'₹'+amt+' has been sent to your UPI: '+upiId+'. '+(msg?'Note: '+msg:''),
      amount:amt,
      transactionId:txnId,
      proofImage:withdrawProofBase64,
      type:'withdrawal_approved',
      timestamp:Date.now(),
      read:false
    });
    
    /* Also create entry in global notifications node for tracking */
    await rtdb.ref('notifications').push({
      uid:uid,
      userName:userName,
      title:'Wallet Update: Withdrawal Approved',
      message:'Withdrawal of ₹'+amt+' processed for '+userName+' to UPI: '+upiId,
      type:'withdrawal_approved',
      amount:amt,
      transactionId:txnId,
      createdAt:Date.now(),
      adminUid:auth.currentUser.uid
    });
    
    console.log('Withdrawal approved — ₹'+amt+' for UID: '+uid+' to UPI: '+upiId);
    setLoading(btn,false);
    closeModal('withdrawalModal');
    showToast('✅ ₹'+amt+' withdrawal processed for '+userName);
  }catch(e){
    console.error('confirmWithdrawal error:',e);
    setLoading(btn,false);
    showToast('Error: '+e.message,true);
  }
}

/* =============================================
   REJECT MODAL
   ============================================= */
function openRejectModal(tp,rid){pendingRejectData={type:tp,requestId:rid};document.getElementById('rejectReason').value='';document.getElementById('rejectModal').classList.add('show');}
async function submitReject(){
  if(!pendingRejectData)return;var rsn=document.getElementById('rejectReason').value.trim();if(!rsn)return showToast('Reason required',true);
  /* Disable reject button to prevent double clicks */
  var rejectBtns=document.querySelectorAll('#rejectModal .btn-danger');
  rejectBtns.forEach(function(b){b.disabled=true;b.style.opacity='0.5';});
  var type=pendingRejectData.type,requestId=pendingRejectData.requestId;
  try{
    if(type==='profile'){var s=await rtdb.ref(DB_PROFILE+'/'+requestId).once('value');var r=s.val(),uid=r?getUid(r):null;await rtdb.ref(DB_PROFILE+'/'+requestId).update({status:'rejected',rejectionReason:rsn,processedAt:Date.now(),processedBy:auth.currentUser.uid});if(uid)await rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({title:'Profile Rejected ❌',message:'Reason: '+rsn,timestamp:Date.now(),read:false});}
    else if(type==='profileUpdate'){var s2=await rtdb.ref(DB_PROFILE_UPDATE+'/'+requestId).once('value');var r2=s2.val(),uid2=r2?getUid(r2):null;await rtdb.ref(DB_PROFILE_UPDATE+'/'+requestId).update({status:'rejected',rejectionReason:rsn,processedAt:Date.now()});if(uid2){await rtdb.ref(DB_USERS+'/'+uid2).update({profileUpdatePending:false});await rtdb.ref(DB_USERS+'/'+uid2+'/notifications').push({title:'Update Rejected ❌',message:'Reason: '+rsn,timestamp:Date.now(),read:false});}}
    else if(type==='wallet'){
      var w=allWalletRequests[requestId],uid3=w?getUid(w):null,wt=normalizeWalletType(w?w.type:null);
      var amt=Number(w?w.amount:0)||0;
      var userName=w?(w.userName||w.displayName||getUserName(uid3)||'User'):'User';
      
      /* Update wallet request status */
      await rtdb.ref(DB_WALLET+'/'+requestId).update({status:'rejected',rejectionReason:rsn,processedAt:Date.now(),processedBy:auth.currentUser.uid});
      
      /* If withdrawal rejected, refund the amount back to user */
      if(wt==='withdraw'&&uid3){
        await rtdb.ref(DB_USERS+'/'+uid3+'/realMoney/winnings').transaction(function(v){return(v||0)+amt});
        await rtdb.ref(DB_USERS+'/'+uid3+'/wallet/winningBalance').transaction(function(v){return(v||0)+amt});
        await rtdb.ref(DB_USERS+'/'+uid3+'/transactions').push({type:'refund',amount:amt,description:'Withdrawal rejected: '+rsn,timestamp:Date.now()});
      }
      
      /* Send notification to user — CRITICAL: User must know their request was rejected */
      if(uid3){
        var notifTitle=wt==='withdraw'?'❌ Withdrawal Rejected':'❌ Deposit Rejected';
        var notifMsg=wt==='withdraw'?
          'Your withdrawal request of ₹'+amt+' was rejected. Amount refunded. Reason: '+rsn:
          'Your deposit request of ₹'+amt+' was rejected. Reason: '+rsn;
        
        await rtdb.ref(DB_USERS+'/'+uid3+'/notifications').push({
          title:notifTitle,
          message:notifMsg,
          amount:amt,
          reason:rsn,
          type:'wallet_rejected',
          timestamp:Date.now(),
          read:false
        });
        
        /* Also log to global notifications for tracking */
        await rtdb.ref('notifications').push({
          uid:uid3,
          userName:userName,
          title:'Wallet Update: Rejected',
          message:(wt==='withdraw'?'Withdrawal':'Deposit')+' of ₹'+amt+' rejected for '+userName+'. Reason: '+rsn,
          type:'wallet_rejected',
          amount:amt,
          reason:rsn,
          createdAt:Date.now(),
          adminUid:auth.currentUser.uid
        });
        
        console.log('Wallet request rejected — ₹'+amt+' for UID: '+uid3+', Reason: '+rsn);
      }
    }
    else if(type==='team'){var s3=await rtdb.ref(DB_TEAM+'/'+requestId).once('value');var r3=s3.val();await rtdb.ref(DB_TEAM+'/'+requestId).update({status:'rejected',rejectionReason:rsn,processedAt:Date.now()});var uid4=r3?r3.ownerUid||r3.uid:null;if(uid4)await rtdb.ref(DB_USERS+'/'+uid4+'/notifications').push({title:'Team Rejected ❌',message:'Reason: '+rsn,timestamp:Date.now(),read:false});}
    closeModal('rejectModal');showToast('Rejected');
  }catch(e){showToast('Error: '+e.message,true);}
}

/* =============================================
   TEAMS
   ============================================= */
async function loadTeamRequests(){
  try{var snap=await rtdb.ref(DB_TEAM).once('value');var tb=document.getElementById('teamRequestsTable');tb.innerHTML='';var c=0;
  snap.forEach(function(ch){var d=ch.val(),id=ch.key,ip=d.status==='pending';if(ip)c++;var sb=d.status==='approved'?'green':d.status==='rejected'?'red':'yellow';
  var acts=ip?'<button class="btn btn-primary btn-xs" onclick="approveTeam(\''+id+'\')"><i class="fas fa-check"></i></button> <button class="btn btn-danger btn-xs" onclick="openRejectModal(\'team\',\''+id+'\')"><i class="fas fa-times"></i></button>':'';
  var ownerUid=d.ownerUid||d.uid||'';var memberUid=d.memberUid||'';
  tb.innerHTML+='<tr><td>'+idTag(d.ownerName||'Owner',ownerUid)+'<div class="text-xxs text-muted font-mono mt-1">[IGN: '+(usersCache[ownerUid]?usersCache[ownerUid].ign||'N/A':'N/A')+']</div></td><td><span class="badge blue">'+(d.teamType||d.type||'N/A')+'</span></td><td>'+idTag(d.memberName||'Member',memberUid)+'<div class="text-xxs text-muted font-mono mt-1">[IGN: '+(usersCache[memberUid]?usersCache[memberUid].ign||'N/A':'N/A')+']</div></td><td><span class="badge '+sb+'">'+d.status+'</span></td><td>'+acts+'</td></tr>';});
  document.getElementById('teamCount').textContent=c;}catch(e){console.error(e);}
}
async function approveTeam(rid){
  try{
    var s=await rtdb.ref(DB_TEAM+'/'+rid).once('value');
    if(!s.exists())return showToast('Team request not found',true);
    var r=s.val();
    var ou=r.ownerUid||r.uid;
    var mu=r.memberUid;
    var tt=(r.teamType||r.type||'duo').toLowerCase();
    var fld=tt==='squad'?'squadTeam':'duoTeam';
    
    if(!ou||!mu)return showToast('Owner or Member UID missing',true);
    
    console.log('═══════════════════════════════');
    console.log('APPROVE TEAM: '+tt.toUpperCase());
    console.log('Owner: '+(r.ownerName||ou));
    console.log('Member: '+(r.memberName||mu));
    console.log('═══════════════════════════════');
    
    /* ===== TWO-WAY PARTNER SYNC ===== */
    
    /* Step 1: Add member to owner's team array */
    var os=await rtdb.ref(DB_USERS+'/'+ou+'/'+fld).once('value');
    var ot=os.val()||[];
    if(ot.indexOf(mu)<0)ot.push(mu);
    await rtdb.ref(DB_USERS+'/'+ou+'/'+fld).set(ot);
    console.log('Step 1: Added '+mu+' to '+ou+'/'+fld);
    
    /* Step 2: Add owner to member's team array (TWO-WAY) */
    var ms2=await rtdb.ref(DB_USERS+'/'+mu+'/'+fld).once('value');
    var mt2=ms2.val()||[];
    if(mt2.indexOf(ou)<0)mt2.push(ou);
    await rtdb.ref(DB_USERS+'/'+mu+'/'+fld).set(mt2);
    console.log('Step 2: Added '+ou+' to '+mu+'/'+fld);
    
    /* Step 3: Set partnerUid for BOTH users (TWO-WAY SYNC) */
    if(tt==='duo'){
      await rtdb.ref(DB_USERS+'/'+ou+'/partnerUid').set(mu);
      await rtdb.ref(DB_USERS+'/'+mu+'/partnerUid').set(ou);
      console.log('Step 3: partnerUid sync: '+ou+' ↔ '+mu);
    }
    
    /* Step 4: Notify BOTH users */
    await rtdb.ref(DB_USERS+'/'+ou+'/notifications').push({
      title:'Team Approved! ✅',
      message:tt.charAt(0).toUpperCase()+tt.slice(1)+' team approved with '+(r.memberName||'member')+'.',
      timestamp:Date.now(),
      read:false
    });
    await rtdb.ref(DB_USERS+'/'+mu+'/notifications').push({
      title:'Team Joined! ✅',
      message:'Added to '+tt+' team with '+(r.ownerName||'owner')+'.',
      timestamp:Date.now(),
      read:false
    });
    console.log('Step 4: Notifications sent to both users');
    
    /* Step 5: Update request status */
    await rtdb.ref(DB_TEAM+'/'+rid).update({status:'approved',processedAt:Date.now(),processedBy:auth.currentUser.uid});
    
    console.log('✅ Team approved with complete two-way sync!');
    showToast('✅ Team approved! Partner sync: '+ou.substring(0,8)+' ↔ '+mu.substring(0,8));
    loadTeamRequests();
  }catch(e){
    console.error('approveTeam error:',e);
    showToast('Error: '+e.message,true);
  }
}

/* ===== SET PARTNER FUNCTION (TWO-WAY SYNC) ===== */
/* When admin sets partner for a user, automatically set the reverse relationship */
async function setUserPartner(userA, userB){
  if(!userA||!userB){
    console.error('setUserPartner: Both UIDs required');
    return false;
  }
  
  try{
    /* Two-way sync: A → B and B → A */
    await rtdb.ref(DB_USERS+'/'+userA+'/partnerUid').set(userB);
    await rtdb.ref(DB_USERS+'/'+userB+'/partnerUid').set(userA);
    
    /* Also add to duoTeam arrays */
    var aTeam=await rtdb.ref(DB_USERS+'/'+userA+'/duoTeam').once('value');
    var aArr=aTeam.val()||[];
    if(aArr.indexOf(userB)<0){
      aArr.push(userB);
      await rtdb.ref(DB_USERS+'/'+userA+'/duoTeam').set(aArr);
    }
    
    var bTeam=await rtdb.ref(DB_USERS+'/'+userB+'/duoTeam').once('value');
    var bArr=bTeam.val()||[];
    if(bArr.indexOf(userA)<0){
      bArr.push(userA);
      await rtdb.ref(DB_USERS+'/'+userB+'/duoTeam').set(bArr);
    }
    
    console.log('✅ Two-way partner set: '+userA+' ↔ '+userB);
    return true;
  }catch(e){
    console.error('setUserPartner error:',e);
    return false;
  }
}

/* Remove partner relationship (two-way) */
async function removeUserPartner(userA, userB){
  if(!userA||!userB){
    console.error('removeUserPartner: Both UIDs required');
    return false;
  }
  
  try{
    /* Remove partnerUid from both */
    await rtdb.ref(DB_USERS+'/'+userA+'/partnerUid').remove();
    await rtdb.ref(DB_USERS+'/'+userB+'/partnerUid').remove();
    
    /* Remove from duoTeam arrays */
    var aTeam=await rtdb.ref(DB_USERS+'/'+userA+'/duoTeam').once('value');
    var aArr=aTeam.val()||[];
    var aIdx=aArr.indexOf(userB);
    if(aIdx>=0){
      aArr.splice(aIdx,1);
      await rtdb.ref(DB_USERS+'/'+userA+'/duoTeam').set(aArr);
    }
    
    var bTeam=await rtdb.ref(DB_USERS+'/'+userB+'/duoTeam').once('value');
    var bArr=bTeam.val()||[];
    var bIdx=bArr.indexOf(userA);
    if(bIdx>=0){
      bArr.splice(bIdx,1);
      await rtdb.ref(DB_USERS+'/'+userB+'/duoTeam').set(bArr);
    }
    
    console.log('✅ Partner removed: '+userA+' ✕ '+userB);
    return true;
  }catch(e){
    console.error('removeUserPartner error:',e);
    return false;
  }
}

/* =============================================
   SUPPORT CHAT — uses senderId:'admin' (not sender:'admin')
   Reads from supportChats/{uid}/ OR support/{uid}/ (checks both paths)
   Admin checks BOTH senderId and sender for backward compat
   ============================================= */
var allChatUsers={};
function isAdminMsg(mv){return mv.senderId==='admin'||mv.sender==='admin';}

/* Try to detect which chat path is being used */
var CHAT_PATH_PRIMARY='support';        /* Primary path — synced with User Panel */
var CHAT_PATH_SECONDARY='chats';        /* Secondary/fallback path */

/* loadSupportChats — Listens to supportChats/{userId} AND support/{userId} paths
   Each user has their own chat node: supportChats/uid123/messageId OR support/uid123/messageId
   Messages have senderId:'admin' or senderId:userId
   
   This function checks BOTH paths for compatibility with different User Panel versions
*/
async function loadSupportChats(){
  console.log('Setting up chat listeners on: '+CHAT_PATH_PRIMARY+'/ and '+CHAT_PATH_SECONDARY+'/');
  
  /* Helper function to process chat snapshot */
  function processChatSnapshot(snap, pathName){
    console.log('Chat snapshot from '+pathName+'/, exists:',snap.exists());
    if(!snap.exists())return;
    
    snap.forEach(function(us){
      var uid=us.key;var lm='',ur=0,lt=0,un='';
      /* FIX: support path uses /messages sub-node; chats path is flat */
      var msgNode = us.child('messages');
      var infoNode = us.child('info');
      /* Read user info from /info node */
      if(infoNode.exists()){var info=infoNode.val();un=info.userIGN||info.userName||info.displayName||'';}
      /* Read messages from /messages sub-node (support path) or directly (chats path) */
      var msgSnap = (pathName==='support' && msgNode.exists()) ? msgNode : us;
      msgSnap.forEach(function(ms){
        var m=ms.val();
        if(typeof m !== 'object' || !m) return; /* skip non-message nodes like info */
        if(!m.text && !m.message) return;
        lm=m.message||m.text||'';
        var mt=m.createdAt||m.timestamp||0;
        if(mt>lt)lt=mt;
        if(!isAdminMsg(m)&&!m.read)ur++;
        if(!un&&!isAdminMsg(m)&&(m.senderName||m.userName))un=m.senderName||m.userName;
      });
      if(!un)un=getUserName(uid);
      
      if(!allChatUsers[uid]||allChatUsers[uid].lastTime<lt){
        allChatUsers[uid]={userName:un,lastMsg:lm,unread:ur,lastTime:lt,chatPath:pathName};
      }else if(allChatUsers[uid]){
        allChatUsers[uid].unread+=ur;
      }
    });
  }
  
  /* Helper function to render chat user list */
  function renderChatList(){
    var ls=document.getElementById('chatUserList');ls.innerHTML='';
    var users=Object.keys(allChatUsers).map(function(uid){
      return {uid:uid,...allChatUsers[uid]};
    });
    
    if(users.length===0){
      ls.innerHTML='<div class="chat-empty" style="padding:30px 0"><i class="fas fa-comments"></i><span class="text-xs">No conversations</span></div>';
      return;
    }
    
    users.sort(function(a,b){return b.lastTime-a.lastTime});
    users.forEach(function(u){
      var ini=(u.userName||u.uid).charAt(0).toUpperCase(),ts=u.lastTime?formatChatTime(u.lastTime):'';
      ls.innerHTML+='<div class="chat-user-item '+(activeChatUid===u.uid?'active':'')+'" onclick="openChat(\''+u.uid+'\')"><div class="chat-avatar">'+ini+'</div><div class="chat-user-info"><div class="chat-user-name"><span>'+(u.userName||u.uid.substring(0,12))+'</span><span class="chat-time">'+ts+'</span></div><div class="chat-user-preview">'+u.lastMsg+'</div></div>'+(u.unread>0?'<div class="chat-unread-dot">'+u.unread+'</div>':'')+'</div>';
    });
  }
  
  /* Listen to PRIMARY path: supportChats/ */
  rtdb.ref(CHAT_PATH_PRIMARY).on('value',function(snap){
    allChatUsers={};  /* Reset on each update */
    processChatSnapshot(snap, CHAT_PATH_PRIMARY);
    
    /* Also check SECONDARY path: support/ */
    rtdb.ref(CHAT_PATH_SECONDARY).once('value',function(snap2){
      processChatSnapshot(snap2, CHAT_PATH_SECONDARY);
      renderChatList();
    });
  });
  
  /* Also listen to SECONDARY path: support/ for real-time updates */
  rtdb.ref(CHAT_PATH_SECONDARY).on('value',function(snap){
    console.log('Secondary chat path ('+CHAT_PATH_SECONDARY+'/) updated');
    /* Refresh the primary listener which will merge both */
    rtdb.ref(CHAT_PATH_PRIMARY).once('value',function(snap2){
      allChatUsers={};
      processChatSnapshot(snap2, CHAT_PATH_PRIMARY);
      processChatSnapshot(snap, CHAT_PATH_SECONDARY);
      renderChatList();
    });
  });
}
function formatChatTime(ts){var d=new Date(ts),n=new Date();if(d.toDateString()===n.toDateString())return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});return d.toLocaleDateString([],{month:'short',day:'numeric'});}
function filterChatUsers(q){q=q.toLowerCase();document.querySelectorAll('.chat-user-item').forEach(function(el){var nm=el.querySelector('.chat-user-name span');var t=nm?nm.textContent.toLowerCase():'';el.style.display=t.indexOf(q)>=0?'':'none';});}

function openChat(uid){
  activeChatUid=uid;
  var cd=allChatUsers[uid]||{};
  var un=cd.userName||getUserName(uid);
  /* Determine which chat path this user's messages are stored in */
  var userChatPath=cd.chatPath||CHAT_PATH_PRIMARY;
  console.log('Opening chat for '+uid+' using path: '+userChatPath+'/');
  
  var ma=document.getElementById('chatMainArea');
  ma.innerHTML='<div class="chat-main-header"><div class="chat-avatar" style="width:30px;height:30px;font-size:12px">'+(un||uid).charAt(0).toUpperCase()+'</div><div class="chat-header-info"><div class="chat-header-name">'+un+'</div><div class="chat-header-uid">'+uid+'</div></div><button class="btn btn-ghost btn-xs" onclick="openUserModal(\''+uid+'\')"><i class="fas fa-user"></i> Profile</button></div><div class="chat-messages" id="chatMessages"></div><div class="chat-input-bar"><input type="text" id="chatInput" class="form-input" placeholder="Type reply..." style="padding:8px 12px" onkeydown="if(event.key===\'Enter\')sendAdminReply()"><button class="btn btn-primary" onclick="sendAdminReply()" style="padding:8px 14px"><i class="fas fa-paper-plane"></i></button></div>';
  document.querySelectorAll('.chat-user-item').forEach(function(el){el.classList.remove('active')});
  
  /* Mark unread as read — check both paths */
  function markAsRead(path){
    rtdb.ref(path+'/'+uid).once('value').then(function(s){
      s.forEach(function(m){
        if(!isAdminMsg(m.val())&&!m.val().read){
          rtdb.ref(path+'/'+uid+'/'+m.key).update({read:true});
        }
      });
    });
  }
  markAsRead(CHAT_PATH_PRIMARY);
  markAsRead(CHAT_PATH_SECONDARY);
  
  if(chatListener)chatListener();
  
  /* Listen to BOTH paths and merge messages */
  function renderMessages(){
    var me=document.getElementById('chatMessages');if(!me)return;
    var allMessages=[];
    
    function fetchAndRender(){
      /* FIX: Read from support/{uid}/messages — same path user writes to */
      Promise.all([
        rtdb.ref('support/'+uid+'/messages').orderByChild('createdAt').once('value'),
        rtdb.ref(CHAT_PATH_SECONDARY+'/'+uid).once('value')
      ]).then(function(results){
        allMessages=[];
        /* Primary: support/{uid}/messages */
        if(results[0].exists()){
          results[0].forEach(function(ms){
            allMessages.push({key:ms.key,...ms.val()});
          });
        }
        /* Secondary: chats/{uid} — fallback for old messages */
        if(results[1].exists()){
          results[1].forEach(function(ms){
            var m={key:ms.key,...ms.val()};
            if(!allMessages.find(function(x){return x.text===m.text&&Math.abs((x.createdAt||x.timestamp||0)-(m.createdAt||m.timestamp||0))<2000})){
              allMessages.push(m);
            }
          });
        }
        
        if(allMessages.length===0){
          me.innerHTML='<div class="chat-empty"><i class="fas fa-comment-dots"></i><span class="text-xs">No messages</span></div>';
          return;
        }
        
        /* Sort by timestamp */
        allMessages.sort(function(a,b){return (a.timestamp||0)-(b.timestamp||0)});
        
        me.innerHTML='';
        var ld='';
        allMessages.forEach(function(m){
          var ia=isAdminMsg(m),ts=m.timestamp?new Date(m.timestamp):null,ds=ts?ts.toLocaleDateString():'';
          if(ds&&ds!==ld){ld=ds;me.innerHTML+='<div style="text-align:center;padding:6px;font-size:9px;color:var(--text-muted)">'+ds+'</div>';}
          var tm=ts?ts.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';
          me.innerHTML+='<div class="chat-bubble '+(ia?'admin':'user')+'">'+(m.message||m.text||'')+'<div class="time">'+tm+(ia?' <i class="fas fa-check-double" style="color:var(--primary)"></i>':'')+'</div></div>';
        });
        me.scrollTop=me.scrollHeight;
      });
    }
    
    fetchAndRender();
  }
  
  /* FIX: Listen to support/{uid}/messages — correct path */
  var ref=rtdb.ref('support/'+uid+'/messages');
  chatListener=ref.on('value',function(){
    renderMessages();
  });
}

/* sendAdminReply — saves with senderId:'admin'
   Saves to the same path where the user's chat exists
*/
async function sendAdminReply(){
  if(!activeChatUid)return showToast('Select user',true);
  var inp=document.getElementById('chatInput'),msg=inp.value.trim();if(!msg)return;
  
  /* Determine which path to use for this user */
  var cd=allChatUsers[activeChatUid]||{};
  var chatPath=cd.chatPath||CHAT_PATH_PRIMARY;
  
  console.log('Sending reply to '+chatPath+'/'+activeChatUid);
  
  try{
    /* FIX: Save to support/{uid}/messages — EXACTLY where user reads from */
    var msgData = {
      message: msg,
      text: msg,
      senderId: 'admin',
      senderRole: 'admin',
      sender: 'admin',
      timestamp: Date.now(),
      createdAt: Date.now(),
      read: true,
      adminUid: auth.currentUser.uid
    };
    /* Primary: support/{uid}/messages — user reads this path */
    await rtdb.ref('support/'+activeChatUid+'/messages').push(msgData);
    /* Update support/{uid}/info for admin list */
    await rtdb.ref('support/'+activeChatUid+'/info').update({
      lastMessage: msg,
      lastMessageTime: Date.now(),
      lastReplyByAdmin: Date.now(),
      unreadByAdmin: false
    });
    
    /* Send notification to user */
    await rtdb.ref(DB_USERS+'/'+activeChatUid+'/notifications').push({
      title:'💬 Support Reply',
      message:msg,
      timestamp:Date.now(),
      read:false,
      type:'support_reply'
    });
    
    inp.value='';
    console.log('Chat reply sent to '+chatPath+'/'+activeChatUid+' with senderId:admin');
  }catch(e){
    console.error('sendAdminReply error:',e);
    showToast('Error: '+e.message,true);
  }
}

/* =============================================
   NOTIFICATIONS
   ============================================= */
async function sendGlobalNotification(){
  var t=document.getElementById('globalNotifTitle').value.trim(),m=document.getElementById('globalNotifMsg').value.trim();
  if(!t||!m)return showToast('Title & message required',true);
  var btn=document.getElementById('sendGlobalBtn');
  setLoading(btn,true);
  try{
    var s=await rtdb.ref(DB_USERS).once('value');var p=[];
    s.forEach(function(c){p.push(rtdb.ref(DB_USERS+'/'+c.key+'/notifications').push({title:t,message:m,timestamp:Date.now(),read:false,type:'global'}));});
    await Promise.all(p);
    document.getElementById('globalNotifTitle').value='';document.getElementById('globalNotifMsg').value='';
    setLoading(btn,false);
    showToast('✅ Sent to '+s.numChildren()+' users');
  }catch(e){setLoading(btn,false);showToast('Error: '+e.message,true);}
}

/* Custom Notification to Specific User */
async function lookupCustomNotifUser(){
  var uid=document.getElementById('customNotifUid').value.trim();
  if(!uid)return showToast('Enter UID',true);
  try{
    var s=await rtdb.ref(DB_USERS+'/'+uid).once('value');
    if(!s.exists())return showToast('User not found!',true);
    var u=s.val();
    document.getElementById('customNotifUserName').textContent=u.ign||'Unknown';
    document.getElementById('customNotifUserStatus').textContent=u.isBanned?'Banned':'Active';
    document.getElementById('customNotifUserStatus').className='badge '+(u.isBanned?'red':'green');
    document.getElementById('customNotifUserInfo').style.display='block';
    showToast('User found: '+(u.ign||'Unknown'));
  }catch(e){showToast('Error: '+e.message,true);}
}

async function sendCustomNotification(){
  var uid=document.getElementById('customNotifUid').value.trim();
  var title=document.getElementById('customNotifTitle').value.trim();
  var msg=document.getElementById('customNotifMsg').value.trim();
  if(!uid)return showToast('Enter User UID',true);
  if(!title)return showToast('Enter Title',true);
  if(!msg)return showToast('Enter Message',true);
  var btn=document.getElementById('sendCustomNotifBtn');
  setLoading(btn,true);
  try{
    var us=await rtdb.ref(DB_USERS+'/'+uid).once('value');
    if(!us.exists()){setLoading(btn,false);return showToast('User not found!',true);}
    await rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({
      title:title,
      message:msg,
      timestamp:Date.now(),
      read:false,
      type:'custom_admin',
      sentBy:auth.currentUser.uid
    });
    /* Also log to global notifications */
    await rtdb.ref('notifications').push({
      uid:uid,
      userName:us.val().ign||'Unknown',
      title:'Custom: '+title,
      message:msg,
      type:'custom_admin',
      createdAt:Date.now(),
      adminUid:auth.currentUser.uid
    });
    document.getElementById('customNotifTitle').value='';
    document.getElementById('customNotifMsg').value='';
    setLoading(btn,false);
    showToast('✅ Notification sent to '+(us.val().ign||uid));
  }catch(e){setLoading(btn,false);showToast('Error: '+e.message,true);}
}
async function sendMatchNotification(){
  var mid=document.getElementById('notifTournamentSelect').value,t=document.getElementById('matchNotifTitle').value.trim(),m=document.getElementById('matchNotifMsg').value.trim();
  if(!mid||!t||!m)return showToast('All fields required',true);
  var btn=document.getElementById('sendMatchBtn');
  setLoading(btn,true);
  try{
    var s=await rtdb.ref(DB_JOIN).once('value');var p=[];var c=0;
    s.forEach(function(x){var j=x.val(),tid=j.tournamentId||j.matchId;if(tid===mid&&j.status==='approved'){var uid=getUid(j);if(uid){c++;p.push(rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({title:t,message:m,timestamp:Date.now(),read:false,type:'match'}));}}});
    await Promise.all(p);
    document.getElementById('matchNotifTitle').value='';document.getElementById('matchNotifMsg').value='';
    setLoading(btn,false);
    showToast('✅ Sent to '+c+' players');
  }catch(e){setLoading(btn,false);showToast('Error: '+e.message,true);}
}
async function sendScheduledReminders(){try{var s=await rtdb.ref(DB_MATCHES).once('value');s.forEach(function(c){var t=c.val();if(t.status==='upcoming'&&!t.reminderSent&&t.matchTime){var diff=t.matchTime-Date.now();if(diff>0&&diff<=30*60*1000){rtdb.ref(DB_JOIN).once('value').then(function(js){js.forEach(function(jc){var j=jc.val(),tid=j.tournamentId||j.matchId;if(tid===c.key&&j.status==='approved'){var uid=getUid(j);if(uid)rtdb.ref(DB_USERS+'/'+uid+'/notifications').push({title:'⏰ Starting Soon!',message:t.name+' in 30 min!',timestamp:Date.now(),read:false});}});});rtdb.ref(DB_MATCHES+'/'+c.key).update({reminderSent:true});}}});}catch(e){}}

/* =============================================
   SETTINGS
   ============================================= */
async function loadSettings(){try{var arr=await Promise.all([rtdb.ref('appSettings/payment').once('value'),rtdb.ref('appConfig').once('value'),rtdb.ref('appSettings/globalMessage').once('value'),rtdb.ref('appSettings/spectateLink').once('value')]);var py=arr[0].val()||{},cf=arr[1].val()||{};document.getElementById('settUpiId').value=py.upiId||'';document.getElementById('settMinWithdraw').value=py.minWithdraw||'';document.getElementById('settCoinsPerAd').value=cf.coinsPerAd||'';document.getElementById('settReferralReward').value=cf.referralReward||'';document.getElementById('settGlobalMsg').value=arr[2].val()||'';document.getElementById('settSpectateLink').value=arr[3].val()||'';}catch(e){console.error(e);}}
function loadMaintenanceState(){rtdb.ref('appSettings/maintenanceMode').on('value',function(s){var on=s.val()===true;document.getElementById('maintToggle').checked=on;var b=document.getElementById('maintBanner');if(on)b.classList.add('show');else b.classList.remove('show');});}
async function saveSettings(){try{await rtdb.ref('appSettings/payment').update({upiId:document.getElementById('settUpiId').value.trim(),minWithdraw:Number(document.getElementById('settMinWithdraw').value)||50});showToast('Saved!');}catch(e){showToast('Error: '+e.message,true);}}
async function saveGameSettings(){try{await rtdb.ref('appConfig').update({coinsPerAd:Number(document.getElementById('settCoinsPerAd').value)||5,referralReward:Number(document.getElementById('settReferralReward').value)||10});showToast('Saved!');}catch(e){showToast('Error: '+e.message,true);}}
async function toggleMaintenance(){var on=document.getElementById('maintToggle').checked;try{await rtdb.ref('appSettings/maintenanceMode').set(on);showToast('Maintenance '+(on?'ON':'OFF'));}catch(e){showToast('Error: '+e.message,true);}}
async function saveGlobalMessage(){try{await rtdb.ref('appSettings/globalMessage').set(document.getElementById('settGlobalMsg').value.trim());showToast('Saved!');}catch(e){showToast('Error: '+e.message,true);}}
async function clearGlobalMessage(){try{await rtdb.ref('appSettings/globalMessage').set(null);document.getElementById('settGlobalMsg').value='';showToast('Cleared!');}catch(e){showToast('Error: '+e.message,true);}}
async function saveSpectateLink(){try{await rtdb.ref('appSettings/spectateLink').set(document.getElementById('settSpectateLink').value.trim());showToast('Saved!');}catch(e){showToast('Error: '+e.message,true);}}

/* =============================================
   VOUCHERS
   ============================================= */
async function loadVouchers(){try{var s=await rtdb.ref(DB_VOUCHERS).once('value');var t=document.getElementById('vouchersTable');t.innerHTML='';s.forEach(function(c){var v=c.val();t.innerHTML+='<tr><td class="font-bold text-primary">'+v.code+'</td><td>₹'+v.value+'</td><td>'+(v.usedCount||0)+'</td><td>'+v.maxUses+'</td><td><button class="btn btn-danger btn-xs" onclick="deleteVoucher(\''+c.key+'\')"><i class="fas fa-trash"></i></button></td></tr>';});}catch(e){}}
async function createVoucher(){var cd=document.getElementById('voucherCode').value.trim().toUpperCase(),vl=Number(document.getElementById('voucherValue').value)||0,mx=Number(document.getElementById('voucherMaxUses').value)||100;if(!cd||!vl)return showToast('Code & value required',true);try{await rtdb.ref(DB_VOUCHERS).push({code:cd,value:vl,maxUses:mx,usedCount:0,createdAt:Date.now()});document.getElementById('voucherCode').value='';document.getElementById('voucherValue').value='';document.getElementById('voucherMaxUses').value='';showToast('Created!');loadVouchers();}catch(e){showToast('Error: '+e.message,true);}}
async function deleteVoucher(id){if(!confirm('Delete?'))return;try{await rtdb.ref(DB_VOUCHERS+'/'+id).remove();showToast('Deleted');loadVouchers();}catch(e){showToast('Error: '+e.message,true);}}

/* =============================================
   UI NAVIGATION WITH BACK BUTTON SUPPORT
   ============================================= */
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show');}
var sIcons={dashboard:'fa-chart-line',profileVerification:'fa-user-check',profileUpdates:'fa-user-edit',users:'fa-users',tournaments:'fa-trophy',joinedPlayers:'fa-clipboard-check',results:'fa-bullseye',wallets:'fa-wallet',teams:'fa-user-friends',support:'fa-comments',notifications:'fa-bell',settings:'fa-cog',roster:'fa-shield-alt',analytics:'fa-chart-bar',lookup:'fa-search',activity:'fa-history'};
var sTitles={dashboard:'Dashboard',profileVerification:'New Verifications',profileUpdates:'Profile Updates',users:'Users',tournaments:'Matches',joinedPlayers:'Joined Players',results:'Match Results',wallets:'Wallet Requests',teams:'Team Requests',support:'Support Chat',notifications:'Notifications',settings:'Settings',roster:'Live Roster',analytics:'Analytics',lookup:'Player Lookup',activity:'Activity Log'};

/* Track current section for back button */
var currentSection='dashboard';
var navigationHistory=[];

function showSection(sec,el,skipHistory){
  /* Close any open modals first */
  document.querySelectorAll('.modal-overlay.show').forEach(function(m){m.classList.remove('show');});
  
  document.querySelectorAll('.section').forEach(function(s){s.classList.remove('active')});
  document.getElementById('section-'+sec).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(function(n){n.classList.remove('active')});
  if(el)el.classList.add('active');
  else{
    /* Find and activate the correct nav item if el not provided */
    var navItems=document.querySelectorAll('.nav-item');
    navItems.forEach(function(n){
      var onclick=n.getAttribute('onclick')||'';
      if(onclick.indexOf("'"+sec+"'")>=0)n.classList.add('active');
    });
  }
  document.getElementById('topbarTitle').innerHTML='<i class="fas '+(sIcons[sec]||'fa-circle')+'" style="color:var(--primary);margin-right:6px"></i>'+(sTitles[sec]||sec);
  document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('show');
  
  /* ===== BACK BUTTON HISTORY MANAGEMENT ===== */
  /* Only push to history if not triggered by popstate (back button) */
  if(!skipHistory){
    /* Push state to browser history for back button support */
    history.pushState({section:sec},'',window.location.pathname+'#'+sec);
    console.log('History pushed: #'+sec);
  }
  currentSection=sec;
  
  /* Section-specific data loading */
  if(sec==='dashboard'){refreshDashboard();if(window.initAdminDashboard)setTimeout(initAdminDashboard,500);}
  if(sec==='tournaments')loadTournaments();
  if(sec==='joinedPlayers')refreshJoinedPlayers();
  if(sec==='teams')loadTeamRequests();
  if(sec==='settings'){loadSettings();loadVouchers();}
}

/* ===== BACK BUTTON HANDLER ===== */
/* This prevents the app from closing when back button is pressed */
window.onpopstate=function(event){
  console.log('Back button pressed, event.state:',event.state);
  
  /* Close any open modals first */
  var openModals=document.querySelectorAll('.modal-overlay.show');
  if(openModals.length>0){
    openModals.forEach(function(m){m.classList.remove('show');});
    /* Push current state back to prevent further back navigation */
    history.pushState({section:currentSection},'',window.location.pathname+'#'+currentSection);
    console.log('Modal closed, state restored');
    return;
  }
  
  /* Navigate to the section from history state */
  if(event.state&&event.state.section){
    showSection(event.state.section,null,true); /* true = skip pushing to history again */
    console.log('Navigated back to: '+event.state.section);
  }else{
    /* Check URL hash for section */
    var hash=window.location.hash.replace('#','');
    if(hash&&sTitles[hash]){
      showSection(hash,null,true);
    }else{
      /* Default to dashboard if no valid state */
      showSection('dashboard',null,true);
    }
    console.log('Navigated to default/hash section');
  }
};

/* Initialize history state on page load */
function initHistoryState(){
  /* Check URL hash first */
  var hash=window.location.hash.replace('#','');
  if(hash&&sTitles[hash]){
    /* Navigate to hash section without pushing new history */
    showSection(hash,null,true);
    history.replaceState({section:hash},'',window.location.pathname+'#'+hash);
  }else{
    /* Set initial state for dashboard */
    history.replaceState({section:'dashboard'},'',window.location.pathname+'#dashboard');
  }
  console.log('History initialized');
}
function closeModal(id){
  document.getElementById(id).classList.remove('show');
  /* Restore history state after modal close to prevent back button issues */
  history.replaceState({section:currentSection},'',window.location.pathname+'#'+currentSection);
}
document.addEventListener('click',function(e){if(!e.target.closest('.global-search'))document.getElementById('globalSearchResults').classList.remove('show');});
</script>
<script src="js/admin-roster.js"></script>
<script src="js/admin-live-dash.js"></script>
<script src="js/admin-analytics.js"></script>
<script src="js/admin-scheduler.js"></script>
<script src="js/admin-player-lookup.js"></script>
<script src="js/admin-withdrawal-queue.js"></script>
<script src="js/admin-notif-templates.js"></script>
<script src="js/admin-chat-enhance.js"></script>
<script src="js/admin-voucher-plus.js"></script>
<script src="js/admin-activity-log.js"></script>
<script src="js/features-admin.js"></script>
<script src="js/features/fa01-auto-prize-distribute.js"></script>
<script src="js/features/fa02-smart-search.js"></script>
<script src="js/features/fa03-quick-match-creator.js"></script>
<script src="js/features/fa04-bulk-notification.js"></script>
<script src="js/features/fa05-platform-health.js"></script>
</body>
</html>
